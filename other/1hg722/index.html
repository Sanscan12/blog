<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ruoyi-plus 若依框架 | 柏竹</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="https://image.bozhu12.cc/myblog/Essay/favicon.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <meta name="description" content="学习足迹 , 记录生活!">
    <meta name="Sasncan12" content="柏竹博客, 个人技术博客, 前后端端 , 技术文档">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#bd93f9">
    
    <link rel="preload" href="/assets/css/0.styles.b41e82d5.css" as="style"><link rel="preload" href="/assets/js/app.ff8b54c0.js" as="script"><link rel="preload" href="/assets/js/2.b26d2d6f.js" as="script"><link rel="preload" href="/assets/js/115.d9d5c71e.js" as="script"><link rel="prefetch" href="/assets/js/10.6932ad71.js"><link rel="prefetch" href="/assets/js/100.1a1fdf07.js"><link rel="prefetch" href="/assets/js/101.314dcf65.js"><link rel="prefetch" href="/assets/js/102.d4c4dd26.js"><link rel="prefetch" href="/assets/js/103.ef7b0eb3.js"><link rel="prefetch" href="/assets/js/104.f707a4af.js"><link rel="prefetch" href="/assets/js/105.c3a4aa46.js"><link rel="prefetch" href="/assets/js/106.ec98067d.js"><link rel="prefetch" href="/assets/js/107.eb1b6083.js"><link rel="prefetch" href="/assets/js/108.fd9c37f3.js"><link rel="prefetch" href="/assets/js/109.a79f69d5.js"><link rel="prefetch" href="/assets/js/11.b2bdd9db.js"><link rel="prefetch" href="/assets/js/110.88eeca9d.js"><link rel="prefetch" href="/assets/js/111.bb163e50.js"><link rel="prefetch" href="/assets/js/112.a0f2d04d.js"><link rel="prefetch" href="/assets/js/113.29df4b45.js"><link rel="prefetch" href="/assets/js/114.68644a5f.js"><link rel="prefetch" href="/assets/js/116.03fb878a.js"><link rel="prefetch" href="/assets/js/117.580a365e.js"><link rel="prefetch" href="/assets/js/118.3cea22ba.js"><link rel="prefetch" href="/assets/js/119.cd83f40e.js"><link rel="prefetch" href="/assets/js/12.8d7bd029.js"><link rel="prefetch" href="/assets/js/120.c39f701e.js"><link rel="prefetch" href="/assets/js/121.f7b04644.js"><link rel="prefetch" href="/assets/js/122.98606fd9.js"><link rel="prefetch" href="/assets/js/123.78407cfd.js"><link rel="prefetch" href="/assets/js/124.3baaf738.js"><link rel="prefetch" href="/assets/js/125.b63ae826.js"><link rel="prefetch" href="/assets/js/126.72c5dd47.js"><link rel="prefetch" href="/assets/js/127.47b425a1.js"><link rel="prefetch" href="/assets/js/128.6befb483.js"><link rel="prefetch" href="/assets/js/129.c98c715a.js"><link rel="prefetch" href="/assets/js/13.698334a0.js"><link rel="prefetch" href="/assets/js/14.d29f7e81.js"><link rel="prefetch" href="/assets/js/15.c40d8915.js"><link rel="prefetch" href="/assets/js/16.64fea226.js"><link rel="prefetch" href="/assets/js/17.a09e38d7.js"><link rel="prefetch" href="/assets/js/18.b5a40b68.js"><link rel="prefetch" href="/assets/js/19.5d87d78a.js"><link rel="prefetch" href="/assets/js/20.6802ce4f.js"><link rel="prefetch" href="/assets/js/21.8bb371df.js"><link rel="prefetch" href="/assets/js/22.cd5b0f4c.js"><link rel="prefetch" href="/assets/js/23.7f8a5a33.js"><link rel="prefetch" href="/assets/js/24.9dafb74c.js"><link rel="prefetch" href="/assets/js/25.65e92ad2.js"><link rel="prefetch" href="/assets/js/26.6be7ec6d.js"><link rel="prefetch" href="/assets/js/27.45c9e057.js"><link rel="prefetch" href="/assets/js/28.8d873306.js"><link rel="prefetch" href="/assets/js/29.f5506360.js"><link rel="prefetch" href="/assets/js/3.00d27ac4.js"><link rel="prefetch" href="/assets/js/30.5fecd315.js"><link rel="prefetch" href="/assets/js/31.4e81dcd5.js"><link rel="prefetch" href="/assets/js/32.6ea862c0.js"><link rel="prefetch" href="/assets/js/33.7a2226f1.js"><link rel="prefetch" href="/assets/js/34.42421005.js"><link rel="prefetch" href="/assets/js/35.ee91ee76.js"><link rel="prefetch" href="/assets/js/36.47833f09.js"><link rel="prefetch" href="/assets/js/37.6d65f5e8.js"><link rel="prefetch" href="/assets/js/38.c948d014.js"><link rel="prefetch" href="/assets/js/39.07b53ec9.js"><link rel="prefetch" href="/assets/js/4.5017c5ca.js"><link rel="prefetch" href="/assets/js/40.61fb895c.js"><link rel="prefetch" href="/assets/js/41.11ef63c0.js"><link rel="prefetch" href="/assets/js/42.826fc880.js"><link rel="prefetch" href="/assets/js/43.e21776c9.js"><link rel="prefetch" href="/assets/js/44.255279ff.js"><link rel="prefetch" href="/assets/js/45.ef371806.js"><link rel="prefetch" href="/assets/js/46.072dbbc1.js"><link rel="prefetch" href="/assets/js/47.dec22c3a.js"><link rel="prefetch" href="/assets/js/48.60cc5e2d.js"><link rel="prefetch" href="/assets/js/49.98e8b139.js"><link rel="prefetch" href="/assets/js/5.9c242416.js"><link rel="prefetch" href="/assets/js/50.9b6aba9e.js"><link rel="prefetch" href="/assets/js/51.25ced686.js"><link rel="prefetch" href="/assets/js/52.312c0c25.js"><link rel="prefetch" href="/assets/js/53.b08c6bb3.js"><link rel="prefetch" href="/assets/js/54.1428e09b.js"><link rel="prefetch" href="/assets/js/55.ce24c351.js"><link rel="prefetch" href="/assets/js/56.52f80c93.js"><link rel="prefetch" href="/assets/js/57.63be6b1b.js"><link rel="prefetch" href="/assets/js/58.9f9a85d6.js"><link rel="prefetch" href="/assets/js/59.639e7f07.js"><link rel="prefetch" href="/assets/js/6.20f6982a.js"><link rel="prefetch" href="/assets/js/60.9c0b8a85.js"><link rel="prefetch" href="/assets/js/61.abeabf2b.js"><link rel="prefetch" href="/assets/js/62.3f67f8f1.js"><link rel="prefetch" href="/assets/js/63.b9bb2eb2.js"><link rel="prefetch" href="/assets/js/64.d0d390c8.js"><link rel="prefetch" href="/assets/js/65.7091eed7.js"><link rel="prefetch" href="/assets/js/66.0532446c.js"><link rel="prefetch" href="/assets/js/67.fa9fe998.js"><link rel="prefetch" href="/assets/js/68.d4e5fc39.js"><link rel="prefetch" href="/assets/js/69.2e8e8728.js"><link rel="prefetch" href="/assets/js/7.c22f1339.js"><link rel="prefetch" href="/assets/js/70.7fe7dd1e.js"><link rel="prefetch" href="/assets/js/71.7968de88.js"><link rel="prefetch" href="/assets/js/72.d1402eb1.js"><link rel="prefetch" href="/assets/js/73.524fcfb1.js"><link rel="prefetch" href="/assets/js/74.1be7702b.js"><link rel="prefetch" href="/assets/js/75.64e05663.js"><link rel="prefetch" href="/assets/js/76.d4a0c2fd.js"><link rel="prefetch" href="/assets/js/77.14006f72.js"><link rel="prefetch" href="/assets/js/78.4a236501.js"><link rel="prefetch" href="/assets/js/79.5430f58c.js"><link rel="prefetch" href="/assets/js/8.ae196373.js"><link rel="prefetch" href="/assets/js/80.ff413c18.js"><link rel="prefetch" href="/assets/js/81.b1d0768f.js"><link rel="prefetch" href="/assets/js/82.90e93971.js"><link rel="prefetch" href="/assets/js/83.33fe6367.js"><link rel="prefetch" href="/assets/js/84.a0fb9ac3.js"><link rel="prefetch" href="/assets/js/85.e25ed879.js"><link rel="prefetch" href="/assets/js/86.046afc83.js"><link rel="prefetch" href="/assets/js/87.c4eb45e9.js"><link rel="prefetch" href="/assets/js/88.985574a4.js"><link rel="prefetch" href="/assets/js/89.ad80c67a.js"><link rel="prefetch" href="/assets/js/9.63af6ecb.js"><link rel="prefetch" href="/assets/js/90.f7586c92.js"><link rel="prefetch" href="/assets/js/91.d1e9894b.js"><link rel="prefetch" href="/assets/js/92.e74424b5.js"><link rel="prefetch" href="/assets/js/93.5e275069.js"><link rel="prefetch" href="/assets/js/94.096ea4e4.js"><link rel="prefetch" href="/assets/js/95.960db3f8.js"><link rel="prefetch" href="/assets/js/96.af42832a.js"><link rel="prefetch" href="/assets/js/97.32905cba.js"><link rel="prefetch" href="/assets/js/98.cf5cd95a.js"><link rel="prefetch" href="/assets/js/99.1bb98724.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b41e82d5.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://image.bozhu12.cc/myblog/Essay/hendImage01.jpg" alt="柏竹" class="logo"> <span class="site-name can-hide">柏竹</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title router-link-active">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li><li class="dropdown-item"><!----> <a href="/say/say2023/" class="nav-link">说说</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://image.bozhu12.cc/myblog/Essay/favicon.ico"> <div class="blogger-info"><h3>柏竹</h3> <span>奋斗柏竹</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title router-link-active">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li><li class="dropdown-item"><!----> <a href="/say/say2023/" class="nav-link">说说</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ruoyi-plus 若依框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/other/1hg722/#功能分析" class="sidebar-link">功能分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#接口功能" class="sidebar-link">接口功能</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#登录接口-login" class="sidebar-link">登录接口 /login</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#退登接口-logout" class="sidebar-link">退登接口 /logout</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#个人信息-getinfo" class="sidebar-link">个人信息 /getInfo</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#路由接口-getrouters" class="sidebar-link">路由接口 /getRouters</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#拦截器功能" class="sidebar-link">拦截器功能</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#异常处理功能" class="sidebar-link">异常处理功能</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#权限控制" class="sidebar-link">权限控制</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#部门管理" class="sidebar-link">部门管理</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#角色管理" class="sidebar-link">角色管理</a></li><li class="sidebar-sub-header level5"><a href="/other/1hg722/#菜单权限" class="sidebar-link">菜单权限</a></li><li class="sidebar-sub-header level5"><a href="/other/1hg722/#数据权限" class="sidebar-link">数据权限</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#自定义数据权限" class="sidebar-link">自定义数据权限</a></li></ul></li><li><a href="/other/1hg722/#框架整合" class="sidebar-link">框架整合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#整合-mybaits-plus" class="sidebar-link">整合 MyBaits Plus</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#元数据自动填充" class="sidebar-link">元数据自动填充</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#逻辑删除" class="sidebar-link">逻辑删除</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#乐观锁" class="sidebar-link">乐观锁</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#条件构造器" class="sidebar-link">条件构造器</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#整合-redis" class="sidebar-link">整合 Redis</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#整合-sa-token" class="sidebar-link">整合 Sa-Token</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#拦截器注册" class="sidebar-link">拦截器注册</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#排除拦截" class="sidebar-link">排除拦截</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#用户权限管理" class="sidebar-link">用户权限管理</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#dao缓存" class="sidebar-link">Dao缓存</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#拦截原理" class="sidebar-link">拦截原理</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#其他功能" class="sidebar-link">其他功能</a></li></ul></li><li><a href="/other/1hg722/#工具类应用" class="sidebar-link">工具类应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#loginhelper" class="sidebar-link">LoginHelper</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#springutils" class="sidebar-link">SpringUtils</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#dateutil" class="sidebar-link">DateUtil</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#jsonutils" class="sidebar-link">JsonUtils</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#beancopyutils" class="sidebar-link">BeanCopyUtils</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#redisutils" class="sidebar-link">RedisUtils</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#streamutils" class="sidebar-link">StreamUtils</a></li></ul></li><li><a href="/other/1hg722/#前端部分" class="sidebar-link">前端部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#自定义指令权限标识" class="sidebar-link">自定义指令权限标识</a></li></ul></li><li><a href="/other/1hg722/#ruoyi-generator-生成代码" class="sidebar-link">ruoyi-generator 生成代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#应用" class="sidebar-link">应用</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#配置文件yml" class="sidebar-link">配置文件YML</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#web配置" class="sidebar-link">Web配置</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#基本信息" class="sidebar-link">基本信息</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#字段信息" class="sidebar-link">字段信息</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#生成信息" class="sidebar-link">生成信息</a></li></ul></li><li><a href="/other/1hg722/#ruoyi-oss-文件模块" class="sidebar-link">ruoyi-oss 文件模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#目录" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#库相关" class="sidebar-link">库相关</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#sql" class="sidebar-link">SQL</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#redis" class="sidebar-link">Redis</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#涉及接口" class="sidebar-link">涉及接口</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#后端" class="sidebar-link">后端</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#上传" class="sidebar-link">上传</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#查询" class="sidebar-link">查询</a></li><li class="sidebar-sub-header level5"><a href="/other/1hg722/#分页查询" class="sidebar-link">分页查询</a></li><li class="sidebar-sub-header level5"><a href="/other/1hg722/#指定查询" class="sidebar-link">指定查询</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#下载" class="sidebar-link">下载</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#删除" class="sidebar-link">删除</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#minio配置" class="sidebar-link">minio配置</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#window" class="sidebar-link">Window</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#linux" class="sidebar-link">Linux</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#ruoyi系统配置" class="sidebar-link">ruoyi系统配置</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#阿里云" class="sidebar-link">阿里云</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#腾讯云" class="sidebar-link">腾讯云</a></li><li class="sidebar-sub-header level4"><a href="/other/1hg722/#七牛云" class="sidebar-link">七牛云</a></li></ul></li><li><a href="/other/1hg722/#ruoyi-log-日志模块" class="sidebar-link">ruoyi-log 日志模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/other/1hg722/#目录-2" class="sidebar-link">目录</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#日志运作" class="sidebar-link">日志运作</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#日志切面" class="sidebar-link">日志切面</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#库相关-2" class="sidebar-link">库相关</a></li><li class="sidebar-sub-header level3"><a href="/other/1hg722/#后端-2" class="sidebar-link">后端</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/other/#更多" data-v-06225672>更多</a></li><li data-v-06225672><a href="/other/#零碎" data-v-06225672>零碎</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>柏竹</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-09-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">ruoyi-plus 若依框架<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="功能分析"><a href="#功能分析" class="header-anchor">#</a> 功能分析</h2> <h3 id="接口功能"><a href="#接口功能" class="header-anchor">#</a> 接口功能</h3> <h4 id="登录接口-login"><a href="#登录接口-login" class="header-anchor">#</a> 登录接口 /login</h4> <p>大致步骤 :</p> <ol><li>登录请求 /login</li> <li>验证码验证</li> <li>查用户</li> <li>验证密码 , 明文加密比较</li> <li>生成Token</li> <li>记录登录日志</li> <li>响应token</li></ol> <p><strong>整体登录业务步骤 <em>SysLoginService.login()</em></strong></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 登录验证
 * @param username 用户名
 * @param password 密码
 * @param code     验证码
 * @param uuid     唯一标识
 * @return 结果
 */</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> captchaEnabled <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">selectCaptchaEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 验证码开关</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>captchaEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">validateCaptcha</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> code<span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 框架登录不限制从什么表查询 只要最终构建出 LoginUser 即可</span>
    <span class="token class-name">SysUser</span> user <span class="token operator">=</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkLogin</span><span class="token punctuation">(</span><span class="token class-name">LoginType</span><span class="token punctuation">.</span><span class="token constant">PASSWORD</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token operator">!</span><span class="token class-name">BCrypt</span><span class="token punctuation">.</span><span class="token function">checkpw</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 此处可根据登录用户的数据不同 自行创建 loginUser 属性不够用继承扩展就行了</span>
    <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token function">buildLoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成token</span>
    <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">loginByDevice</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">,</span> <span class="token class-name">DeviceType</span><span class="token punctuation">.</span><span class="token constant">PC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.login.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">recordLoginInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>密码验证 <em>SysLoginServicecheckLogin()</em></strong></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token comment">/**
 * 登录校验
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkLogin</span><span class="token punctuation">(</span><span class="token class-name">LoginType</span> loginType<span class="token punctuation">,</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> errorKey <span class="token operator">=</span> <span class="token class-name">CacheConstants</span><span class="token punctuation">.</span><span class="token constant">PWD_ERR_CNT_KEY</span> <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token class-name">String</span> loginFail <span class="token operator">=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">LOGIN_FAIL</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取用户登录错误次数，默认为0 (可自定义限制策略 例如: key + username + ip)</span>
    <span class="token keyword">int</span> errorNumber <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">defaultIfNull</span><span class="token punctuation">(</span><span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 锁定时间内登录 则踢出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorNumber <span class="token operator">&gt;=</span> maxRetryCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 日志记录</span>
        <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> loginFail<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitExceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxRetryCount<span class="token punctuation">,</span> lockTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitExceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxRetryCount<span class="token punctuation">,</span> lockTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 错误次数递增</span>
        errorNumber<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">,</span> errorNumber<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span>lockTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 达到规定错误次数 则锁定登录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorNumber <span class="token operator">&gt;=</span> maxRetryCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> loginFail<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitExceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxRetryCount<span class="token punctuation">,</span> lockTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitExceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxRetryCount<span class="token punctuation">,</span> lockTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 未达到规定错误次数</span>
            <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> loginFail<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserException</span><span class="token punctuation">(</span>loginType<span class="token punctuation">.</span><span class="token function">getRetryLimitCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 登录成功 清空错误次数</span>
    <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>errorKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>生成token</strong></p> <p>通过sa-token实现</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 登录系统 基于 设备类型
 * 针对相同用户体系不同设备
 *
 * @param loginUser 登录用户信息
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loginByDevice</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">,</span> <span class="token class-name">DeviceType</span> deviceType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SaStorage</span> storage <span class="token operator">=</span> <span class="token class-name">SaHolder</span><span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存 用户信息</span>
    storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_KEY</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存 用户ID</span>
    storage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">USER_KEY</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SaLoginModel</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaLoginModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>deviceType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">setDevice</span><span class="token punctuation">(</span>deviceType<span class="token punctuation">.</span><span class="token function">getDevice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 登录 , 并拓展记录配置信息 登录类型 , 用户ID</span>
    <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getLoginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> model<span class="token punctuation">.</span><span class="token function">setExtra</span><span class="token punctuation">(</span><span class="token constant">USER_KEY</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">getTokenSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_KEY</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="退登接口-logout"><a href="#退登接口-logout" class="header-anchor">#</a> 退登接口 /logout</h4> <p>大致步骤 :</p> <ol><li>退出登录请求 /logout</li> <li>sa-token方法退出 , <em>StpUtil.logout()</em></li> <li>记录退出登录日志</li> <li>前端清空token缓存</li></ol> <h4 id="个人信息-getinfo"><a href="#个人信息-getinfo" class="header-anchor">#</a> 个人信息 /getInfo</h4> <p>登录成功后会在路由守卫调用此 /getInfo接口 获取用户自身的基本信息 , 并存到 vuex 中...</p> <p><strong>响应结构</strong></p> <ul><li><code>permissions</code> (数组) : 权限文本标识</li> <li><code>roles</code> (数组) : 身份文本标识</li> <li><code>user</code> (SysUser对象) : 个人用户对象</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;permissions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;system:oss:download&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;system:oss:upload&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;demo:tree:query&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;roles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;teacher&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>...<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="路由接口-getrouters"><a href="#路由接口-getrouters" class="header-anchor">#</a> 路由接口 /getRouters</h4> <p>登录成功后会获取路由路径 , 它也是在路由守卫和 /getInfo接口 一同调用</p> <p><strong>后端主要结构体</strong></p> <p>库表结构 : <code>SysMenu</code></p> <p>响应结构 : <code>RouterVo</code></p> <p><strong>后端主要方法</strong></p> <p>核心封装方法</p> <ul><li>树型封装 : <em>SysMenuServiceImpl.getChildPerms()</em></li> <li>封装转化 : <em>SysMenuServiceImpl.buildMenus()</em></li></ul> <p>开放应用接口 <em>SysLoginController.getRouters()</em></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 获取路由信息
 *
 * @return 路由信息
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;getRouters&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RouterVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span> menus <span class="token operator">=</span> menuService<span class="token punctuation">.</span><span class="token function">selectMenuTreeByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>menuService<span class="token punctuation">.</span><span class="token function">buildMenus</span><span class="token punctuation">(</span>menus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取库菜单主要业务方法 <code>SysMenuServiceImpl#selectMenuTreeByUserId()</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectMenuTreeByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenu</span><span class="token punctuation">&gt;</span></span> menus <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        menus <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectMenuTreeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        menus <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectMenuTreeByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">getChildPerms</span><span class="token punctuation">(</span>menus<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>getChildPerms()方法 , 将列表的所有节点以树型结构封装 , 其结构自行和思路查阅</p></blockquote> <p><strong>前端动态实现</strong></p> <p>通过 <code>/getRouters</code> 接口的 数据的大致结构</p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作成功&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;System&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/system&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;redirect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noRedirect&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Layout&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;alwaysShow&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;系统管理&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/user/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;用户管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Role&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;role&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/role/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;角色管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;peoples&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Menu&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;menu&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/menu/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;菜单管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tree-table&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dept&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dept&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/dept/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;部门管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tree&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Post&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/post/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;岗位管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Dict&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dict&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/dict/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;字典管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dict&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Config&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/config/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;参数设置&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;edit&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Notice&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;notice&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/notice/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;通知公告&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Log&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;redirect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noRedirect&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ParentView&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;alwaysShow&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;日志管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">{</span>
                            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Operlog&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;operlog&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;monitor/operlog/index&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;操作日志&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;form&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token punctuation">{</span>
                            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Logininfor&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;logininfor&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;monitor/logininfor/index&quot;</span><span class="token punctuation">,</span>
                            <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                                <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;登录日志&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;logininfor&quot;</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Oss&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;oss&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;system/oss/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;文件管理&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;upload&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tool&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/tool&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token property">&quot;redirect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;noRedirect&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Layout&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;alwaysShow&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;系统工具&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tool&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;children&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Build&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tool/build/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;表单构建&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gen&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gen&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;hidden&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tool/gen/index&quot;</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;meta&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;代码生成&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;icon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;noCache&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                        <span class="token property">&quot;link&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p>调用此接口在于 vuex 中的 permission 模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">GenerateRoutes</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向后端请求路由数据</span>
    <span class="token function">getRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 深拷贝</span>
      <span class="token keyword">const</span> sdata <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> rdata <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 侧边栏路由</span>
      <span class="token keyword">const</span> sidebarRoutes <span class="token operator">=</span> <span class="token function">filterAsyncRouter</span><span class="token punctuation">(</span>sdata<span class="token punctuation">)</span>
      <span class="token comment">// 重写路由</span>
      <span class="token keyword">const</span> rewriteRoutes <span class="token operator">=</span> <span class="token function">filterAsyncRouter</span><span class="token punctuation">(</span>rdata<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token comment">// 过滤路由 , 根据 管理权的权限标识 控制过滤</span>
      <span class="token keyword">const</span> asyncRoutes <span class="token operator">=</span> <span class="token function">filterDynamicRoutes</span><span class="token punctuation">(</span>dynamicRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      rewriteRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token literal-property property">redirect</span><span class="token operator">:</span> <span class="token string">'/404'</span><span class="token punctuation">,</span> <span class="token literal-property property">hidden</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      router<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>asyncRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_ROUTES'</span><span class="token punctuation">,</span> rewriteRoutes<span class="token punctuation">)</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_SIDEBAR_ROUTERS'</span><span class="token punctuation">,</span> constantRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>sidebarRoutes<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_DEFAULT_ROUTES'</span><span class="token punctuation">,</span> sidebarRoutes<span class="token punctuation">)</span>
      <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_TOPBAR_ROUTES'</span><span class="token punctuation">,</span> sidebarRoutes<span class="token punctuation">)</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>rewriteRoutes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>GenerateRoutes() 调用在于 路由守卫的前置拦截 <code>src/permission.js</code></p> <p>官网文档 : <a href="https://router.vuejs.org/zh/guide/advanced/dynamic-routing.html#%E5%9C%A8%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1" target="_blank" rel="noopener noreferrer">https://router.vuejs.org/zh/guide/advanced/dynamic-routing.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在路由守卫中 动态添加 路由信息</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'GenerateRoutes'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">accessRoutes</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 根据roles权限生成可访问的路由表</span>
  router<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>accessRoutes<span class="token punctuation">)</span> <span class="token comment">// 动态添加可访问路由表</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>to<span class="token punctuation">,</span> <span class="token literal-property property">replace</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// hack方法 确保addRoutes已完成</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="拦截器功能"><a href="#拦截器功能" class="header-anchor">#</a> 拦截器功能</h3> <p>拦截器实现通过 <code>ResourcesConfig</code>配置类</p> <p>Sa-Token拦截器 <code>SaTokenConfig</code>类 <a href="#%E6%95%B4%E5%90%88-sa-token">点击跳转了解相关</a></p> <p>时间统计拦截器 <code>PlusWebInvokeTimeInterceptor</code>类 (全局拦截)</p> <ul><li><p><strong>前置拦截</strong></p> <p>打印请求日志以及参数信息</p></li> <li><p><strong>后置拦截</strong></p> <p>计算请求过程时长</p></li></ul> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusWebInvokeTimeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> prodProfile <span class="token operator">=</span> <span class="token string">&quot;prod&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StopWatch</span><span class="token punctuation">&gt;</span></span> invokeTimeTL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prodProfile<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getActiveProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> url <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 打印请求参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isJsonRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> jsonParam <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">RepeatedlyRequestWrapper</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    jsonParam <span class="token operator">=</span> <span class="token class-name">IoUtil</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;[PLUS]开始请求 =&gt; URL[{}],参数类型[json],参数:[{}]&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> jsonParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> parameterMap <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> parameters <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>parameterMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;[PLUS]开始请求 =&gt; URL[{}],参数类型[param],参数:[{}]&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;[PLUS]开始请求 =&gt; URL[{}],无参数&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invokeTimeTL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prodProfile<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getActiveProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> invokeTimeTL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;[PLUS]结束请求 =&gt; URL[{}],耗时:[{}]毫秒&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopWatch<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            invokeTimeTL<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断本次请求的数据类型是否为json
     *
     * @param request request
     * @return boolean
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isJsonRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> contentType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startsWithIgnoreCase</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="异常处理功能"><a href="#异常处理功能" class="header-anchor">#</a> 异常处理功能</h3> <p>全局异常处理器 <code>GlobalExceptionHandler</code>类</p> <p><strong>异常种类</strong></p> <table><thead><tr><th>异常类</th> <th>说明</th></tr></thead> <tbody><tr><td><code>NotPermissionException</code></td> <td>权限异常</td></tr> <tr><td><code>NotRoleException</code></td> <td>角色异常</td></tr> <tr><td><code>NotLoginException</code></td> <td>认证异常</td></tr> <tr><td><code>HttpRequestMethodNotSupportedException</code></td> <td>请求异常</td></tr> <tr><td><code>DuplicateKeyException</code></td> <td>SQL 主键/唯一 异常</td></tr> <tr><td><code>MyBatisSystemException</code></td> <td>MyBatis异常</td></tr> <tr><td><code>ServiceException</code></td> <td>业务异常</td></tr> <tr><td><code>MissingPathVariableException</code></td> <td>请求参数异常</td></tr> <tr><td><code>MethodArgumentTypeMismatchException</code></td> <td>请求参数类型不匹配</td></tr> <tr><td><code>BindException</code></td> <td>自定义验证异常 (绑定的参数)</td></tr> <tr><td><code>ConstraintViolationException</code></td> <td>自定义验证异常 (约束转化的参数)</td></tr> <tr><td><code>MethodArgumentNotValidException</code></td> <td>自定义验证异常 (对批注的参数)</td></tr></tbody></table> <h3 id="权限控制"><a href="#权限控制" class="header-anchor">#</a> 权限控制</h3> <p>该框架主要以 <strong>部门</strong> 和 <strong>角色</strong> 两个维度进行权限分配</p> <p><strong>前置说明</strong></p> <ol><li>表必须包含字段 : <code>user_id</code> 和 <code>dept_id</code> 作为 当前表的数据控制</li> <li>新增数据前必须为以上两个字段进行添加值</li></ol> <p><strong>涉及基本库表</strong></p> <table><thead><tr><th style="text-align:center;">表</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">sys_dept</td> <td style="text-align:center;">部门表</td></tr> <tr><td style="text-align:center;">sys_role</td> <td style="text-align:center;">角色表</td></tr> <tr><td style="text-align:center;">sys_user</td> <td style="text-align:center;">用户表</td></tr> <tr><td style="text-align:center;">sys_role_dept</td> <td style="text-align:center;">角色部门关联表</td></tr> <tr><td style="text-align:center;">sys_user_role</td> <td style="text-align:center;">用户角色关联表</td></tr> <tr><td style="text-align:center;">sys_role_menu</td> <td style="text-align:center;">角色菜单关联表</td></tr></tbody></table> <h4 id="部门管理"><a href="#部门管理" class="header-anchor">#</a> 部门管理</h4> <p>顾名思义 , 就是将用户划分不同组织 , 方便管理</p> <p>不涉及整体权限控制 , 仅用 dept_id 划分范围应用</p> <h4 id="角色管理"><a href="#角色管理" class="header-anchor">#</a> 角色管理</h4> <p>角色在系统中 , 充当相对重要的功能 , 能够划分 功能细分化 , 根据不同用户划分角色即可分配权限等明细应用!</p> <h5 id="菜单权限"><a href="#菜单权限" class="header-anchor">#</a> 菜单权限</h5> <p>菜单权限的赋予 , 在库表中 , 也不难发现 , <code>sys_role_menu</code>关联表 主要实现 不同角色赋予不同的菜单</p> <h5 id="数据权限"><a href="#数据权限" class="header-anchor">#</a> 数据权限</h5> <p>数据权限的控制是比角色更为细化的权限分配 , 是在库表中的字段层面控制 , 主要通过 <code>user_id</code> 和 <code>dept_id</code> 字段所控制</p> <p>权限分配分为几个角度进行约束 , 以及 SQL约束结构 . <a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%9D%83%E9%99%90">自定义拓展约束点击跳转</a></p> <ul><li><p>全部数据权限 (无约束)</p></li> <li><p>自定义数据权限 (指定部门约束)</p> <p><em>dept_id IN ( xx , xx , .. )</em></p></li> <li><p>本部门约束 (当前部门约束)</p> <p><em>dept_id = xx</em></p></li> <li><p>本部门及以下数据权限 (父子联动)</p> <p><em>dept_id IN ( xx, xx, .. )</em></p></li> <li><p>仅本人数据权限</p> <p><em>user_id = xx</em></p></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在实际场景中 , 可通过多身份实现SQL约束 . 也就是说给即将要限制的 用户 加多一个 <strong>本部门及以下数据权限</strong> 即可</p></div> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <p>通过 拦截器InnerInterceptor接口 , 重写 sql 操作的方法</p> <p><strong>约束过程必要信息</strong></p> <ul><li>权限范围 根据不同身份划分 , 从而锁定 <code>DataScopeType</code>枚举 中指定的模板</li> <li>SQL填充的字段名 , 根据 Mapper层 的 <code>@DataPermission&amp;@DataColumn</code>注解</li> <li>SQL填充的匹配值
<ul><li>根据 <code>DataPermissionHelper</code>类 请求上下文临时存储使用 (使用方式跟Map误差)</li> <li>根据 Bean解析器 , 调取方法返回 字符串 填充</li></ul></li></ul> <blockquote><p><code>@DataPermission</code>可以写在类上 , 使其类的所有方法均可生效</p></blockquote> <p><strong>涉及类</strong></p> <table><thead><tr><th style="text-align:center;">类</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="#DataScopeType">DataScopeType</a></td> <td style="text-align:center;">数据权限模板定义</td></tr> <tr><td style="text-align:center;"><a href="#DataPermission&amp;DataColumn">DataPermission</a></td> <td style="text-align:center;">数据权限组注解</td></tr> <tr><td style="text-align:center;"><a href="#DataPermission&amp;DataColumn">DataColumn</a></td> <td style="text-align:center;">具体的数据全新字段标注</td></tr> <tr><td style="text-align:center;"><a href="#PlusDataPermissionInterceptor">PlusDataPermissionInterceptor</a></td> <td style="text-align:center;">数据权限SQL拦截器</td></tr> <tr><td style="text-align:center;"><a href="#PlusDataPermissionHandler">PlusDataPermissionHandler</a></td> <td style="text-align:center;">数据权限处理器</td></tr> <tr><td style="text-align:center;"><a href="#DataPermissionHelper">DataPermissionHelper</a></td> <td style="text-align:center;">数据权限助手</td></tr> <tr><td style="text-align:center;"><a href="#SysDataScopeService">SysDataScopeService</a></td> <td style="text-align:center;">自定义Bean处理数据权限</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>以上关键类 , 可以进行点击跳转</p></div> <p><strong>DataScopeType</strong> <a id="DataScopeType"></a></p> <p>数据权限 SQL模板 定义</p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">DataScopeType</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 全部数据权限
     */</span>
    <span class="token function">ALL</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 自定数据权限
     */</span>
    <span class="token function">CUSTOM</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; #{#deptName} IN ( #{@sdss.getRoleCustom( #user.roleId )} ) &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 部门数据权限
     */</span>
    <span class="token function">DEPT</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; #{#deptName} = #{#user.deptId} &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 部门及以下数据权限
     */</span>
    <span class="token function">DEPT_AND_CHILD</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; #{#deptName} IN ( #{@sdss.getDeptAndChild( #user.deptId )} )&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 仅本人数据权限
     */</span>
    <span class="token function">SELF</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; #{#userName} = #{#user.userId} &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; 1 = 0 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token comment">/**
    *  模板唯一
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 语法 采用 spel 模板表达式
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> sqlTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 不满足 sqlTemplate 则填充
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> elseSql<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataScopeType</span> <span class="token function">findCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DataScopeType</span> type <span class="token operator">:</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> type<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p>可以看到拼接的占位符应用</p> <table><thead><tr><th style="text-align:center;">占位符</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">#{#deptName}</td> <td style="text-align:center;">在 <code>@DataColumn</code>注解 中的key 对应的模板占位符填充其值</td></tr> <tr><td style="text-align:center;">#{#user.userId}</td> <td style="text-align:center;">在 <code>LoginHelper</code>类 中拿去当前用户userId</td></tr> <tr><td style="text-align:center;">#{@sdss.getRoleCustom( #user.roleId )}</td> <td style="text-align:center;">通过在 <code>SysDataScopeService</code>自定义的Bean中调取方法拿到字符串</td></tr> <tr><td style="text-align:center;">#{@sdss.getDeptAndChild( #user.deptId )} )</td> <td style="text-align:center;">通过在 <code>SysDataScopeService</code>自定义的Bean中调取方法拿到字符串</td></tr></tbody></table> <p><strong>DataPermission&amp;DataColumn</strong> <a id="DataPermission&amp;DataColumn"></a></p> <p>嵌套复合注解应用</p> <details class="custom-block details"><summary>点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DataPermission</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataColumn</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DataColumn</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 占位符关键字
     */</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;deptName&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 占位符替换值
     */</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;dept_id&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>PlusDataPermissionInterceptor</strong> <a id="PlusDataPermissionInterceptor"></a></p> <p>数据权限SQL拦截器 . 继承了 <code>JsqlParserSupport</code>(sql解析器) , 实现了 <code>InnerInterceptor</code>(MP内部拦截器)</p> <p>拦截重写的方法意图 :</p> <ul><li>beforeQuery() 查询前 : 检查 忽略注解 和 无注解方法 , 并且通过 JSqlParser工具 将SQL解析 , 方便操作</li> <li>beforePrepare() 准备前 : 对 删除和修改 通过 JSqlParser工具 将SQL解析 , 方便操作</li> <li>processSelect() 查询操作 : 对 查询 进行SQL约束处理</li> <li>processUpdate() 修改操作 : 对 修改 进行SQL约束处理</li> <li>processDelete() 删除操作 : 对 删除 进行SQL约束处理</li></ul> <blockquote><p>对SQL约束处理的核心方法 <em>dataPermissionHandler.getSqlSegment()</em></p></blockquote> <details class="custom-block details"><summary>点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusDataPermissionInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">JsqlParserSupport</span> <span class="token keyword">implements</span> <span class="token class-name">InnerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PlusDataPermissionHandler</span> dataPermissionHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlusDataPermissionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeQuery</span><span class="token punctuation">(</span><span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">Object</span> parameter<span class="token punctuation">,</span> <span class="token class-name">RowBounds</span> rowBounds<span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span> resultHandler<span class="token punctuation">,</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查忽略注解</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorIgnoreHelper</span><span class="token punctuation">.</span><span class="token function">willIgnoreDataPermission</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检查是否无效 无数据权限注解</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataPermissionHandler<span class="token punctuation">.</span><span class="token function">isInvalid</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 解析 sql 分配对应方法</span>
        <span class="token class-name">PluginUtils<span class="token punctuation">.</span>MPBoundSql</span> mpBs <span class="token operator">=</span> <span class="token class-name">PluginUtils</span><span class="token punctuation">.</span><span class="token function">mpBoundSql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mpBs<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token function">parserSingle</span><span class="token punctuation">(</span>mpBs<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforePrepare</span><span class="token punctuation">(</span><span class="token class-name">StatementHandler</span> sh<span class="token punctuation">,</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">,</span> <span class="token class-name">Integer</span> transactionTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PluginUtils<span class="token punctuation">.</span>MPStatementHandler</span> mpSh <span class="token operator">=</span> <span class="token class-name">PluginUtils</span><span class="token punctuation">.</span><span class="token function">mpStatementHandler</span><span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> mpSh<span class="token punctuation">.</span><span class="token function">mappedStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SqlCommandType</span> sct <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 准备前处理更新 和 删除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sct <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">UPDATE</span> <span class="token operator">||</span> sct <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorIgnoreHelper</span><span class="token punctuation">.</span><span class="token function">willIgnoreDataPermission</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PluginUtils<span class="token punctuation">.</span>MPBoundSql</span> mpBs <span class="token operator">=</span> mpSh<span class="token punctuation">.</span><span class="token function">mPBoundSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mpBs<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token function">parserMulti</span><span class="token punctuation">(</span>mpBs<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">/**
     * 查询前 , 重写sql
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processSelect</span><span class="token punctuation">(</span><span class="token class-name">Select</span> select<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SelectBody</span> selectBody <span class="token operator">=</span> select<span class="token punctuation">.</span><span class="token function">getSelectBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectBody <span class="token keyword">instanceof</span> <span class="token class-name">PlainSelect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 简单查询</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PlainSelect</span><span class="token punctuation">)</span> selectBody<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>selectBody <span class="token keyword">instanceof</span> <span class="token class-name">SetOperationList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 联合查询</span>
            <span class="token class-name">SetOperationList</span> setOperationList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SetOperationList</span><span class="token punctuation">)</span> selectBody<span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectBody</span><span class="token punctuation">&gt;</span></span> selectBodyList <span class="token operator">=</span> setOperationList<span class="token punctuation">.</span><span class="token function">getSelects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            selectBodyList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PlainSelect</span><span class="token punctuation">)</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">/**
     * 修改前 , 重写sql
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processUpdate</span><span class="token punctuation">(</span><span class="token class-name">Update</span> update<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Expression</span> sqlSegment <span class="token operator">=</span> dataPermissionHandler<span class="token punctuation">.</span><span class="token function">getSqlSegment</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">getWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> sqlSegment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            update<span class="token punctuation">.</span><span class="token function">setWhere</span><span class="token punctuation">(</span>sqlSegment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">/**
     * 删除前 , 重写sql
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processDelete</span><span class="token punctuation">(</span><span class="token class-name">Delete</span> delete<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Expression</span> sqlSegment <span class="token operator">=</span> dataPermissionHandler<span class="token punctuation">.</span><span class="token function">getSqlSegment</span><span class="token punctuation">(</span>delete<span class="token punctuation">.</span><span class="token function">getWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> sqlSegment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delete<span class="token punctuation">.</span><span class="token function">setWhere</span><span class="token punctuation">(</span>sqlSegment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置 where 条件
     *
     * @param plainSelect       查询对象
     * @param mappedStatementId 执行方法id
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setWhere</span><span class="token punctuation">(</span><span class="token class-name">PlainSelect</span> plainSelect<span class="token punctuation">,</span> <span class="token class-name">String</span> mappedStatementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Expression</span> sqlSegment <span class="token operator">=</span> dataPermissionHandler<span class="token punctuation">.</span><span class="token function">getSqlSegment</span><span class="token punctuation">(</span>plainSelect<span class="token punctuation">.</span><span class="token function">getWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappedStatementId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> sqlSegment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            plainSelect<span class="token punctuation">.</span><span class="token function">setWhere</span><span class="token punctuation">(</span>sqlSegment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>PlusDataPermissionHandler</strong> <a id="PlusDataPermissionHandler"></a></p> <p>数据权限过滤 核心处理类</p> <p>大致流程 :</p> <ol><li><p>获取注解填充数据 , 根据全限定名方法 反射获取</p> <p><em>DataColumn[] dataColumns = findAnnotation(mappedStatementId);</em></p></li> <li><p>请求上下文设置参数填充 值 (当前用户)</p> <p><em>DataPermissionHelper.setVariable(&quot;user&quot;, currentUser);</em></p></li> <li><p>构建SQL Where约束</p> <p><em>String dataFilterSql = buildDataFilter(dataColumns, isSelect);</em></p></li> <li><p>响应 SQL约束表达式 设置where约束</p> <p><em>plainSelect.setWhere(sqlSegment);</em></p></li></ol> <details class="custom-block details"><summary>点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusDataPermissionHandler</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 方法或类(名称) 与 注解的映射关系缓存
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataPermission</span><span class="token punctuation">&gt;</span></span> dataPermissionCacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 无效注解方法缓存用于快速返回
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> invalidCacheSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * spel 解析器
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ParserContext</span> parserContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplateParserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * bean解析器 用于处理 spel 表达式中对 bean 的调用
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BeanResolver</span> beanResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryResolver</span><span class="token punctuation">(</span><span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * SQL 拼接核心方法
     * @param where 约束操作的表达式
     * @param mappedStatementId mapper全限定名路径
     * @param isSelect 是否查询
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Expression</span> <span class="token function">getSqlSegment</span><span class="token punctuation">(</span><span class="token class-name">Expression</span> where<span class="token punctuation">,</span> <span class="token class-name">String</span> mappedStatementId<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isSelect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DataColumn</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataColumns <span class="token operator">=</span> <span class="token function">findAnnotation</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 缓存无效注解 , 避免不必要的数据加载</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>dataColumns<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将没有注解的方法缓存起来 , 根据全限定名方法判断是否含有缓存</span>
            invalidCacheSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> where<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 存储当前用户 user , 一遍请求应用</span>
        <span class="token class-name">LoginUser</span> currentUser <span class="token operator">=</span> <span class="token class-name">DataPermissionHelper</span><span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>currentUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            currentUser <span class="token operator">=</span> <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataPermissionHelper</span><span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> currentUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果是超级管理员，则不过滤数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">isAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> where<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 拿到注解信息构建 约束sql</span>
        <span class="token class-name">String</span> dataFilterSql <span class="token operator">=</span> <span class="token function">buildDataFilter</span><span class="token punctuation">(</span>dataColumns<span class="token punctuation">,</span> isSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>dataFilterSql<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> where<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Expression</span> expression <span class="token operator">=</span> <span class="token class-name">CCJSqlParserUtil</span><span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>dataFilterSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 数据权限使用单独的括号 防止与其他条件冲突</span>
            <span class="token class-name">Parenthesis</span> parenthesis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parenthesis</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AndExpression</span><span class="token punctuation">(</span>where<span class="token punctuation">,</span> parenthesis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> parenthesis<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JSQLParserException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;数据权限解析异常 =&gt; &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 构造数据过滤sql
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">buildDataFilter</span><span class="token punctuation">(</span><span class="token class-name">DataColumn</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dataColumns<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isSelect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新或删除需满足所有条件 (查询采用 OR ; 删除/修改 采用 AND)</span>
        <span class="token class-name">String</span> joinStr <span class="token operator">=</span> isSelect <span class="token operator">?</span> <span class="token string">&quot; OR &quot;</span> <span class="token operator">:</span> <span class="token string">&quot; AND &quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> user <span class="token operator">=</span> <span class="token class-name">DataPermissionHelper</span><span class="token punctuation">.</span><span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 评估对象 (用户构建约束sql)</span>
        <span class="token class-name">StandardEvaluationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 bean解析器</span>
        context<span class="token punctuation">.</span><span class="token function">setBeanResolver</span><span class="token punctuation">(</span>beanResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 请求的所有上下文 设置到 context 中</span>
        <span class="token class-name">DataPermissionHelper</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>context<span class="token operator">::</span><span class="token function">setVariable</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> conditions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RoleDTO</span> role <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getRoleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取角色权限泛型 (根据其对象获取模板sql)</span>
            <span class="token class-name">DataScopeType</span> type <span class="token operator">=</span> <span class="token class-name">DataScopeType</span><span class="token punctuation">.</span><span class="token function">findCode</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">getDataScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;角色数据范围异常 =&gt; &quot;</span> <span class="token operator">+</span> role<span class="token punctuation">.</span><span class="token function">getDataScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 全部数据权限直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">DataScopeType</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// 拼接环节</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DataColumn</span> dataColumn <span class="token operator">:</span> dataColumns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dataColumn<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!=</span> dataColumn<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;角色数据范围异常 =&gt; key与value长度不匹配&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 不包含 key 变量 则不处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsAny</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getSqlTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>dataColumn<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token string">&quot;#&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 设置注解变量 key 为表达式变量 value 为变量值</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dataColumn<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span>dataColumn<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dataColumn<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 解析sql模板并填充 (bean解析填充)</span>
                <span class="token comment">// bean解析器调用方法填充数据</span>
                <span class="token class-name">String</span> sql <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getSqlTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                conditions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>joinStr <span class="token operator">+</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
                isSuccess <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 未处理成功则填充替补模板方案</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSuccess <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">getElseSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                conditions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>joinStr <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">getElseSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将 conditions 内的 字符串按顺序拼接起来</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>conditions<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/**
             * 拼接后的结果可能为以下结果 , 需要排除前缀
             * OR  dept_id IN ( xx,xx,xx ) OR ...
             */</span>
            <span class="token keyword">return</span> sql<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>joinStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通过方法的全限定名称进行反射解析获取反射数据
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">DataColumn</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">findAnnotation</span><span class="token punctuation">(</span><span class="token class-name">String</span> mappedStatementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 类全限定名路径</span>
        <span class="token class-name">String</span> clazzName <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 方法名</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">ClassUtil</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>clazzName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 过滤掉不相符的方法名</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> methods <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token class-name">ClassUtil</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataPermission</span> dataPermission<span class="token punctuation">;</span>
        <span class="token comment">// 获取方法注解</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataPermission <span class="token operator">=</span> dataPermissionCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>dataPermission<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> dataPermission<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationUtil</span><span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">DataPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dataPermission <span class="token operator">=</span> <span class="token class-name">AnnotationUtil</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">DataPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                dataPermissionCacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">,</span> dataPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> dataPermission<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检查类是否包含 DataPermission注解 并且获取</span>
        dataPermission <span class="token operator">=</span> dataPermissionCacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>dataPermission<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> dataPermission<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取类注解</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationUtil</span><span class="token punctuation">.</span><span class="token function">hasAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">DataPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataPermission <span class="token operator">=</span> <span class="token class-name">AnnotationUtil</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token class-name">DataPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataPermissionCacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dataPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> dataPermission<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 是否为无效方法 无数据权限
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isInvalid</span><span class="token punctuation">(</span><span class="token class-name">String</span> mappedStatementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> invalidCacheSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>mappedStatementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></details> <p><strong>DataPermissionHelper</strong> <a id="DataPermissionHelper"></a></p> <p>数据权限助手 . 通过 <em>SaHolder.getStorage()</em> , 拿到请求上下文存储数据</p> <details class="custom-block details"><summary>点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked cast&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataPermissionHelper</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DATA_PERMISSION_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;data:permission&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getVariable</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> context <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SaStorage</span> saStorage <span class="token operator">=</span> <span class="token class-name">SaHolder</span><span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> attribute <span class="token operator">=</span> saStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DATA_PERMISSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            saStorage<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">DATA_PERMISSION_KEY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attribute <span class="token operator">=</span> saStorage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DATA_PERMISSION_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> attribute<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;data permission context type exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 开启忽略数据权限(开启后需手动调用 {@link #disableIgnore()} 关闭)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InterceptorIgnoreHelper</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">IgnoreStrategy</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataPermission</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 关闭忽略数据权限
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">disableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InterceptorIgnoreHelper</span><span class="token punctuation">.</span><span class="token function">clearIgnoreStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在忽略数据权限中执行
     *
     * @param handle 处理执行方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ignore</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            handle<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">disableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在忽略数据权限中执行
     *
     * @param handle 处理执行方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">ignore</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> handle<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">disableIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>SysDataScopeService</strong> <a id="SysDataScopeService"></a></p> <p>数据权限 服务 , 通过 Bean解析器 解析调用方法 , 对其SQL进行填充约束值</p> <blockquote><p>如果自定义写一个Bean , 并且是用于模板中填充使用的方法 , 则当前Service不能 <strong>调用</strong>含有 <code>@DataPermission</code>注解 方法 , 可能会导致递归死循环问题</p></blockquote> <details class="custom-block details"><summary>点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;sdss&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysDataScopeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ISysDataScopeService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SysRoleDeptMapper</span> roleDeptMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SysDeptMapper</span> deptMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRoleCustom</span><span class="token punctuation">(</span><span class="token class-name">Long</span> roleId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRoleDept</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> roleDeptMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRoleDept</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SysRoleDept</span><span class="token operator">::</span><span class="token function">getDeptId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SysRoleDept</span><span class="token operator">::</span><span class="token function">getRoleId</span><span class="token punctuation">,</span> roleId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> rd <span class="token operator">-&gt;</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDeptAndChild</span><span class="token punctuation">(</span><span class="token class-name">Long</span> deptId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDept</span><span class="token punctuation">&gt;</span></span> deptList <span class="token operator">=</span> deptMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDept</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SysDept</span><span class="token operator">::</span><span class="token function">getDeptId</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">DataBaseHelper</span><span class="token punctuation">.</span><span class="token function">findInSet</span><span class="token punctuation">(</span>deptId<span class="token punctuation">,</span> <span class="token string">&quot;ancestors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>deptList<span class="token punctuation">,</span> <span class="token class-name">SysDept</span><span class="token operator">::</span><span class="token function">getDeptId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>deptId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDept</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> deptMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysDept</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SysDept</span><span class="token operator">::</span><span class="token function">getDeptId</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">SysDept</span><span class="token operator">::</span><span class="token function">getDeptId</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> d <span class="token operator">-&gt;</span> <span class="token class-name">Convert</span><span class="token punctuation">.</span><span class="token function">toStr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="自定义数据权限"><a href="#自定义数据权限" class="header-anchor">#</a> 自定义数据权限</h4> <p><strong>大概流程 :</strong></p> <ol><li>在前端数据权限的下拉框中追加标识 <em>src/views/system/role/index.vue</em>
dataScopeOptions数组追加对象 (写死)</li> <li>在 <code>DataScopeType</code>类 中 , 写一个自己的sql约束模板 , 需要需要对应上</li> <li>在 <code>mapper</code>层 , 使用 <code>@DataPermission</code>注解 填充占位符</li> <li>在调用 mapper方法 前 , 可通过 *DataPermissionHelper.serVariable()*方法 , 将其值填充到模板</li> <li>测试查询观察SQL拼接情况 ...</li></ol> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>在写SQL模板时 , 前后部分建议追加一个空格 , 防止拼接时 前后混淆</li> <li><code>DataPermissionHelper</code>类 中设置的值 , 仅在本请求上下文有效</li></ul></div> <h2 id="框架整合"><a href="#框架整合" class="header-anchor">#</a> 框架整合</h2> <h3 id="整合-mybaits-plus"><a href="#整合-mybaits-plus" class="header-anchor">#</a> 整合 MyBaits Plus</h3> <p>官方文档 : <a href="https://baomidou.com/pages/223848/#tablename" target="_blank" rel="noopener noreferrer">MyBaits Plus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="元数据自动填充"><a href="#元数据自动填充" class="header-anchor">#</a> 元数据自动填充</h4> <p><strong>实体类 @TableField(fill = FieldFill.xxx) 填充策略</strong></p> <p>通过 <code>CreateAndUpdateMetaObjectHandler</code>类 实现元数据操作填充策略 , 重写 插入/更新 方法实现</p> <ul><li>insertFill()</li> <li>updateFill()</li></ul> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateAndUpdateMetaObjectHandler</span> <span class="token keyword">implements</span> <span class="token class-name">MetaObjectHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> metaObject<span class="token punctuation">.</span><span class="token function">getOriginalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BaseEntity</span> baseEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getOriginalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Date</span> current <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>baseEntity<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> baseEntity<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                baseEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                baseEntity<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>baseEntity<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> baseEntity<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">getLoginUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 当前已登录 且 创建人为空 则填充</span>
                baseEntity<span class="token punctuation">.</span><span class="token function">setCreateBy</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 当前已登录 且 更新人为空 则填充</span>
                baseEntity<span class="token punctuation">.</span><span class="token function">setUpdateBy</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;自动注入异常 =&gt; &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">HTTP_UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateFill</span><span class="token punctuation">(</span><span class="token class-name">MetaObject</span> metaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> metaObject<span class="token punctuation">.</span><span class="token function">getOriginalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BaseEntity</span> baseEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> metaObject<span class="token punctuation">.</span><span class="token function">getOriginalObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Date</span> current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新时间填充(不管为不为空)</span>
                baseEntity<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">getLoginUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 当前已登录 更新人填充(不管为不为空)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    baseEntity<span class="token punctuation">.</span><span class="token function">setUpdateBy</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;自动注入异常 =&gt; &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">HTTP_UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取登录用户名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getLoginUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            loginUser <span class="token operator">=</span> <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;自动注入警告 =&gt; 用户未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">?</span> loginUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="逻辑删除"><a href="#逻辑删除" class="header-anchor">#</a> 逻辑删除</h4> <p>自行 在库添加 删除标识字段 , 对象实体类 删除成员变量 需要 <code>@TableLogic</code>注解 生效</p> <p>官方文档 : <a href="https://baomidou.com/pages/6b03c5/#%E6%AD%A5%E9%AA%A4-1-%E9%85%8D%E7%BD%AEcom-baomidou-mybatisplus-core-config-globalconfig-dbconfig" target="_blank" rel="noopener noreferrer">MyBaits Plus 逻辑删除<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h4> <p>乐观锁根据 库字段进行判断是否修改 , 每次修改仅一个线程操作</p> <p>官方文档 : <a href="https://baomidou.com/pages/0d93c0/#optimisticlockerinnerinterceptor" target="_blank" rel="noopener noreferrer">MyBatis Plus 乐观锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>应用</strong></p> <ol><li><p>添加配置插件 , <code>MybatisPlusConfig</code>配置类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">MybatisPlusInterceptor</span> <span class="token function">mybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MybatisPlusInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MybatisPlusInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 数据权限处理</span>
    interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token function">dataPermissionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分页插件</span>
    interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token function">paginationInnerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 乐观锁插件</span>
    interceptor<span class="token punctuation">.</span><span class="token function">addInnerInterceptor</span><span class="token punctuation">(</span><span class="token function">optimisticLockerInnerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 乐观锁插件
 */</span>
<span class="token keyword">public</span> <span class="token class-name">OptimisticLockerInnerInterceptor</span> <span class="token function">optimisticLockerInnerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OptimisticLockerInnerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>自行 在库添加 版本标识字段 , 对象实体类 版本成员变量 需要 <code>@Version</code>注解 生效</p></li></ol> <h4 id="条件构造器"><a href="#条件构造器" class="header-anchor">#</a> 条件构造器</h4> <p>执行SQL 可以根据约束得到预期想要的结果 , MyBatis Plus 提供了如下两个约束的类 :</p> <ul><li>QueryWrapper&lt;T&gt;</li> <li>LambdaQueryWrapper&lt;T&gt;</li></ul> <blockquote><p>两者用法差不多 , 但唯独不同的就是 , 指定约束字段的参数 , LambdaQueryWrapper可根据 实体类的方法指定 , 而另一个通过 库字段名 指定 , 剩下的懂得都懂</p></blockquote> <p>官方文档 : <a href="https://baomidou.com/pages/10c804/#abstractwrapper" target="_blank" rel="noopener noreferrer">MyBatis Plus 条件构造器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>对象属性</strong></p> <ul><li>SqlSegmet (SQL约束片段)</li> <li>TargetSql (简写 目标SQL)</li> <li>ParamAlias (参数别名)</li> <li>ParamNameValuePairs (参数变量&amp;变量值)</li> <li>CustomSqlSegment (完整SQL)</li></ul> <p><strong>条件构造器转化</strong></p> <p>有些情况 LambdaQueryWrapper 不能满足更多功能的应用 , 因此采用 QueryWrapper , 可以通过以下方式 两种混合应用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> qw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> law <span class="token operator">=</span> qw<span class="token punctuation">.</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>自定义Select拓展</strong></p> <p>在默认情况下查询仅查询实体类 , select 拓展其他字段应用则会查不到 , 解决方案 :</p> <ul><li>在实体类添加成员变量 , 且SQL字段的 别名和该类的成员变量名一致</li> <li>采用Maps形式查询接收变量 , 但要自行解决对象转化环节</li></ul> <h3 id="整合-redis"><a href="#整合-redis" class="header-anchor">#</a> 整合 Redis</h3> <p>采用Redisson通信 , 其优点就不用多说了</p> <p><strong>依赖</strong></p> <ul><li>redisson-spring-boot-starter</li> <li>lock4j-redisson-spring-boot-starter</li> <li>redisson-spring-data-27</li></ul> <p><strong>配置</strong></p> <p>映射配置文件 : <code>RedissonProperties</code></p> <p>配置类 : <code>RedisConfig</code></p> <p>应用 :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RedissonClient</span> <span class="token constant">CLIENT</span> <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RedissonClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>工具类 : <a href="#RedisUtils"><code>RedisUtils</code></a> (应用实例点击跳转)</p> <p><strong>监听</strong></p> <p>订阅监听 生效 需要修改 Reids配置 <code>notify-keyspace-events</code> , 其配置值 :</p> <ol><li><strong>K</strong>: 开启键空间事件通知 , 发布在<code>__keyspace@&lt;db&gt;__:*</code>频道上</li> <li><strong>E</strong>: 开启键事件事件通知 , 发布在<code>__keyevent@&lt;db&gt;__:*</code>频道上</li> <li><strong>g</strong>: 开启一般命令事件通知, 通常是不指定对象类型的命令 , 例如<strong>DEL</strong> , <strong>RENAME</strong>等等</li> <li><strong>$</strong>: 开启操作字符串命令事件通知</li> <li><strong>l</strong>: 开启操作列表对象事件通知</li> <li><strong>s</strong>: 开启操作集合对象事件通知</li> <li><strong>h</strong>: 开启操作散列对象事件通知</li> <li><strong>z</strong>: 开启操作有序集合对象事件通知</li> <li><strong>x</strong>: 开启键的过期事件通知</li> <li><strong>e</strong>: 开启键的淘汰事件通知</li> <li><strong>A</strong>: 等价于<code>g$lshzxe</code> , 如果<code>notify-keyspace-events</code>被设置为<strong>AKE</strong>事件 , 则意味着开启所有键以及所有事件的通知。</li></ol> <blockquote><p>修改配置后需要重启Reids服务生效配置</p></blockquote> <h3 id="整合-sa-token"><a href="#整合-sa-token" class="header-anchor">#</a> 整合 Sa-Token</h3> <p>身份权限认证 等...</p> <p>官方文档 : <a href="https://sa-token.cc/doc.html#/" target="_blank" rel="noopener noreferrer">https://sa-token.cc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="拦截器注册"><a href="#拦截器注册" class="header-anchor">#</a> 拦截器注册</h4> <p><code>com.ruoyi.framework.config.SaTokenConfig</code></p> <p>对所有接口都进行登录拦截校验</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaTokenConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SecurityProperties</span> securityProperties<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 注册sa-token的拦截器
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册路由拦截器，自定义验证规则</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SaInterceptor</span><span class="token punctuation">(</span>handler <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">AllUrlHandler</span> allUrlHandler <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">AllUrlHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 登录验证 -- 排除多个路径</span>
            <span class="token class-name">SaRouter</span>
                <span class="token comment">// 获取所有的</span>
                <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>allUrlHandler<span class="token punctuation">.</span><span class="token function">getUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 对未排除的路径进行检查</span>
                <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 检查是否登录 是否有token</span>
                    <span class="token class-name">StpUtil</span><span class="token punctuation">.</span><span class="token function">checkLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 排除不需要拦截的路径</span>
            <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>securityProperties<span class="token punctuation">.</span><span class="token function">getExcludes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>重写 saTokenDao 应用Bean , 优化缓存 , 改为Redis</p></blockquote> <h4 id="排除拦截"><a href="#排除拦截" class="header-anchor">#</a> 排除拦截</h4> <p>指定路径不受认证权限相关约束 , 配置类中 指定排除拦截 <em>securityProperties.getExcludes()</em></p> <p><code>application.yml</code> 配置文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token comment"># 排除路径</span>
  <span class="token key atrule">excludes</span><span class="token punctuation">:</span>
    <span class="token comment"># 静态资源</span>
    <span class="token punctuation">-</span> /<span class="token important">*.html</span>
    <span class="token punctuation">-</span> /<span class="token important">**/*.html</span>
    <span class="token punctuation">-</span> /<span class="token important">**/*.css</span>
    <span class="token punctuation">-</span> /<span class="token important">**/*.js</span>
    <span class="token comment"># 公共路径</span>
    <span class="token punctuation">-</span> /favicon.ico
    <span class="token punctuation">-</span> /error
    <span class="token comment"># swagger 文档配置</span>
    <span class="token punctuation">-</span> /<span class="token important">*/api-docs</span>
    <span class="token punctuation">-</span> /<span class="token important">*/api-docs/**</span>
    <span class="token comment"># actuator 监控配置</span>
    <span class="token punctuation">-</span> /actuator
    <span class="token punctuation">-</span> /actuator/<span class="token important">**</span>
</code></pre></div><h4 id="用户权限管理"><a href="#用户权限管理" class="header-anchor">#</a> 用户权限管理</h4> <p>Sa-Token根据 重写 <code>StpInterface</code>类 , 获取用户的权限信息 <em>菜单权限标识 / 角色权限</em>  , 以便在注解中校验使用</p> <p>官方文档 : <a href="https://sa-token.cc/doc.html#/use/jur-auth" target="_blank" rel="noopener noreferrer">https://sa-token.cc/doc.html#/use/jur-auth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaPermissionImpl</span> <span class="token keyword">implements</span> <span class="token class-name">StpInterface</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 获取菜单权限列表
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> loginId<span class="token punctuation">,</span> <span class="token class-name">String</span> loginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserType</span> userType <span class="token operator">=</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token function">getUserType</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">==</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token constant">SYS_USER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getMenuPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">==</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token constant">APP_USER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 其他端 自行根据业务编写</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取角色权限列表
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRoleList</span><span class="token punctuation">(</span><span class="token class-name">Object</span> loginId<span class="token punctuation">,</span> <span class="token class-name">String</span> loginType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserType</span> userType <span class="token operator">=</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token function">getUserType</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">==</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token constant">SYS_USER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getRolePermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userType <span class="token operator">==</span> <span class="token class-name">UserType</span><span class="token punctuation">.</span><span class="token constant">APP_USER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 其他端 自行根据业务编写</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="dao缓存"><a href="#dao缓存" class="header-anchor">#</a> Dao缓存</h4> <p>Sa-Token 持久层缓存是基于 本机内存Map存储 , 一旦重启宕机则会丢失数据</p> <p>因此整合了 Redis缓存应用</p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlusSaTokenDao</span> <span class="token keyword">implements</span> <span class="token class-name">SaTokenDao</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 获取Value，如无返空
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 写入Value，并设定存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> timeout <span class="token operator">&lt;=</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NOT_VALUE_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断是否为永不过期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修修改指定key-value键值对 (过期时间不变)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> expire <span class="token operator">=</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// -2 = 无此键</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NOT_VALUE_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除Value
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Value的剩余存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> timeout <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> timeout <span class="token operator">:</span> timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修改Value的剩余存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateTimeout</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否想要设置为永久</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> expire <span class="token operator">=</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果其已经被设置为永久，则不作任何处理</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果尚未被设置为永久，那么再次set一次</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 获取Object，如无返空
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 写入Object，并设定存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> timeout <span class="token operator">&lt;=</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NOT_VALUE_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断是否为永不过期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 更新Object (过期时间不变)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> expire <span class="token operator">=</span> <span class="token function">getObjectTimeout</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// -2 = 无此键</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NOT_VALUE_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除Object
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Object的剩余存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getObjectTimeout</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> timeout <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> timeout <span class="token operator">:</span> timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 修改Object的剩余存活时间 (单位: 秒)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateObjectTimeout</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断是否想要设置为永久</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> expire <span class="token operator">=</span> <span class="token function">getObjectTimeout</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expire <span class="token operator">==</span> <span class="token class-name">SaTokenDao</span><span class="token punctuation">.</span><span class="token constant">NEVER_EXPIRE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果其已经被设置为永久，则不作任何处理</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果尚未被设置为永久，那么再次set一次</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 搜索数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchData</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">,</span> <span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sortType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prefix <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">+</span> keyword <span class="token operator">+</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">SaFoxUtil</span><span class="token punctuation">.</span><span class="token function">searchList</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> start<span class="token punctuation">,</span> size<span class="token punctuation">,</span> sortType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="拦截原理"><a href="#拦截原理" class="header-anchor">#</a> 拦截原理</h4> <p>首先分析接口请求被拦截的过程 : (仅展示核心部分)</p> <ol><li>进入前置拦截器 <em>SaInterceptor.preHandle()</em></li> <li>判断方法是否注解了 <code>@SaIgnore</code> (跳过整个Sa-Token拦截)
<em>SaStrategy.instance.isAnnotationPresent.apply(method, SaIgnore.class)</em></li> <li>鉴权权限注解 (所有相关注解校验)
<em>SaStrategy.instance.checkMethodAnnotation.accept(method);</em> <ol><li>对 类/方法 的所有相关注解校验</li> <li>逐个判断注解对象是否存在 , 存在则进行响应的注解校验</li></ol></li> <li>最后校验 <em>auth.run(handler);</em> , 此方法会调用会 <code>SaInterceptor.auth</code>(构造方法中的lambda表达式)</li> <li>获取所有路径 <em>AllUrlHandler.getUrls()</em> (在Bean中调取) 并匹配当中获取的路径</li> <li>校验是否有token <em>StpUtil.checkLogin();</em></li></ol> <p>Sa-Token 自定义拦截类<code>cn.dev33.satoken.interceptor.SaInterceptor</code></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SaInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SaInterceptor</span><span class="token punctuation">(</span><span class="token class-name">SaParamFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> auth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>auth <span class="token operator">=</span> auth<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    
	<span class="token comment">/**
	 * 每次请求之前触发的方法 
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>

			<span class="token comment">// 这里必须确保 handler 是 HandlerMethod 类型时，才能进行注解鉴权</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>isAnnotation <span class="token operator">&amp;&amp;</span> handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				
				<span class="token comment">// 获取此请求对应的 Method 处理函数 </span>
				<span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// 如果此 Method 或其所属 Class 标注了 @SaIgnore，则忽略掉鉴权</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>isAnnotationPresent<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">SaIgnore</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// 注意这里直接就退出整个鉴权了，最底部的 auth.run() 路由拦截鉴权也被跳出了</span>
					<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// 执行注解鉴权</span>
				<span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>checkMethodAnnotation<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// Auth 路由拦截鉴权校验</span>
			auth<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
			
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">StopMatchException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// StopMatchException 异常代表：停止匹配，进入Controller</span>

		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BackResultException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// BackResultException 异常代表：停止匹配，向前端输出结果</span>
			<span class="token comment">// 		请注意此处默认 Content-Type 为 text/plain，如果需要返回 JSON 信息，需要在 back 前自行设置 Content-Type 为 application/json</span>
			<span class="token comment">// 		例如：SaHolder.getResponse().setHeader(&quot;Content-Type&quot;, &quot;application/json;charset=UTF-8&quot;);</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/plain; charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token punctuation">}</span>
			response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 通过验证 </span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p>Sa-Token 策略对象 <code>cn.dev33.satoken.strategy.SaStrategy</code></p> <ol><li>鉴定注解主要入口
<em>SaStrategy.instance.checkMethodAnnotation.accept(method);</em></li> <li>分别校验 类 和 方法 (类能够对当前Controller中的所有接口校验生效)</li> <li>调用 checkElementAnnotation 进行处理不同的校验类型</li> <li>...</li></ol> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SaStrategy</span> <span class="token punctuation">{</span>
	
    <span class="token comment">/**
	 * 获取 SaStrategy 对象的单例引用
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SaStrategy</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">/**
	 * 对一个 [Method] 对象进行注解校验 （注解鉴权内部实现）
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">SaCheckMethodAnnotationFunction</span> checkMethodAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

		<span class="token comment">// 先校验 Method 所属 Class 上的注解</span>
		instance<span class="token punctuation">.</span>checkElementAnnotation<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 再校验 Method 上的注解</span>
		instance<span class="token punctuation">.</span>checkElementAnnotation<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 对一个 [元素] 对象进行注解校验 （注解鉴权内部实现）
	 */</span>
	<span class="token keyword">public</span> <span class="token class-name">SaCheckElementAnnotationFunction</span> checkElementAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

		<span class="token comment">// 校验 @SaCheckLogin 注解</span>
		<span class="token class-name">SaCheckLogin</span> checkLogin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckLogin</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckLogin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkLogin <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaManager</span><span class="token punctuation">.</span><span class="token function">getStpLogic</span><span class="token punctuation">(</span>checkLogin<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkByAnnotation</span><span class="token punctuation">(</span>checkLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckRole 注解</span>
		<span class="token class-name">SaCheckRole</span> checkRole <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckRole</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckRole</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkRole <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaManager</span><span class="token punctuation">.</span><span class="token function">getStpLogic</span><span class="token punctuation">(</span>checkRole<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkByAnnotation</span><span class="token punctuation">(</span>checkRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckPermission 注解</span>
		<span class="token class-name">SaCheckPermission</span> checkPermission <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckPermission</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckPermission</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkPermission <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaManager</span><span class="token punctuation">.</span><span class="token function">getStpLogic</span><span class="token punctuation">(</span>checkPermission<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkByAnnotation</span><span class="token punctuation">(</span>checkPermission<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckSafe 注解</span>
		<span class="token class-name">SaCheckSafe</span> checkSafe <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckSafe</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckSafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkSafe <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaManager</span><span class="token punctuation">.</span><span class="token function">getStpLogic</span><span class="token punctuation">(</span>checkSafe<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkByAnnotation</span><span class="token punctuation">(</span>checkSafe<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckDisable 注解</span>
		<span class="token class-name">SaCheckDisable</span> checkDisable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckDisable</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckDisable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkDisable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaManager</span><span class="token punctuation">.</span><span class="token function">getStpLogic</span><span class="token punctuation">(</span>checkDisable<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkByAnnotation</span><span class="token punctuation">(</span>checkDisable<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckBasic 注解</span>
		<span class="token class-name">SaCheckBasic</span> checkBasic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckBasic</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckBasic</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkBasic <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaBasicUtil</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>checkBasic<span class="token punctuation">.</span><span class="token function">realm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> checkBasic<span class="token punctuation">.</span><span class="token function">account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 校验 @SaCheckOr 注解</span>
		<span class="token class-name">SaCheckOr</span> checkOr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SaCheckOr</span><span class="token punctuation">)</span> <span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>getAnnotation<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SaCheckOr</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>checkOr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">SaStrategy</span><span class="token punctuation">.</span>instance<span class="token punctuation">.</span>checkOrAnnotation<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>checkOr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="其他功能"><a href="#其他功能" class="header-anchor">#</a> 其他功能</h4> <p><strong>整合JWT</strong></p> <p>官网文档 : <a href="https://sa-token.cc/doc.html#/plugin/jwt-extend" target="_blank" rel="noopener noreferrer">https://sa-token.cc/doc.html#/plugin/jwt-extend<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>JWT结构 : header (令牌头部) + payload (令牌负荷) + signature (签名)</p> <p>完整格式 : <code>header.payload.signature</code></p> <p>配置秘钥即可生效 : sa-token.jwt-secret-key: <code>&lt;秘钥&gt;</code></p> <p>在线编解码JWT : <a href="https://jwt.io" target="_blank" rel="noopener noreferrer">https://jwt.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>也可通过Base64解码</p></blockquote> <p><strong>二级验证</strong></p> <p>在已登录的基础上在加一层校验 , 提高安全性</p> <p>官网文档 : <a href="https://sa-token.cc/doc.html#/up/safe-auth" target="_blank" rel="noopener noreferrer">https://sa-token.cc/doc.html#/up/safe-auth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>应用大致流程 :</p> <ol><li>为此业务标识(checkStr)开启允许120秒内业务通过 <code>StpUtil.openSafe(&quot;checkStr&quot; , 120)</code></li> <li>业务入口校验步骤
<ol><li>通过 <code>StpUtil.isSafe(&quot;checkStr&quot;)</code> 判断 , 在 代码段中 判断是否允许通过</li> <li>通过 <code>@SaCheckSafe(&quot;checkStr&quot;)</code> 判断 , 在 拦截器中 判断是否允许通过</li> <li>通过 <code>StpUtil.checkSafe(&quot;checkStr&quot;)</code> 校验 , 在 代码段中 校验是否允许通过 (未通过抛出异常)</li></ol></li></ol> <blockquote><p>一般情况会在接口写上注解判断是否允许通过</p></blockquote> <p><strong>账号封禁</strong></p> <p>官网文档 : <a href="https://sa-token.cc/doc.html#/up/disable" target="_blank" rel="noopener noreferrer">https://sa-token.cc/doc.html#/up/disable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="工具类应用"><a href="#工具类应用" class="header-anchor">#</a> 工具类应用</h2> <h3 id="loginhelper"><a href="#loginhelper" class="header-anchor">#</a> LoginHelper</h3> <p>虽然命名没有标识 工具的意思 , 但实质跟应用工具误差</p> <p>通常用于当前用户的相关信息</p> <table><thead><tr><th>返回</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>LoginUser</td> <td>getLoginUser()</td> <td>获取 当前用户</td></tr> <tr><td>LoginUser</td> <td>getLoginUser(String <em>token</em>)</td> <td>获取 当前用户 根据token</td></tr> <tr><td>Long</td> <td>getUserId()</td> <td>获取 当前用户ID</td></tr> <tr><td>Long</td> <td>getDeptId()</td> <td>获取 当前用户 部门ID</td></tr> <tr><td>String</td> <td>getUsername()</td> <td>获取 当前用户 名称</td></tr> <tr><td>UserType</td> <td>getUserType()</td> <td>获取 当前用户类型(PC/APP/WX)</td></tr> <tr><td>boolean</td> <td>isAdmin()</td> <td>判断 管理员</td></tr> <tr><td>boolean</td> <td>isAdmin(Long <em>userId</em>)</td> <td>判断 管理员 根据用户ID</td></tr></tbody></table> <h3 id="springutils"><a href="#springutils" class="header-anchor">#</a> SpringUtils</h3> <h3 id="dateutil"><a href="#dateutil" class="header-anchor">#</a> DateUtil</h3> <h3 id="jsonutils"><a href="#jsonutils" class="header-anchor">#</a> JsonUtils</h3> <p>顾名思义 JSON转化工具</p> <ul><li>序列化 toJsonString</li> <li>反序列化 parseObject</li></ul> <p>反序列化种类较多分别有 :</p> <table><thead><tr><th>返回</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>&lt;T&gt;</td> <td>parseObject(String <em>text</em>, Class&lt;T&gt; <em>clazz</em>)</td> <td>默认转化(不支持泛型)</td></tr> <tr><td>&lt;T&gt;</td> <td>parseObject(byte[] <em>bytes</em>, Class&lt;T&gt; <em>clazz</em>)</td> <td>字节对象转化</td></tr> <tr><td>&lt;T&gt;</td> <td>parseObject(String <em>text</em>, TypeReference&lt;T&gt; <em>typeReference</em>)</td> <td>对象转化 , 支持泛型(集合明确泛型)</td></tr> <tr><td>Dict</td> <td>parseMap(String <em>text</em>)</td> <td>Map转化</td></tr> <tr><td>List&lt;Dict&gt;</td> <td>parseArrayMap(String <em>text</em>)</td> <td>列表Map转化</td></tr> <tr><td>List&lt;T&gt;</td> <td>parseArray(String <em>text</em>, Class&lt;T&gt; <em>clazz</em>)</td> <td>List转化 , 指定泛型</td></tr></tbody></table> <p><strong>源码</strong></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonUtils</span> <span class="token punctuation">{</span>
	
    <span class="token comment">// 获取容器Bean对象</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> <span class="token constant">OBJECT_MAPPER</span> <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> <span class="token function">getObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">toJsonString</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> typeReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> typeReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Dict</span> <span class="token function">parseMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">getTypeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constructType</span><span class="token punctuation">(</span><span class="token class-name">Dict</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MismatchedInputException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 类型不匹配说明不是json</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dict</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseArrayMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">getTypeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constructCollectionType</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Dict</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseArray</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token constant">OBJECT_MAPPER</span><span class="token punctuation">.</span><span class="token function">getTypeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constructCollectionType</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试用例代码</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonUtilsTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testToJsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">&quot;小明1&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;jsonString = &quot;</span> <span class="token operator">+</span> jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseObject1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;name\&quot;:\&quot;小明\&quot;,\&quot;age\&quot;:12}&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;person = &quot;</span> <span class="token operator">+</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Person(name=小明, age=12)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// parseObject(String text, Class&lt;T&gt; clazz)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseObject2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;name\&quot;:\&quot;小明\&quot;,\&quot;age\&quot;:12}&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;person = &quot;</span> <span class="token operator">+</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Person(name=小明, age=12)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// parseObject(String text, Class&lt;T&gt; clazz)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseObject3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;name\&quot;:\&quot;小明\&quot;,\&quot;age\&quot;:12}&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;person = &quot;</span> <span class="token operator">+</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Person(name=小明, age=12)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 泛型应用</span>
    <span class="token comment">// parseObject(String text, TypeReference&lt;T&gt; typeReference)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseObject4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> arr <span class="token operator">=</span> <span class="token string">&quot;[{\&quot;name\&quot;:\&quot;小明1\&quot;,\&quot;age\&quot;:22},{\&quot;name\&quot;:\&quot;小明2\&quot;,\&quot;age\&quot;:12}]&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> peoples <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;peoples = &quot;</span> <span class="token operator">+</span> peoples<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// [Person(name=小明1, age=22), Person(name=小明2, age=12)]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// parseMap(String text)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;{\&quot;name\&quot;:\&quot;小明\&quot;,\&quot;age\&quot;:12}&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Dict</span> dict <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseMap</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;dict = &quot;</span> <span class="token operator">+</span> dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// {name=小明, age=12}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// parseArrayMap(String text)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseArrayMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> arr <span class="token operator">=</span> <span class="token string">&quot;[{\&quot;name\&quot;:\&quot;小明1\&quot;,\&quot;age\&quot;:22},{\&quot;name\&quot;:\&quot;小明2\&quot;,\&quot;age\&quot;:12}]&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dict</span><span class="token punctuation">&gt;</span></span> dicts <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseArrayMap</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;dicts = &quot;</span> <span class="token operator">+</span> dicts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// [{name=小明1, age=22}, {name=小明2, age=12}]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// parseArray(String text, Class&lt;T&gt; clazz)</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParseArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> arr <span class="token operator">=</span> <span class="token string">&quot;[{\&quot;name\&quot;:\&quot;小明1\&quot;,\&quot;age\&quot;:22},{\&quot;name\&quot;:\&quot;小明2\&quot;,\&quot;age\&quot;:12}]&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> people <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;people = &quot;</span> <span class="token operator">+</span> people<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// [Person(name=小明1, age=22), Person(name=小明2, age=12)]</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="beancopyutils"><a href="#beancopyutils" class="header-anchor">#</a> BeanCopyUtils</h3> <p>拷贝方法有 :</p> <table><thead><tr><th>方法</th> <th>返回</th></tr></thead> <tbody><tr><td>copy(T <em>source</em>, Class&lt;V&gt; <em>desc</em>)</td> <td>对象拷贝</td></tr> <tr><td>copy(T <em>source</em>, V <em>desc</em>)</td> <td>对象替换拷贝(相同属性且不为空则覆盖)</td></tr> <tr><td>copyList(List&lt;T&gt; <em>sourceList</em>, Class&lt;V&gt; <em>desc</em>)</td> <td>对象列表拷贝</td></tr> <tr><td>copyToMap(T <em>bean</em>)</td> <td>bean拷贝Map</td></tr> <tr><td>mapToBean(Map&lt;String, Object&gt; <em>map</em>, Class&lt;T&gt; <em>beanClass</em>)</td> <td>map拷贝bean</td></tr> <tr><td>mapToBean(Map&lt;String, Object&gt; <em>map</em>, T <em>bean</em>)</td> <td>map拷贝bean 对象替换拷贝</td></tr> <tr><td>mapToMap(Map&lt;String, T&gt; <em>map</em>, Class&lt;V&gt; <em>clazz</em>)</td> <td>map拷贝map</td></tr></tbody></table> <p><strong>示例测试代码 :</strong></p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestCopy</span> <span class="token punctuation">{</span>

    <span class="token comment">// 对象拷贝</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestDemo</span> testDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setTestKey</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TestDemoVo</span> copy <span class="token operator">=</span> <span class="token class-name">BeanCopyUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>testDemo<span class="token punctuation">,</span> <span class="token class-name">TestDemoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;copy = &quot;</span> <span class="token operator">+</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 对象替换拷贝</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCopy2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestDemo</span> testDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setTestKey</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TestDemoVo</span> testDemoVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemoVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemoVo<span class="token punctuation">.</span><span class="token function">setDeptId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanCopyUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>testDemo<span class="token punctuation">,</span> testDemoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;testDemoVo = &quot;</span> <span class="token operator">+</span> testDemoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 列表拷贝</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCopyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestDemo</span> testDemo1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TestDemo</span> testDemo2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestDemo</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>testDemo1<span class="token punctuation">,</span> testDemo2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestDemoVo</span><span class="token punctuation">&gt;</span></span> testDemoVos <span class="token operator">=</span> <span class="token class-name">BeanCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyList</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">TestDemoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemoVos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCopyToMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestDemo</span> testDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setTestKey</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testDemo<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> stringObjectMap <span class="token operator">=</span> <span class="token class-name">BeanCopyUtils</span><span class="token punctuation">.</span><span class="token function">copyToMap</span><span class="token punctuation">(</span>testDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringObjectMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">K</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> <span class="token class-name">V</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Map To Bean</span>
        <span class="token class-name">TestDemoVo</span> testDemoVo <span class="token operator">=</span> <span class="token class-name">BeanCopyUtils</span><span class="token punctuation">.</span><span class="token function">mapToBean</span><span class="token punctuation">(</span>stringObjectMap<span class="token punctuation">,</span> <span class="token class-name">TestDemoVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;testDemoVo = &quot;</span> <span class="token operator">+</span> testDemoVo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Map to Map</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="redisutils"><a href="#redisutils" class="header-anchor">#</a> RedisUtils</h3> <p>提供的API变化不大 , 其他方法自行看即可</p> <details class="custom-block details"><summary>点击代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 订阅发布消息
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subPub</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> channelKey <span class="token operator">=</span> <span class="token string">&quot;channelKey&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>channelKey<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> consumer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;consumer = &quot;</span> <span class="token operator">+</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>channelKey<span class="token punctuation">,</span> <span class="token string">&quot;hello world!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>channelKey<span class="token punctuation">,</span> <span class="token string">&quot;yes!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 附加通知运行</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>channelKey<span class="token punctuation">,</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">,</span> consumer <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;测试执行!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存测试
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数 : key, value</span>
<span class="token comment">//        RedisUtils.setCacheObject(&quot;name&quot;, &quot;张三&quot;);</span>
        <span class="token comment">// 参数 : key, value , ttl</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;李四&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 参数 : key, value , 保留ttl</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;王五&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置ttl
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;小明&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 10s 过期</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1天 过期</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取对象
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGetObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取值</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name = &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取TTL</span>
        <span class="token keyword">long</span> ttl <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ttl = &quot;</span> <span class="token operator">+</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除单个对象</span>
            <span class="token keyword">boolean</span> name <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name = &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 集合设置
     * Set, Map, 同理
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 区分 obj &amp; list 缓存形式</span>
        <span class="token comment">// 特性 :</span>
        <span class="token comment">//  - obj 设置 会覆盖原有的值</span>
        <span class="token comment">//  - list 设置 会追加值, 而非覆盖</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对象数组缓存, 通过string (json)</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;list1&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 集合形式缓存, 通过list</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheList</span><span class="token punctuation">(</span><span class="token string">&quot;list2&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;list1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;list1 = &quot;</span> <span class="token operator">+</span> list1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list2 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheList</span><span class="token punctuation">(</span><span class="token string">&quot;list2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;list2 = &quot;</span> <span class="token operator">+</span> list2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 原子操作
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAtom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setAtomicValue</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> num1 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getAtomicValue</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;num1 = &quot;</span> <span class="token operator">+</span> num1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> num2 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">incrAtomicValue</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;num2 = &quot;</span> <span class="token operator">+</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> num3 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">decrAtomicValue</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;num3 = &quot;</span> <span class="token operator">+</span> num3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 测试key存在
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHashKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查值是否存在</span>
        <span class="token class-name">Boolean</span> b <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b = &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查键是否存在</span>
        <span class="token keyword">boolean</span> b2 <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">isExistsObject</span><span class="token punctuation">(</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b2 = &quot;</span> <span class="token operator">+</span> b2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="streamutils"><a href="#streamutils" class="header-anchor">#</a> StreamUtils</h3> <h2 id="前端部分"><a href="#前端部分" class="header-anchor">#</a> 前端部分</h2> <h3 id="自定义指令权限标识"><a href="#自定义指令权限标识" class="header-anchor">#</a> 自定义指令权限标识</h3> <p>所谓的限制 , 就是 满足 <strong>权限/身份</strong> 的情况 显示 组件/标签 , 未满足一律不显示 .</p> <p>实现原理通过 vue 自定义指令钩子 , 定义个 用身份控制组件/标签显示状况 的钩子</p> <p>官网文档 : <a href="https://cn.vuejs.org/guide/reusability/custom-directives.html#directive-hooks" target="_blank" rel="noopener noreferrer">https://cn.vuejs.org/guide/reusability/custom-directives.html#directive-hooks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>前端核心代码</strong></p> <p>引入自定义钩子 <code>src/directive/index.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'hasRole'</span><span class="token punctuation">,</span> hasRole<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'hasPermi'</span><span class="token punctuation">,</span> hasPermi<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在main 中 Vue.use() 安装</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> install
</code></pre></div><p>hasPermi 暴露的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">inserted</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 自定义指令钩子 其值 (数组封装)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token operator">=</span> binding
    <span class="token keyword">const</span> all_permission <span class="token operator">=</span> <span class="token string">&quot;*:*:*&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 权限列表</span>
    <span class="token keyword">const</span> permissions <span class="token operator">=</span> store<span class="token punctuation">.</span>getters <span class="token operator">&amp;&amp;</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>permissions

    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value <span class="token keyword">instanceof</span> <span class="token class-name">Array</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> permissionFlag <span class="token operator">=</span> value
	  
      <span class="token comment">// 判断是否包含</span>
      <span class="token keyword">const</span> hasPermissions <span class="token operator">=</span> permissions<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">permission</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> all_permission <span class="token operator">===</span> permission <span class="token operator">||</span> permissionFlag<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
	  
      <span class="token comment">// 不包含则删除当前节点的标签</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasPermissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>parentNode <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请设置操作权限标签值</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>身份Role标识 用法也如此</p></blockquote> <p><strong>前端展示应用</strong></p> <p>全局搜索 v-hasPermi 也是可以搜索到手的</p> <p>随意截取部分也可以看到代码的约束和使用情况</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-col</span> <span class="token attr-name">:span</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">plain</span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el-icon-plus<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mini<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleAdd<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-hasPermi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>['demo:demo:add']<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>新增<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-col</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-col</span> <span class="token attr-name">:span</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">plain</span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el-icon-edit<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mini<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>single<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleUpdate<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-hasPermi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>['demo:demo:edit']<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>修改<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-col</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-col</span> <span class="token attr-name">:span</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1.5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>danger<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">plain</span>
    <span class="token attr-name">icon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el-icon-delete<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mini<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multiple<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>handleDelete<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">v-hasPermi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>['demo:demo:remove']<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-col</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="ruoyi-generator-生成代码"><a href="#ruoyi-generator-生成代码" class="header-anchor">#</a> ruoyi-generator 生成代码</h2> <h3 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h3> <p><strong>应用大致步骤</strong></p> <ol><li>导入表</li> <li>设置配置表生成下载</li> <li>导入sql</li> <li>copy 前后端</li> <li>重启项目</li></ol> <p><strong>注意 :</strong></p> <ul><li>每个表必须包含有 : <strong>create_by</strong> , create_time , update_by , update_time 字段 (高亮建议必填)</li> <li>树表 必须包含有 指向指定字段(一般用id) , 用于指向父级数据</li></ul> <h3 id="配置文件yml"><a href="#配置文件yml" class="header-anchor">#</a> 配置文件YML</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 代码生成</span>
<span class="token key atrule">gen</span><span class="token punctuation">:</span> 
  <span class="token comment"># 作者</span>
  <span class="token key atrule">author</span><span class="token punctuation">:</span> ruoyi
  <span class="token comment"># 默认生成包路径 system 需改成自己的模块名称 如 system monitor tool</span>
  <span class="token key atrule">packageName</span><span class="token punctuation">:</span> com.ruoyi.system
  <span class="token comment"># 自动去除表前缀，默认是false</span>
  <span class="token key atrule">autoRemovePre</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 表前缀（生成类名不会包含表前缀，多个用逗号分隔）</span>
  <span class="token key atrule">tablePrefix</span><span class="token punctuation">:</span> sys_
</code></pre></div><blockquote><p>根据实际情况修改配置</p></blockquote> <h3 id="web配置"><a href="#web配置" class="header-anchor">#</a> Web配置</h3> <p>每张表生成的固定配置 :</p> <ul><li>基本信息</li> <li>字段信息</li> <li>生成信息</li></ul> <h4 id="基本信息"><a href="#基本信息" class="header-anchor">#</a> 基本信息</h4> <p>无关键信息填写</p> <h4 id="字段信息"><a href="#字段信息" class="header-anchor">#</a> 字段信息</h4> <p><strong>物理类型</strong> =&gt; SQL应用的类型</p> <p><strong>Java类型</strong> =&gt; 对象属性类型</p> <p><strong>Java属性</strong> =&gt; 对象属性名称</p> <p>选定字段是否采用 插入 / 编辑 / 列表 / 查询 =&gt; 新增是否显示 / 编辑是否显示 / 列表是否显示 / 查询字段显示</p> <p><strong>查询方式</strong> : 选中查询后 , 指定SQL查询方式</p> <p><strong>显示类型</strong> : 在 编辑 / 新增 时 , 更加的方便使用</p> <p><strong>必填</strong> : 勾选后 , 插入的时候必须填写</p> <h4 id="生成信息"><a href="#生成信息" class="header-anchor">#</a> 生成信息</h4> <p><strong>单表</strong></p> <p>关注 包路径 / 模块名</p> <p><strong>树表</strong></p> <p>关注 包路径 / 模块名 / 树id字段 / 树父id字段 / 树名</p> <blockquote><p>大量数据不适合使用 , 数据分级主要通过前端分级展示</p></blockquote> <h2 id="ruoyi-oss-文件模块"><a href="#ruoyi-oss-文件模块" class="header-anchor">#</a> ruoyi-oss 文件模块</h2> <h3 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h3> <p>模块包路径 :</p> <ul><li><code>ruoyi-common/ruoyi-common-oss</code></li> <li><code>ruoyi-modules/ruoyi-system</code></li></ul> <h3 id="库相关"><a href="#库相关" class="header-anchor">#</a> 库相关</h3> <h3 id="sql"><a href="#sql" class="header-anchor">#</a> SQL</h3> <p><strong>sys_oss</strong></p> <p>存储文件的相关信息</p> <table><thead><tr><th>字段名</th> <th>类型</th> <th>规则</th> <th>说明</th></tr></thead> <tbody><tr><td>oss_id</td> <td>bigint</td> <td>NOT NULL</td> <td>对象存储主键</td></tr> <tr><td>tenant_id</td> <td>varchar(20)</td> <td>DEFAULT '000000'</td> <td>租户编号</td></tr> <tr><td>file_name</td> <td>varchar(255)</td> <td>NOT NULL DEFAULT ''</td> <td>文件名</td></tr> <tr><td>original_name</td> <td>varchar(255)</td> <td>NOT NULL DEFAULT ''</td> <td>原名</td></tr> <tr><td>file_suffix</td> <td>varchar(10)</td> <td>NOT NULL DEFAULT ''</td> <td>文件后缀名</td></tr> <tr><td>url</td> <td>varchar(500)</td> <td>NOT NULL</td> <td>URL地址</td></tr> <tr><td>create_dept</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>创建部门</td></tr> <tr><td>create_time</td> <td>datetime</td> <td>DEFAULT NULL</td> <td>创建时间</td></tr> <tr><td>create_by</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>上传人</td></tr> <tr><td>update_time</td> <td>datetime</td> <td>DEFAULT NULL</td> <td>更新时间</td></tr> <tr><td>update_by</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>更新人</td></tr> <tr><td>service</td> <td>varchar(20)</td> <td>NOT NULL DEFAULT 'minio'</td> <td>服务商</td></tr></tbody></table> <p><strong>sys_oss_config</strong></p> <p>存储供应商配置信息</p> <table><thead><tr><th>字段名</th> <th>类型</th> <th>规则</th> <th>说明</th></tr></thead> <tbody><tr><td>oss_config_id</td> <td>bigint</td> <td>NOT NULL</td> <td>主建</td></tr> <tr><td>tenant_id</td> <td>varchar(20)</td> <td>DEFAULT '000000'</td> <td>租户编号</td></tr> <tr><td>config_key</td> <td>varchar(20)</td> <td>NOT NULL DEFAULT ''</td> <td>配置key</td></tr> <tr><td>access_key</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>accessKey</td></tr> <tr><td>secret_key</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>秘钥</td></tr> <tr><td>bucket_name</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>桶名称</td></tr> <tr><td>prefix</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>前缀</td></tr> <tr><td>endpoint</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>访问站点</td></tr> <tr><td>domain</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>自定义域名</td></tr> <tr><td>is_https</td> <td>char(1)</td> <td>DEFAULT 'N'</td> <td>是否https(Y=是,N=否)</td></tr> <tr><td>region</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>域</td></tr> <tr><td>access_policy</td> <td>char(1)</td> <td>NOT NULL DEFAULT '1'</td> <td>桶权限类型(0=private 1=public 2=custom)</td></tr> <tr><td>status</td> <td>char(1)</td> <td>DEFAULT '1'</td> <td>是否默认(0=是,1=否)</td></tr> <tr><td>ext1</td> <td>varchar(255)</td> <td>DEFAULT ''</td> <td>扩展字段</td></tr> <tr><td>create_dept</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>创建部门</td></tr> <tr><td>create_by</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>创建者</td></tr> <tr><td>create_time</td> <td>datetime</td> <td>DEFAULT NULL</td> <td>创建时间</td></tr> <tr><td>update_by</td> <td>bigint</td> <td>DEFAULT NULL</td> <td>更新者</td></tr> <tr><td>update_time</td> <td>datetime</td> <td>DEFAULT NULL</td> <td>更新时间</td></tr> <tr><td>remark</td> <td>varchar(500)</td> <td>DEFAULT NULL</td> <td>备注</td></tr></tbody></table> <h3 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h3> <p>如果启动了租户功能 , 那前缀是租户的ID , 例如 000000:sys_oss</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">key</th> <th style="text-align:center;">val</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">hash</td> <td style="text-align:center;">sys_oss_config</td> <td style="text-align:center;">{configKey , &lt;oss配置信息&gt;}</td> <td style="text-align:center;">存储所有oss相关配置信息</td></tr> <tr><td style="text-align:center;">string</td> <td style="text-align:center;">sys_oss:default_config</td> <td style="text-align:center;">mino</td> <td style="text-align:center;">选中的oss</td></tr> <tr><td style="text-align:center;">hash</td> <td style="text-align:center;">sys_oss</td> <td style="text-align:center;">{}</td> <td style="text-align:center;"></td></tr></tbody></table> <blockquote><p>configKey 配置是指 {&quot;aliyun&quot;, &quot;qcloud&quot;, &quot;qiniu&quot;, &quot;obs&quot;,&quot;mino&quot;} oss供应商</p></blockquote> <h3 id="涉及接口"><a href="#涉及接口" class="header-anchor">#</a> 涉及接口</h3> <table><thead><tr><th>接口</th> <th>说明</th></tr></thead> <tbody><tr><td>GET /resource/oss/list</td> <td>分页查询</td></tr> <tr><td>GET /system/config/configKey/{configKey}</td> <td>预览开关</td></tr> <tr><td>POST /resource/oss/upload</td> <td>文件上传</td></tr> <tr><td>GET /resource/oss/listByIds/{ossIds}</td> <td>文件查询</td></tr> <tr><td>DEL /resource/oss/{ossId}</td> <td>文件删除</td></tr> <tr><td>GET /resource/oss/download/{ossId}</td> <td>文件下载</td></tr></tbody></table> <h3 id="后端"><a href="#后端" class="header-anchor">#</a> 后端</h3> <h4 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h4> <p><strong>初始化运行 <em>SysOssConfigServiceImpl.init()</em></strong></p> <ol><li>项目运行调用 init()</li> <li>获取SQL库 所有的 oss配置</li> <li>将启用 oss供应商 的存储到 Redis <code>sys_oss:default_config</code></li> <li>将所有 oss配置存储缓存 缓存组 <code>sys_oss_config</code> , key为 ConfigKey , val为 对象JOSN存储</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssConfig</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">TenantHelper</span><span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssConfig</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderByAsc</span><span class="token punctuation">(</span><span class="token class-name">TenantEntity</span><span class="token operator">::</span><span class="token function">getTenantId</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SysOssConfig</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">groupByKey</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token class-name">SysOssConfig</span><span class="token operator">::</span><span class="token function">getTenantId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> tenantId <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TenantHelper</span><span class="token punctuation">.</span><span class="token function">setDynamic</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 加载OSS初始化配置</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysOssConfig</span> config <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> configKey <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONFIG_KEY</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">CacheUtils</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheNames</span><span class="token punctuation">.</span><span class="token constant">SYS_OSS_CONFIG</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">TenantHelper</span><span class="token punctuation">.</span><span class="token function">clearDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="上传"><a href="#上传" class="header-anchor">#</a> 上传</h4> <p><strong>上传 <em>SysOssController.upload()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 上传OSS对象存储
 *
 * @param file 文件
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span><span class="token string">&quot;system:oss:upload&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;OSS对象存储&quot;</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> <span class="token class-name">BusinessType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssUploadVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 主要存储</span>
    <span class="token class-name">SysOssVo</span> oss <span class="token operator">=</span> ossService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SysOssUploadVo</span> uploadVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysOssUploadVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadVo<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadVo<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getOriginalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadVo<span class="token punctuation">.</span><span class="token function">setOssId</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getOssId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>uploadVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>上传具体实现 <em>SysOssServiceImpl.upload()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SysOssVo</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// </span>
    <span class="token class-name">String</span> originalfileName <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> suffix <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalfileName<span class="token punctuation">,</span> originalfileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originalfileName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 oss实例 </span>
    <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UploadResult</span> uploadResult<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        uploadResult <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">uploadSuffix</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> suffix<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 保存文件信息</span>
    <span class="token class-name">SysOss</span> oss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysOss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oss<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oss<span class="token punctuation">.</span><span class="token function">setFileSuffix</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oss<span class="token punctuation">.</span><span class="token function">setFileName</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    oss<span class="token punctuation">.</span><span class="token function">setOriginalName</span><span class="token punctuation">(</span>originalfileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oss<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getConfigKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>oss<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SysOssVo</span> sysOssVo <span class="token operator">=</span> <span class="token class-name">MapstructUtils</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>oss<span class="token punctuation">,</span> <span class="token class-name">SysOssVo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">matchingUrl</span><span class="token punctuation">(</span>sysOssVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>具体实现 <em>OssFactory.instance()</em></strong></p> <p>工厂类获取 oss实例</p> <ol><li>获取选中的oss (configKey) , 在Redis获取缓存 <code>sys_oss:default_config</code></li> <li>获取缓存中 oss配置信息 . 根据 configKey 得到手</li> <li>获取实例对象 , 在缓存中进行获取 , 根据出租的ID区分oss实例</li> <li>缓存中为空 , 新建实例并且</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 获取默认实例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OssClient</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取redis 默认类型</span>
    <span class="token class-name">String</span> configKey <span class="token operator">=</span> <span class="token class-name">RedisUtils</span><span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token class-name">OssConstant</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CONFIG_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>configKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OssException</span><span class="token punctuation">(</span><span class="token string">&quot;文件存储服务类型无法找到!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">instance</span><span class="token punctuation">(</span>configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 根据类型获取实例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OssClient</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token class-name">String</span> configKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">CacheUtils</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CacheNames</span><span class="token punctuation">.</span><span class="token constant">SYS_OSS_CONFIG</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OssException</span><span class="token punctuation">(</span><span class="token string">&quot;系统异常, '&quot;</span> <span class="token operator">+</span> configKey <span class="token operator">+</span> <span class="token string">&quot;'配置信息不存在!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">OssProperties</span> properties <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">OssProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用租户标识避免多个租户相同key实例覆盖</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> configKey<span class="token punctuation">;</span>
    <span class="token class-name">OssClient</span> client <span class="token operator">=</span> <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OssClient</span><span class="token punctuation">(</span>configKey<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建OSS实例 key =&gt; {}&quot;</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 配置不相同则重新构建</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">checkPropertiesSame</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OssClient</span><span class="token punctuation">(</span>configKey<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;重载OSS实例 key =&gt; {}&quot;</span><span class="token punctuation">,</span> configKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">CLIENT_CACHE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> client<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h4> <h5 id="分页查询"><a href="#分页查询" class="header-anchor">#</a> 分页查询</h5> <p><strong>分页查询 <em>SysOssController#list()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 查询OSS对象存储列表
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span><span class="token string">&quot;system:oss:list&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">TableDataInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span><span class="token class-name">QueryGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token class-name">SysOssBo</span> bo<span class="token punctuation">,</span> <span class="token class-name">PageQuery</span> pageQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> ossService<span class="token punctuation">.</span><span class="token function">queryPageList</span><span class="token punctuation">(</span>bo<span class="token punctuation">,</span> pageQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>具体实现 <em>SysOssServiceImpl#queryPageList()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TableDataInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryPageList</span><span class="token punctuation">(</span><span class="token class-name">SysOssBo</span> bo<span class="token punctuation">,</span> <span class="token class-name">PageQuery</span> pageQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOss</span><span class="token punctuation">&gt;</span></span> lqw <span class="token operator">=</span> <span class="token function">buildQueryWrapper</span><span class="token punctuation">(</span>bo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectVoPage</span><span class="token punctuation">(</span>pageQuery<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lqw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> filterResult <span class="token operator">=</span> <span class="token class-name">StreamUtils</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">matchingUrl</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">setRecords</span><span class="token punctuation">(</span>filterResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">TableDataInfo</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 封装 约束填充 */</span>
<span class="token keyword">private</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOss</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildQueryWrapper</span><span class="token punctuation">(</span><span class="token class-name">SysOssBo</span> bo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> bo<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOss</span><span class="token punctuation">&gt;</span></span> lqw <span class="token operator">=</span> <span class="token class-name">Wrappers</span><span class="token punctuation">.</span><span class="token function">lambdaQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getFileName</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getOriginalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getOriginalName</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getOriginalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getFileSuffix</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getFileSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getUrl</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;beginCreateTime&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;endCreateTime&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getCreateTime</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;beginCreateTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;endCreateTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getCreateBy</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lqw<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>bo<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SysOss</span><span class="token operator">::</span><span class="token function">getService</span><span class="token punctuation">,</span> bo<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> lqw<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>URL路径填充 <em>SysOssServiceImpl.matchingUrl()</em></strong></p> <p>一般情况下 oss存储是私有的 , 无法访问 , 需要特定的方法进行访问 , 因此需要调用此方法匹配填充url</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 匹配Url
 *
 * @param oss OSS对象
 * @return oss 匹配Url的OSS对象
 */</span>
<span class="token keyword">private</span> <span class="token class-name">SysOssVo</span> <span class="token function">matchingUrl</span><span class="token punctuation">(</span><span class="token class-name">SysOssVo</span> oss<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> oss<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 仅修改桶类型为 private 的URL，临时URL时长为180s(3min)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AccessPolicyType</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span> <span class="token operator">==</span> storage<span class="token punctuation">.</span><span class="token function">getAccessPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oss<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getPrivateUrl</span><span class="token punctuation">(</span>oss<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oss<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="指定查询"><a href="#指定查询" class="header-anchor">#</a> 指定查询</h5> <p><strong>查询 <em>SysOssController.listByIds()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 查询OSS对象基于id串
 *
 * @param ossIds OSS对象ID串
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span><span class="token string">&quot;system:oss:list&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/listByIds/{ossIds}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">listByIds</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;主键不能为空&quot;</span><span class="token punctuation">)</span>
                                   <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ossIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> ossService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>ossIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>查询具体实现 <em>SysOssServiceImpl.listByIds()</em></strong></p> <p>获取本类的代理对象 SpringUtils.getAopProxy(this) , 实现外部调用本身getById()方法 , 触发缓存注解 @Cacheable(cacheNames = CacheNames.SYS_OSS, key = &quot;#ossId&quot;)</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">listByIds</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ossIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOssVo</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> id <span class="token operator">:</span> ossIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SysOssVo</span> vo <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getAopProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">matchingUrl</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 当查询数据时, 会优先查缓存是否存在 */</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token class-name">CacheNames</span><span class="token punctuation">.</span><span class="token constant">SYS_OSS</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#ossId&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SysOssVo</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> ossId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectVoById</span><span class="token punctuation">(</span>ossId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="下载"><a href="#下载" class="header-anchor">#</a> 下载</h4> <p><strong>下载接口 <em>SysOssController.download()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 下载OSS对象
 *
 * @param ossId OSS对象ID
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span><span class="token string">&quot;system:oss:download&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/download/{ossId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> ossId<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    ossService<span class="token punctuation">.</span><span class="token function">download</span><span class="token punctuation">(</span>ossId<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>具体实现 <em>SysOssServiceImpl.download()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">download</span><span class="token punctuation">(</span><span class="token class-name">Long</span> ossId<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">SysOssVo</span> sysOss <span class="token operator">=</span> <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">getAopProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>ossId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>sysOss<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;文件数据不存在!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 响应头编码</span>
    <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">setAttachmentResponseHeader</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> sysOss<span class="token punctuation">.</span><span class="token function">getOriginalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_OCTET_STREAM_VALUE</span> <span class="token operator">+</span> <span class="token string">&quot;; charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token function">getObjectContent</span><span class="token punctuation">(</span>sysOss<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> available <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IoUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> available<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentLength</span><span class="token punctuation">(</span>available<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>文件处理工具 <em>FileUtils.setAttachmentResponseHeader()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 下载文件名重新编码
 *
 * @param response     响应对象
 * @param realFileName 真实文件名
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setAttachmentResponseHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> realFileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> percentEncodedFileName <span class="token operator">=</span> <span class="token function">percentEncode</span><span class="token punctuation">(</span>realFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> contentDispositionValue <span class="token operator">=</span> <span class="token string">&quot;attachment; filename=%s;filename*=utf-8''%s&quot;</span><span class="token punctuation">.</span><span class="token function">formatted</span><span class="token punctuation">(</span>percentEncodedFileName<span class="token punctuation">,</span> percentEncodedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Expose-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Content-Disposition,download-filename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-disposition&quot;</span><span class="token punctuation">,</span> contentDispositionValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;download-filename&quot;</span><span class="token punctuation">,</span> percentEncodedFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h4> <p><strong>删除接口 <em>SysOssController.remove()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 删除OSS对象存储
 *
 * @param ossIds OSS对象ID串
 */</span>
<span class="token annotation punctuation">@SaCheckPermission</span><span class="token punctuation">(</span><span class="token string">&quot;system:oss:remove&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;OSS对象存储&quot;</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> <span class="token class-name">BusinessType</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{ossIds}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotEmpty</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;主键不能为空&quot;</span><span class="token punctuation">)</span>
                      <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ossIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">toAjax</span><span class="token punctuation">(</span>ossService<span class="token punctuation">.</span><span class="token function">deleteWithValidByIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>ossIds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>删除具体实现 <em>SysOssServiceImpl.deleteWithValidByIds()</em></strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">deleteWithValidByIds</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 做一些业务上的校验,判断是否需要校验</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysOss</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectBatchIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysOss</span> sysOss <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OssClient</span> storage <span class="token operator">=</span> <span class="token class-name">OssFactory</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span>sysOss<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        storage<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>sysOss<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> baseMapper<span class="token punctuation">.</span><span class="token function">deleteBatchIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="minio配置"><a href="#minio配置" class="header-anchor">#</a> minio配置</h3> <p><strong>官方下载 :</strong> <a href="https://www.minio.org.cn/download.shtml" target="_blank" rel="noopener noreferrer">https://www.minio.org.cn/download.shtml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="window"><a href="#window" class="header-anchor">#</a> Window</h4> <ol><li><p>下载minio服务端 <code>minio.exe</code></p></li> <li><p>命令运行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>minio.exe server D:<span class="token punctuation">\</span>minio<span class="token punctuation">\</span>store --console-address <span class="token string">&quot;127.0.0.1:9000&quot;</span>  <span class="token parameter variable">--address</span> <span class="token string">&quot;127.0.0.1:9090&quot;</span>
</code></pre></div><blockquote><p>指定存储路径 : <code>D:\minio\store</code></p> <p>指定控制台访问地址 : <code>--console-address &quot;127.0.0.1:9000&quot;</code></p> <p>指定API访问地址 : <code>--address &quot;127.0.0.1:9090&quot;</code></p></blockquote></li> <li><p>在窗口可以看到 账号密码进入即可</p></li> <li><p>新建用户 . 记住 账号和密码</p></li> <li><p>创建 空间桶 . 侧栏 -&gt; Buckets -&gt; Create Bucket -&gt; 自行配置... (记住桶名称)</p></li></ol> <h4 id="linux"><a href="#linux" class="header-anchor">#</a> Linux</h4> <p>下载 <a href="https://www.minio.org.cn/download.shtml#/linux" target="_blank" rel="noopener noreferrer">https://www.minio.org.cn/download.shtml#/linux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li><p>新建 minio目录(根目录) <code>mkdir -p /opt/minio</code> =&gt; <code>cd /opt/minio</code></p></li> <li><p>新建存储路径 <code>mkdir data</code></p></li> <li><p>下载minio <code>wget https://dl.minio.org.cn/server/minio/release/linux-amd64/minio</code></p></li> <li><p>开放权限 <code>chmod +x minio</code> ; <code>chmod a+rw data</code></p></li> <li><p>创建 配置文件 <code>vim /opt/minio/conf/minio.conf</code></p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token key attr-name">MINIO_VOLUMES</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">/opt/minio/data</span>&quot;</span>
<span class="token key attr-name">MINIO_ROOT_USER</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">ruoyi</span>&quot;</span>
<span class="token key attr-name">MINIO_ROOT_PASSWORD</span><span class="token punctuation">=</span><span class="token value attr-value">&quot;<span class="token inner-value">ruoyi123123</span>&quot;</span>
</code></pre></div></li> <li><p>创建service 启动脚本文件 <code>vim /lib/systemd/system/minio.service</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>MinIO
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://docs.min.io
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">AssertFileIsExecutable</span><span class="token operator">=</span>/opt/minio/minio

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">WorkingDirectory</span><span class="token operator">=</span>/opt/minio

<span class="token assign-left variable">EnvironmentFile</span><span class="token operator">=</span>/opt/minio/conf/minio.conf
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/bin/bash <span class="token parameter variable">-c</span> <span class="token string">&quot;if [ -z <span class="token entity" title="\&quot;">\&quot;</span><span class="token variable">${MINIO_VOLUMES}</span><span class="token entity" title="\&quot;">\&quot;</span> ]; then echo <span class="token entity" title="\&quot;">\&quot;</span>Variable MINIO_VOLUMES not set in /opt/minio/conf/minio.conf<span class="token entity" title="\&quot;">\&quot;</span>; exit 1; fi&quot;</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/opt/minio/minio server --console-address <span class="token string">&quot;0.0.0.0:9000&quot;</span>  <span class="token parameter variable">--address</span> <span class="token string">&quot;0.0.0.0:9090&quot;</span> <span class="token variable">$MINIO_VOLUMES</span>

<span class="token comment"># Let systemd restart this service always</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always

<span class="token comment"># Specifies the maximum file descriptor number that can be opened by this process</span>
<span class="token assign-left variable">LimitNOFILE</span><span class="token operator">=</span><span class="token number">65536</span>

<span class="token comment"># Specifies the maximum number of threads this process can create</span>
<span class="token assign-left variable">TasksMax</span><span class="token operator">=</span>infinity

<span class="token comment"># Disable timeout logic and wait until process is stopped</span>
<span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span>infinity
<span class="token assign-left variable">SendSIGKILL</span><span class="token operator">=</span>no

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token comment"># Built for ${project.name}-${project.version} (${project.name})</span>
</code></pre></div></li> <li><p>服务控制</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 每次开机启动</span>
systemctl <span class="token builtin class-name">enable</span> minio.service
<span class="token comment"># 启动服务</span>
systemctl start minio
<span class="token comment"># 停止服务</span>
systemctl stop minio
<span class="token comment"># 查看服务状态</span>
systemctl status minio
<span class="token comment"># ....</span>
</code></pre></div></li> <li><p>访问即可 <code>http://&lt;IP地址&gt;:9000</code> (注意开放端口)</p></li></ol> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>防火墙打开 9000 , 9090 端口 / 关闭防火墙</li> <li>云服务器 , 开放安全组 9000 , 9090 端口</li></ul></div> <h4 id="ruoyi系统配置"><a href="#ruoyi系统配置" class="header-anchor">#</a> ruoyi系统配置</h4> <p>侧栏 -&gt; 文件管理 -&gt; 配置管理 -&gt; 选择<code>minio</code>编辑</p> <table><thead><tr><th style="text-align:center;">配置项</th> <th style="text-align:center;">值</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">配置Key</td> <td style="text-align:center;">Minio</td> <td style="text-align:center;">供应商</td></tr> <tr><td style="text-align:center;">访问站点</td> <td style="text-align:center;">127.0.0.1:9090</td> <td style="text-align:center;">外部访问的API地址</td></tr> <tr><td style="text-align:center;">自定义域名</td> <td style="text-align:center;"></td> <td style="text-align:center;">访问API域名</td></tr> <tr><td style="text-align:center;">access Key</td> <td style="text-align:center;">ruoyi</td> <td style="text-align:center;">创建的账户名</td></tr> <tr><td style="text-align:center;">secretKey</td> <td style="text-align:center;">ruoyi123</td> <td style="text-align:center;">创建的用户密码</td></tr> <tr><td style="text-align:center;">桶名称</td> <td style="text-align:center;">test</td> <td style="text-align:center;">新建空间桶名称</td></tr> <tr><td style="text-align:center;">桶类型</td> <td style="text-align:center;">private</td> <td style="text-align:center;">私有类</td></tr> <tr><td style="text-align:center;">前缀</td> <td style="text-align:center;">image</td> <td style="text-align:center;">图片地址附加前缀</td></tr> <tr><td style="text-align:center;">开启HTTPS</td> <td style="text-align:center;">否</td> <td style="text-align:center;">API地址HTTPS?</td></tr> <tr><td style="text-align:center;">域</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <h4 id="阿里云"><a href="#阿里云" class="header-anchor">#</a> 阿里云</h4> <h4 id="腾讯云"><a href="#腾讯云" class="header-anchor">#</a> 腾讯云</h4> <h4 id="七牛云"><a href="#七牛云" class="header-anchor">#</a> 七牛云</h4> <h2 id="ruoyi-log-日志模块"><a href="#ruoyi-log-日志模块" class="header-anchor">#</a> ruoyi-log 日志模块</h2> <h3 id="目录-2"><a href="#目录-2" class="header-anchor">#</a> 目录</h3> <p>模块包路径 : <code>ruoyi-common/ruoyi-common-log</code></p> <p>系统模块包路径 : <code>ruoyi-modules/ruoyi-system</code></p> <h3 id="日志运作"><a href="#日志运作" class="header-anchor">#</a> 日志运作</h3> <p><strong>运作大体流程 :</strong></p> <ol><li><p>Controller层 @Log注解方法 被 切面类LogAspect拦截</p></li> <li><p>前置处理 , 方法业务执行前 , 记录当前时间戳</p></li> <li><p>后置处理 , 方法业务执行后 , 记录方法类型等相关信息</p> <p>记录信息 : 租户id , 请求ip , 请求状态 , 请求url , 请求方法 , 接口类方法 , 请求方式 , 请求参数 , ...</p></li> <li><p>时间戳记录运行过程时长</p></li> <li><p>发布事件监听 , 异步存储数据库</p></li> <li><p>API获取IP城市地址 , 并封装存储</p></li> <li><p>写入数据库</p></li></ol> <h3 id="日志切面"><a href="#日志切面" class="header-anchor">#</a> 日志切面</h3> <p>日志通知会根据Controller层的方法携带有 <code>@Log</code> 注解实现</p> <ol><li>@Before 前置通知 : 记录当前时间戳</li> <li>@AfterReturning 后置通知 : 记录日志信息</li> <li>@AfterThrowing 异常通知 : 记录异常信息</li></ol> <h3 id="库相关-2"><a href="#库相关-2" class="header-anchor">#</a> 库相关</h3> <p><strong>sys_logininfor</strong> 日志存储表</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>sys_logininfor<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>info_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'000000'</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户账号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ipaddr<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录IP地址'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>login_location<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录地点'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>browser<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'浏览器类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>os<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'操作系统'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'登录状态（0成功 1失败）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>msg<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'提示消息'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>login_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'访问时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>info_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_sys_logininfor_s<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_sys_logininfor_lt<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>login_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'系统访问记录'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="后端-2"><a href="#后端-2" class="header-anchor">#</a> 后端</h3> <p><strong>@Log注解</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 自定义操作日志记录注解
 *
 * @author ruoyi
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">PARAMETER</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Log</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 模块
     */</span>
    <span class="token class-name">String</span> <span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 功能
     */</span>
    <span class="token class-name">BusinessType</span> <span class="token function">businessType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">BusinessType</span><span class="token punctuation">.</span><span class="token constant">OTHER</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 操作人类别
     */</span>
    <span class="token class-name">OperatorType</span> <span class="token function">operatorType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">OperatorType</span><span class="token punctuation">.</span><span class="token constant">MANAGE</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否保存请求的参数
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isSaveRequestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 是否保存响应的参数
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isSaveResponseData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 排除指定的请求参数
     */</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">excludeParamNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>LogAspect切面类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 操作日志记录处理
 *
 * @author Lion Li
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@AutoConfiguration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogAspect</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 排除敏感属性字段
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">EXCLUDE_PROPERTIES</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;oldPassword&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;newPassword&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;confirmPassword&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 计算操作消耗时间
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StopWatch</span><span class="token punctuation">&gt;</span></span> <span class="token constant">TIME_THREADLOCAL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 处理请求前执行
     */</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;@annotation(controllerLog)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">boBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">TIME_THREADLOCAL</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理完请求后执行
     *
     * @param joinPoint 切点
     */</span>
    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>pointcut <span class="token operator">=</span> <span class="token string">&quot;@annotation(controllerLog)&quot;</span><span class="token punctuation">,</span> returning <span class="token operator">=</span> <span class="token string">&quot;jsonResult&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfterReturning</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token class-name">Object</span> jsonResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleLog</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> jsonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拦截异常操作
     *
     * @param joinPoint 切点
     * @param e         异常
     */</span>
    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;@annotation(controllerLog)&quot;</span><span class="token punctuation">,</span> throwing <span class="token operator">=</span> <span class="token string">&quot;e&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfterThrowing</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleLog</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">Object</span> jsonResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token comment">// *========数据库日志=========*//</span>
            <span class="token class-name">OperLogEvent</span> operLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperLogEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setTenantId</span><span class="token punctuation">(</span><span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getTenantId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">BusinessStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 请求的地址</span>
            <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getClientIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setOperIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setOperUrl</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setOperName</span><span class="token punctuation">(</span><span class="token class-name">LoginHelper</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                operLog<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">BusinessStatus</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                operLog<span class="token punctuation">.</span><span class="token function">setErrorMsg</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 设置方法名称</span>
            <span class="token class-name">String</span> className <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> methodName <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot;()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置请求方式</span>
            operLog<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 处理设置注解上的参数</span>
            <span class="token function">getControllerMethodDescription</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> operLog<span class="token punctuation">,</span> jsonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置消耗时间</span>
            <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token constant">TIME_THREADLOCAL</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setCostTime</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发布事件保存数据库</span>
            <span class="token class-name">SpringUtils</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>operLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 记录本地异常日志</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;异常信息:{}&quot;</span><span class="token punctuation">,</span> exp<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exp<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token constant">TIME_THREADLOCAL</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取注解中对方法的描述信息 用于Controller层注解
     *
     * @param log     日志
     * @param operLog 操作日志
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getControllerMethodDescription</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> log<span class="token punctuation">,</span> <span class="token class-name">OperLogEvent</span> operLog<span class="token punctuation">,</span> <span class="token class-name">Object</span> jsonResult<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置action动作</span>
        operLog<span class="token punctuation">.</span><span class="token function">setBusinessType</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">businessType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置标题</span>
        operLog<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置操作人类别</span>
        operLog<span class="token punctuation">.</span><span class="token function">setOperatorType</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">operatorType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 是否需要保存request，参数和值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isSaveRequestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取参数的信息，传入到数据库中。</span>
            <span class="token function">setRequestValue</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> operLog<span class="token punctuation">,</span> log<span class="token punctuation">.</span><span class="token function">excludeParamNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 是否需要保存response，参数和值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isSaveResponseData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>jsonResult<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            operLog<span class="token punctuation">.</span><span class="token function">setJsonResult</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>jsonResult<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取请求的参数，放到log中
     *
     * @param operLog 操作日志
     * @throws Exception 异常
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setRequestValue</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">OperLogEvent</span> operLog<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludeParamNames<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getParamMap</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> requestMethod <span class="token operator">=</span> operLog<span class="token punctuation">.</span><span class="token function">getRequestMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">PUT</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>requestMethod<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>requestMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> params <span class="token operator">=</span> <span class="token function">argsArrayToString</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> excludeParamNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setOperParam</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">removeAny</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">,</span> <span class="token constant">EXCLUDE_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">removeAny</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">,</span> excludeParamNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            operLog<span class="token punctuation">.</span><span class="token function">setOperParam</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 参数拼装
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">argsArrayToString</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramsArray<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludeParamNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>paramsArray <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> paramsArray<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> o <span class="token operator">:</span> paramsArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFilterObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Dict</span> dict <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">parseMap</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">removeAny</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> <span class="token constant">EXCLUDE_PROPERTIES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">removeAny</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> excludeParamNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            str <span class="token operator">=</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        params<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> params<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断是否需要过滤的对象。
     * &lt;p&gt;
     * 意图 : 过滤掉文件上传请求
     * @param o 对象信息。
     * @return 如果是需要过滤的对象，则返回true；否则返回false。
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFilterObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">getComponentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Collection</span> collection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> value <span class="token operator">:</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> value <span class="token keyword">instanceof</span> <span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> value <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> value<span class="token punctuation">;</span>
                <span class="token keyword">return</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MultipartFile</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> o <span class="token keyword">instanceof</span> <span class="token class-name">MultipartFile</span> <span class="token operator">||</span> o <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span> <span class="token operator">||</span> o <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletResponse</span>
            <span class="token operator">||</span> o <span class="token keyword">instanceof</span> <span class="token class-name">BindingResult</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=ruoyi-plus" title="标签">#ruoyi-plus</a></div> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/blog/spel1/"><div>
            SpEL表达式
            <span class="title-tag">
              转载
            </span></div></a> <span class="date">10-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cb60aa/"><div>
            整合WebSocket实现聊天功能
            <!----></div></a> <span class="date">07-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/backend/40kn91/"><div>
            SpringBoot部署
            <!----></div></a> <span class="date">06-10</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="Sanscan12" title="联系" target="_blank" class="iconfont icon-weixin"></a><a href="https://github.com/Sanscan12" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/user/home?id=448156561" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span> | <a href="https://beian.miit.gov.cn/">桂ICP备2022009417号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ff8b54c0.js" defer></script><script src="/assets/js/2.b26d2d6f.js" defer></script><script src="/assets/js/115.d9d5c71e.js" defer></script>
  </body>
</html>
