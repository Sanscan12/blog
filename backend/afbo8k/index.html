<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | 柏竹</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="https://image.bozhu12.cc/myblog/Essay/favicon.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <meta name="description" content="学习足迹 , 记录生活!">
    <meta name="Sasncan12" content="柏竹博客, 个人技术博客, 前后端端 , 技术文档">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#bd93f9">
    
    <link rel="preload" href="/assets/css/0.styles.7521ea85.css" as="style"><link rel="preload" href="/assets/js/app.fc393c60.js" as="script"><link rel="preload" href="/assets/js/2.b26d2d6f.js" as="script"><link rel="preload" href="/assets/js/51.07cd59a4.js" as="script"><link rel="prefetch" href="/assets/js/10.48f8523b.js"><link rel="prefetch" href="/assets/js/100.46cdfe91.js"><link rel="prefetch" href="/assets/js/101.ad86229a.js"><link rel="prefetch" href="/assets/js/102.1b05f722.js"><link rel="prefetch" href="/assets/js/103.5b94f613.js"><link rel="prefetch" href="/assets/js/104.140bfd08.js"><link rel="prefetch" href="/assets/js/105.381e872a.js"><link rel="prefetch" href="/assets/js/106.2a6e4418.js"><link rel="prefetch" href="/assets/js/107.c1aa8a3a.js"><link rel="prefetch" href="/assets/js/108.fe47a688.js"><link rel="prefetch" href="/assets/js/109.e3acfec8.js"><link rel="prefetch" href="/assets/js/11.dd937741.js"><link rel="prefetch" href="/assets/js/110.5f66e692.js"><link rel="prefetch" href="/assets/js/111.720b9195.js"><link rel="prefetch" href="/assets/js/112.b260a449.js"><link rel="prefetch" href="/assets/js/113.227691ff.js"><link rel="prefetch" href="/assets/js/114.4961ef4a.js"><link rel="prefetch" href="/assets/js/115.4222fe1f.js"><link rel="prefetch" href="/assets/js/116.ac31431e.js"><link rel="prefetch" href="/assets/js/117.4a470b1f.js"><link rel="prefetch" href="/assets/js/118.a11c4dd4.js"><link rel="prefetch" href="/assets/js/119.d75aa935.js"><link rel="prefetch" href="/assets/js/12.8d7bd029.js"><link rel="prefetch" href="/assets/js/120.2a7b2568.js"><link rel="prefetch" href="/assets/js/121.208d5c4c.js"><link rel="prefetch" href="/assets/js/122.5a72ca80.js"><link rel="prefetch" href="/assets/js/123.a9e5ea50.js"><link rel="prefetch" href="/assets/js/124.bae7fdc8.js"><link rel="prefetch" href="/assets/js/125.dd7df30a.js"><link rel="prefetch" href="/assets/js/126.8be3d0b7.js"><link rel="prefetch" href="/assets/js/127.a36a1645.js"><link rel="prefetch" href="/assets/js/128.9a4e4b08.js"><link rel="prefetch" href="/assets/js/13.3cbeb6a6.js"><link rel="prefetch" href="/assets/js/14.7e6d262f.js"><link rel="prefetch" href="/assets/js/15.112a7fce.js"><link rel="prefetch" href="/assets/js/16.18b4c084.js"><link rel="prefetch" href="/assets/js/17.a09e38d7.js"><link rel="prefetch" href="/assets/js/18.6ec9b542.js"><link rel="prefetch" href="/assets/js/19.f2139465.js"><link rel="prefetch" href="/assets/js/20.7d782826.js"><link rel="prefetch" href="/assets/js/21.7c4e1020.js"><link rel="prefetch" href="/assets/js/22.55156cea.js"><link rel="prefetch" href="/assets/js/23.bba433ed.js"><link rel="prefetch" href="/assets/js/24.55c57c5a.js"><link rel="prefetch" href="/assets/js/25.65e92ad2.js"><link rel="prefetch" href="/assets/js/26.91e496c6.js"><link rel="prefetch" href="/assets/js/27.45c9e057.js"><link rel="prefetch" href="/assets/js/28.20d6c7ca.js"><link rel="prefetch" href="/assets/js/29.f5506360.js"><link rel="prefetch" href="/assets/js/3.80dbe20b.js"><link rel="prefetch" href="/assets/js/30.5fecd315.js"><link rel="prefetch" href="/assets/js/31.4e81dcd5.js"><link rel="prefetch" href="/assets/js/32.6ea862c0.js"><link rel="prefetch" href="/assets/js/33.7a2226f1.js"><link rel="prefetch" href="/assets/js/34.5fe9f31c.js"><link rel="prefetch" href="/assets/js/35.371d75ef.js"><link rel="prefetch" href="/assets/js/36.47833f09.js"><link rel="prefetch" href="/assets/js/37.4e28d47f.js"><link rel="prefetch" href="/assets/js/38.c948d014.js"><link rel="prefetch" href="/assets/js/39.97563f6f.js"><link rel="prefetch" href="/assets/js/4.5017c5ca.js"><link rel="prefetch" href="/assets/js/40.61fb895c.js"><link rel="prefetch" href="/assets/js/41.11ef63c0.js"><link rel="prefetch" href="/assets/js/42.826fc880.js"><link rel="prefetch" href="/assets/js/43.e21776c9.js"><link rel="prefetch" href="/assets/js/44.71f317e2.js"><link rel="prefetch" href="/assets/js/45.778708be.js"><link rel="prefetch" href="/assets/js/46.622027f3.js"><link rel="prefetch" href="/assets/js/47.dde96273.js"><link rel="prefetch" href="/assets/js/48.14e83ff7.js"><link rel="prefetch" href="/assets/js/49.af6dd49a.js"><link rel="prefetch" href="/assets/js/5.9c242416.js"><link rel="prefetch" href="/assets/js/50.17715171.js"><link rel="prefetch" href="/assets/js/52.03cdf297.js"><link rel="prefetch" href="/assets/js/53.29fe203c.js"><link rel="prefetch" href="/assets/js/54.95024366.js"><link rel="prefetch" href="/assets/js/55.84dc8b28.js"><link rel="prefetch" href="/assets/js/56.fc50fa7d.js"><link rel="prefetch" href="/assets/js/57.46f6403a.js"><link rel="prefetch" href="/assets/js/58.f483f8d0.js"><link rel="prefetch" href="/assets/js/59.e86b9cbc.js"><link rel="prefetch" href="/assets/js/6.20f6982a.js"><link rel="prefetch" href="/assets/js/60.1e9bd85e.js"><link rel="prefetch" href="/assets/js/61.ba583e40.js"><link rel="prefetch" href="/assets/js/62.fc2b6925.js"><link rel="prefetch" href="/assets/js/63.dc01aec0.js"><link rel="prefetch" href="/assets/js/64.7f32e6d8.js"><link rel="prefetch" href="/assets/js/65.b5e933d1.js"><link rel="prefetch" href="/assets/js/66.15febd53.js"><link rel="prefetch" href="/assets/js/67.60ec4d8d.js"><link rel="prefetch" href="/assets/js/68.5f206257.js"><link rel="prefetch" href="/assets/js/69.3e7e2a0e.js"><link rel="prefetch" href="/assets/js/7.c22f1339.js"><link rel="prefetch" href="/assets/js/70.3ac298ca.js"><link rel="prefetch" href="/assets/js/71.d91809f5.js"><link rel="prefetch" href="/assets/js/72.6c79cdfe.js"><link rel="prefetch" href="/assets/js/73.07c21563.js"><link rel="prefetch" href="/assets/js/74.81dc3f71.js"><link rel="prefetch" href="/assets/js/75.e1058af0.js"><link rel="prefetch" href="/assets/js/76.88e0a570.js"><link rel="prefetch" href="/assets/js/77.5cc09401.js"><link rel="prefetch" href="/assets/js/78.b4cc416d.js"><link rel="prefetch" href="/assets/js/79.294fabe8.js"><link rel="prefetch" href="/assets/js/8.7ecdce77.js"><link rel="prefetch" href="/assets/js/80.3e5d7918.js"><link rel="prefetch" href="/assets/js/81.5f2b15cb.js"><link rel="prefetch" href="/assets/js/82.58c3b865.js"><link rel="prefetch" href="/assets/js/83.614ab7e3.js"><link rel="prefetch" href="/assets/js/84.3054101d.js"><link rel="prefetch" href="/assets/js/85.ec897d3a.js"><link rel="prefetch" href="/assets/js/86.d1815d1f.js"><link rel="prefetch" href="/assets/js/87.c59d98af.js"><link rel="prefetch" href="/assets/js/88.a365c83a.js"><link rel="prefetch" href="/assets/js/89.d66a597c.js"><link rel="prefetch" href="/assets/js/9.63af6ecb.js"><link rel="prefetch" href="/assets/js/90.aa1fa506.js"><link rel="prefetch" href="/assets/js/91.2797a549.js"><link rel="prefetch" href="/assets/js/92.2a3eed45.js"><link rel="prefetch" href="/assets/js/93.5a92e344.js"><link rel="prefetch" href="/assets/js/94.0426a03d.js"><link rel="prefetch" href="/assets/js/95.7a76355f.js"><link rel="prefetch" href="/assets/js/96.f816ec50.js"><link rel="prefetch" href="/assets/js/97.2bed892c.js"><link rel="prefetch" href="/assets/js/98.336b8bdc.js"><link rel="prefetch" href="/assets/js/99.9a646947.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7521ea85.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://image.bozhu12.cc/myblog/Essay/hendImage01.jpg" alt="柏竹" class="logo"> <span class="site-name can-hide">柏竹</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li><li class="dropdown-item"><!----> <a href="/say/say2023/" class="nav-link">说说</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://image.bozhu12.cc/myblog/Essay/favicon.ico"> <div class="blogger-info"><h3>柏竹</h3> <span>奋斗柏竹</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li><li class="dropdown-item"><!----> <a href="/say/say2023/" class="nav-link">说说</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaWeb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>拓展技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架技术</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/60chrc/" class="sidebar-link">Maven</a></li><li><a href="/backend/60chrp/" class="sidebar-link">Activiti</a></li><li><a href="/backend/40kn38/" class="sidebar-link">Shiro</a></li><li><a href="/backend/afbo81/" class="sidebar-link">Dubbo</a></li><li><a href="/backend/afbo8k/" aria-current="page" class="active sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/backend/afbo8k/#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#mq特性" class="sidebar-link">MQ特性</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#可靠性" class="sidebar-link">可靠性</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#顺序性" class="sidebar-link">顺序性</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#幂等性" class="sidebar-link">幂等性</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#mq分类" class="sidebar-link">MQ分类</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#activemq" class="sidebar-link">ActiveMQ</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#kafka" class="sidebar-link">Kafka</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#rocketmq" class="sidebar-link">RocketMQ</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#rabbitmq-学习" class="sidebar-link">RabbitMQ (学习)</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#web管理" class="sidebar-link">Web管理</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#安装-2" class="sidebar-link">安装</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#用户管理" class="sidebar-link">用户管理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/afbo8k/#核心" class="sidebar-link">核心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#简单模式-hello-world" class="sidebar-link">简单模式 Hello World</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#工具类优化" class="sidebar-link">工具类优化</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#工作模式-work-queues" class="sidebar-link">工作模式 Work queues</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#轮询分发" class="sidebar-link">轮询分发</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#消息应答" class="sidebar-link">消息应答</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#自动应答" class="sidebar-link">自动应答</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#手动应答" class="sidebar-link">手动应答</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#持久化" class="sidebar-link">持久化</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#队列持久化" class="sidebar-link">队列持久化</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#消息持久化" class="sidebar-link">消息持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#信道堆积" class="sidebar-link">信道堆积</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#发布确认模式-publisher-confirms" class="sidebar-link">发布确认模式 Publisher Confirms</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#发布-订阅-模式-publish-subscribe" class="sidebar-link">发布/订阅 模式 Publish/Subscribe</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#交换机-exchange" class="sidebar-link">交换机 Exchange</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#临时队列" class="sidebar-link">临时队列</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#绑定-binding" class="sidebar-link">绑定 binding</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#direct" class="sidebar-link">direct</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#topic" class="sidebar-link">topic</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#fnout" class="sidebar-link">fnout</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码实战" class="sidebar-link">代码实战</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#direct点对点测试" class="sidebar-link">direct点对点测试</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#topic发布订阅" class="sidebar-link">topic发布订阅</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#广播-fnout" class="sidebar-link">广播 fnout</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/afbo8k/#进阶" class="sidebar-link">进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#死信队列" class="sidebar-link">死信队列</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#测试" class="sidebar-link">测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#整合springboot" class="sidebar-link">整合SpringBoot</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#快速入门" class="sidebar-link">快速入门</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#操作对象" class="sidebar-link">操作对象</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#消费者" class="sidebar-link">消费者</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#延迟队列" class="sidebar-link">延迟队列</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#应用方式" class="sidebar-link">应用方式</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码示例" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码测试" class="sidebar-link">代码测试</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#插件拓展" class="sidebar-link">插件拓展</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#应用方式-2" class="sidebar-link">应用方式</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#代码示例-2" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header level5"><a href="/backend/afbo8k/#代码测试-2" class="sidebar-link">代码测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#发布确认高级" class="sidebar-link">发布确认高级</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码示例-3" class="sidebar-link"></a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码测试-3" class="sidebar-link">代码测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#回退消息" class="sidebar-link">回退消息</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码示例-4" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码测试-4" class="sidebar-link">代码测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#备用交换机" class="sidebar-link">备用交换机</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码示例-5" class="sidebar-link">代码示例</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#代码测试-5" class="sidebar-link">代码测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#队列优先级" class="sidebar-link">队列优先级</a></li><li class="sidebar-sub-header level4"><a href="/backend/afbo8k/#测试-2" class="sidebar-link">测试</a></li><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#惰性队列" class="sidebar-link">惰性队列</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/afbo8k/#集群" class="sidebar-link">集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/afbo8k/#docker" class="sidebar-link">Docker</a></li></ul></li></ul></li><li><a href="/backend/6nss7s/" class="sidebar-link">Netty网络通信</a></li><li><a href="/other/ceats1/" class="sidebar-link">Canal</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringClound</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/backend/#后端" data-v-06225672>后端</a></li><li data-v-06225672><a href="/backend/#框架技术" data-v-06225672>框架技术</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>柏竹</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-03-10</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">RabbitMQ<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>RabbitMQ 是个中间件 , 负责 接收/存储/转发 消息数据 . 类似 平时快递派送的过程</p> <p><strong>是什么?</strong></p> <p>MQ 本质是个队列 , 先进先出 消息推送 , 是种跨进程通信机制的上下游传递消息 . 主要解决不同对象通信的序列</p> <p><strong>为什么用?</strong></p> <ul><li><strong>流量消锋 :</strong> 如果系统最大多处理1W条请求 , 且还是高峰期的时候 , 很有可能会突破1W导致宕机 .
MQ可以队列缓冲 , 防止宕机 (高峰期体验差 , 但能保障了不会宕机)</li> <li><strong>应用解耦 :</strong> 系统有多个子系统 , 在业务涉及多个子系统完成时 , 当中的一个子系统宕机了 , 导致该业务异常无法运作 .
MQ可以将要处理的业务缓存到消息队列中 , 由消息队列进行访问子系统执行业务 , 防止不一致运作问题 , 提高可用性</li> <li><strong>异步处理 :</strong> 假如 A调用B , 但B需要执行很长一段时间 , 但A想知道B执行的进度 , 以往 会通过 A调用API查B进度 , 显然不优雅 .
MQ可以使用消息总线 , A调用B后 , MQ会监控B进度(A实时得到B进度) , B处理完后 会发消息给MQ , 由MQ转发至A .</li></ul> <h3 id="mq特性"><a href="#mq特性" class="header-anchor">#</a> MQ特性</h3> <h4 id="可靠性"><a href="#可靠性" class="header-anchor">#</a> 可靠性</h4> <p>消息丢失一般有3情况 :</p> <ul><li><strong>生产者丢失</strong>
通过 [发布确认](#发布确认模式 Publisher Confirms) , 确保 生产者 发送消息到MQ (<a href="#%E5%8F%91%E5%B8%83%E7%A1%AE%E8%AE%A4%E9%AB%98%E7%BA%A7">SpringBoot应用</a></li> <li><strong>MQ丢失</strong>
通过 <a href="#%E6%8C%81%E4%B9%85%E5%8C%96">持久化</a>/<a href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97">死信队列</a>/<a href="#%E5%A4%87%E7%94%A8%E4%BA%A4%E6%8D%A2%E6%9C%BA">备用交换机</a>/<a href="#%E5%9B%9E%E9%80%80%E6%B6%88%E6%81%AF">回退消息</a> , 确保消息在MQ中不会丢失</li> <li><strong>消费者丢失</strong>
通过 <a href="#%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94">消息应答</a> , 确保 消费者 消费成功ack响应</li></ul> <h4 id="顺序性"><a href="#顺序性" class="header-anchor">#</a> 顺序性</h4> <ul><li>1个消费者消费1个队列是没有顺序问题的</li> <li>多个消费者消费同一个队列时就出现消费顺序的问题 . 可以考虑将一个队列分为多个队列 , 将需要保证顺序的消息发到一个队列里 , 一个队列对应一个消费者</li> <li>当消息在消费者端用多线程处理时 , 也会出现顺序问题 . 可以考虑在内存中维护多个队列 , 将MQ发来的需要保证顺序的消息放在同一个内存队列里 , 然后一个线程处理一个队列里的消息</li></ul> <h4 id="幂等性"><a href="#幂等性" class="header-anchor">#</a> 幂等性</h4> <p>保证一条消息不会被重复消费 , 也不会对数据库产生影响</p> <p><strong>场景 :</strong></p> <ul><li>手机验证码 , 只能使用一次 , 再次发送验证码 , 则会刷新原旧的验证码</li> <li>订单支付 , 每个订单只能支付一次</li></ul> <p>**解决方案 : **</p> <ul><li>消息使用 全局ID (可 通过时间戳/UUID等方式) , 确保唯一性 , 当写入数据时先判断是否存在 , 存在就没必要插入了 , 保证了不会重复插入现象</li> <li>采用 Redis 自带的天然幂等性 <code>setnx</code></li></ul> <p><strong>参考文章 :</strong> https://blog.csdn.net/zw791029369/article/details/109561457</p> <h3 id="mq分类"><a href="#mq分类" class="header-anchor">#</a> MQ分类</h3> <h4 id="activemq"><a href="#activemq" class="header-anchor">#</a> ActiveMQ</h4> <p><strong>优点 :</strong> 单机 万级吞吐量 , 时效性s级 , 可用性高 , 基于主从架构实现高可用性 , 消息可靠性较低的概率丢失数据
<strong>缺点 :</strong> 官方社区对 ActiveMQ5.x 维护越来越少 , 高吞吐量场景较少使用</p> <h4 id="kafka"><a href="#kafka" class="header-anchor">#</a> Kafka</h4> <p>Kafka是大数据消息的中间件 , 满受大厂的采纳</p> <p><strong>优点 :</strong> 单机 百万级吞吐量 , 时效性ms级 , 运作稳定 ; 分布式 , 少数宕机 , 也不会造成影响 . 消息有序 , 有UI管理页面 , 日志实时更新</p> <p><strong>缺点 :</strong> 单机超过64个队列 , 消息队列多 , 响应长 (轮询) , 实时性取决轮询间隔 , 业务失败不能重试 , 社区更新慢</p> <h4 id="rocketmq"><a href="#rocketmq" class="header-anchor">#</a> RocketMQ</h4> <p>自 阿里巴巴 开源产品 , Java实现 , 参考了 Kafka设计 的改进版</p> <p><strong>优点 :</strong> 单机 十万级吞吐量 , 可用性高 , 分布式架构 , 消息0丢失 , 支持 10亿级别的消息堆积 , 数据堆积不会影响性能</p> <p><strong>缺点 :</strong> 语言拓展少 , 现阶段Java/C++实现 , 社区活跃一般</p> <h4 id="rabbitmq-学习"><a href="#rabbitmq-学习" class="header-anchor">#</a> RabbitMQ (学习)</h4> <p>是当前主流的消息中间件之一</p> <p><strong>优点 :</strong> 高并发 , 性能高 , 单机万级吞吐量 , 跨平台 , 多语言支持 , 文档齐全 , 社区活跃高 , 更新频繁</p> <p><strong>缺点 :</strong> 商业收费 , 学习成本高</p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p><strong>官方 :</strong> https://www.rabbitmq.com/download.html</p> <p><strong>下载</strong></p> <ul><li>MQ : <a href="https://github.com/rabbitmq/rabbitmq-server/releases" target="_blank" rel="noopener noreferrer">RabbitMQ 下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 选择以 <code>noarch.rpm</code> 结尾的安装包</li> <li>Erlang : <a href="https://packagecloud.io/app/rabbitmq/erlang/search" target="_blank" rel="noopener noreferrer">Erlang 下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , <code>Erlang</code> 和 <code>RabbitMQ</code> <a href="https://www.rabbitmq.com/which-erlang.html" target="_blank" rel="noopener noreferrer">版本对照<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (MQ采用Erang语言开发 , 因此需要安装环境)</li></ul> <blockquote><p>注意Linux版本支持</p></blockquote> <p>**安装步骤 : **</p> <ol><li><p>Linux上传文件 , 创建目录文件放置里面
==mkdir /usr/local/rabbitmq==</p></li> <li><p>安装 Erlang , RabbitMQ , socat(MQ依赖插件)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Erlang</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> erlang-21.3-1.el7.x86_64.rpm
	<span class="token comment"># 检查版本 quit退出</span>
	erl <span class="token parameter variable">-v</span>
<span class="token comment"># socat 依赖插件</span>
yum <span class="token function">install</span> socat <span class="token parameter variable">-y</span>
<span class="token comment"># RabbitMQ</span>
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> rabbitmq-server-3.8.8-1.el7.noarch.rpm
	<span class="token comment"># 启动服务</span>
	systemctl start rabbitmq-server
	<span class="token comment"># 查看服务状态 (active绿色表示成功)</span>
	systemctl status rabbitmq-server
</code></pre></div></li></ol> <h3 id="web管理"><a href="#web管理" class="header-anchor">#</a> Web管理</h3> <p>方便 查阅/操作 MQ</p> <h4 id="安装-2"><a href="#安装-2" class="header-anchor">#</a> 安装</h4> <ol><li>执行指令安装
==rabbitmq-plugins enable rabbitmq_management==</li> <li>重启MQ服务</li> <li>Web访问 http://ip:15672 (IP为 Linux地址)</li> <li>账号密码为 <code>guest</code> (账号密码相同)</li> <li>在终端中添加账号 , 并且给予权限</li></ol> <p><strong>注意 :</strong></p> <ul><li>安装前提关闭MQ服务</li> <li>Linux防火墙开放 15672端口(Web管理) , 5672端口(API连接)</li></ul> <h4 id="用户管理"><a href="#用户管理" class="header-anchor">#</a> 用户管理</h4> <p><strong>创建用户</strong>
==rabbitmqctl add_user &lt;用户名&gt; &lt;密码&gt;==</p> <p><strong>查看用户</strong>
==rabbitmqctl list_users==</p> <p><strong>修改密码</strong>
==rabbitmqctl change_password &lt;用户名&gt; &lt;新密码&gt;==</p> <p><strong>删除用户</strong></p> <p>==rabbitmqctl delete_user &lt;用户名&gt;==</p> <p><strong>设置用户</strong>
==rabbitmqctl set_user_tags &lt;用户名&gt; &lt;角色&gt;==</p> <table><thead><tr><th>角色</th> <th>说明</th></tr></thead> <tbody><tr><td><code>administrator</code></td> <td>可以登录控制台、查看所有信息、并对rabbitmq进行管理</td></tr> <tr><td><code>monToring</code></td> <td>监控者；登录控制台，查看所有信息</td></tr> <tr><td><code>policymaker</code></td> <td>策略制定者；登录控制台指定策略</td></tr> <tr><td><code>managment</code></td> <td>普通管理员；登录控制</td></tr></tbody></table> <p><strong>权限分配</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 为用户添加资源权限，添加配置、写、读权限</span>
<span class="token comment"># rabbitmqctl set_permissions [-p &lt;vhostpath&gt;] &lt;user&gt; &lt;conf&gt; &lt;write&gt; &lt;read&gt;</span>
rabbitmqctl set_permissions <span class="token parameter variable">-p</span> <span class="token string">&quot;/&quot;</span> bozhu <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>
</code></pre></div><h2 id="核心"><a href="#核心" class="header-anchor">#</a> 核心</h2> <p><strong>官方JavaAPI文档 :</strong> https://rabbitmq.github.io/rabbitmq-java-client/api/current/</p> <p>以下几大模式通过 Java API实现 , 模式的发送过程 , 在项目中需要引入以下依赖</p> <details class="custom-block details"><summary>点击查看 Maven配置</summary> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--rabbitmq 依赖客户端--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--操作文件流的一个依赖--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--指定 jdk 编译版本--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></details> <h3 id="简单模式-hello-world"><a href="#简单模式-hello-world" class="header-anchor">#</a> 简单模式 Hello World</h3> <p>Java API实现 , 模拟发送接收过程</p> <p><strong>基本方法</strong></p> <table><thead><tr><th>返回</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>-</td> <td>==queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete,  Map&lt;String, Object&gt; arguments)==</td> <td>发送消息</td></tr> <tr><td>String</td> <td>==basicConsume(String queue, boolean autoAck, DeliverCallback deliverCallback, CancelCallback cancelCallback)==</td> <td>接收消息 , 返回消息序列号</td></tr></tbody></table> <p><strong>实现步骤 :</strong></p> <ol><li><p><strong>消息生产者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token comment">// 队列名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUERY_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 发消息</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 基础信息</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.186.128&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;bozhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 频道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/**
         * 生成队列
         * 参数 :
         *  1. 队列名称
         *  2. 队列消息是否持久化(是否磁盘存储)
         *  3. 队列是否进行消息共享(多个消费者共享)
         *  4. 是否自动删除(最后消费者开端连接后)
         *  5. 其他参数
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发消息</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 发送消息
         *  1. 指定交换机
         *  2. 路由key值(本次队列名称)
         *  3. 其他参数信息
         *  4. 发送消息的消息体
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;send Success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details></li> <li><p><strong>消息消费者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUERY_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 连接工厂</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 基础信息</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.186.128&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;bozhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 频道</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 接收消息
         *  1. 指定队列
         *  2. 成功后是否自动应答
         *  3. 未成功回调信息
         *  4. 取消回调信息
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息被中断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details></li> <li><p><strong>测试</strong> , 运行 <strong>生产者</strong> =&gt; Web查看业务队列 =&gt; 运行 <strong>消费者</strong> =&gt; Web查看业务队列</p></li></ol> <p>以上步骤中看出 生产者在运行后 , Web管理中可以看到队列新增了条 消息 (需要等待消费者消费) . 当消费者运行后会消耗掉该 消息</p> <blockquote><p>消费者类 不能用 junit测试 接口写 , 否则没有监听的效果</p></blockquote> <h4 id="工具类优化"><a href="#工具类优化" class="header-anchor">#</a> 工具类优化</h4> <p>实现复用 , 减少代码重写</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMqUtils</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Channel</span> <span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.186.128&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;bozhu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> channel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h3 id="工作模式-work-queues"><a href="#工作模式-work-queues" class="header-anchor">#</a> 工作模式 Work queues</h3> <p>工作模式 主要思想是为了避免消息密集型的形式堆积 , 工作模式可以在多线程消费者中进行分发任务</p> <h4 id="轮询分发"><a href="#轮询分发" class="header-anchor">#</a> 轮询分发</h4> <p>轮询消费队列中的数据 , 消费者们会轮询进行消费消息 (每个消息只能被消费一次)</p> <p><strong>大致实现 :</strong></p> <ol><li>批发生产者</li> <li>多线程消费者</li> <li>运行测试 , 查看消费者的消费情况</li></ol> <blockquote><p>利用上面的 工具类 获取频道 (复用代码)</p></blockquote> <p><strong>生产者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token comment">// 队列名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUERY_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 发消息</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发消息</span>
            <span class="token class-name">String</span> str <span class="token operator">=</span> msg <span class="token operator">+</span> i<span class="token punctuation">;</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功 =&gt; &quot;</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <p>服务形式多线程运行 , 可以区分出 消费者分别为 <code>C1</code>/<code>C2</code>/<code>C3</code> , 在当中配置字符 , 来区分消费者</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUERY_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&quot; 已运行!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUERY_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;成功 =&gt;&quot;</span><span class="token operator">+</span>consumerTag<span class="token operator">+</span><span class="token string">&quot; : &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p><strong>运行测试</strong></p> <p>先运行所有 生产者(此时消费者会处于等待消费的状态) , 后运行 消费者 , 运行后可以看出消费者消费方式是轮询形式的</p> <p><strong>多服务运行 <a name="多服务运行">*</a></strong></p> <p>main方法运行会传递 <code>args</code> 参数 , 我们可以在以下进行传参运行</p> <ol><li>配置好 , 填充参数 (如果多参数需要空格分开)
<img src="https://image.bozhu12.cc/myblog/rabbitmq/rabbitmq09.png" style="zoom:67%;"></li> <li>打开服务(Alt+8) , 批量运行
<img src="https://image.bozhu12.cc/myblog/rabbitmq/rabbitmq10.png" alt="image-20230227222618814"></li></ol> <h4 id="消息应答"><a href="#消息应答" class="header-anchor">#</a> 消息应答</h4> <p>为了保证发送过程不丢失信息 , MQ引入了消息应答机制 . 例如 : 注册账号 , 填写表单信息 , 确认提交的过程</p> <p><strong>应答机制 :</strong> 在消费者消耗处理后 , 才会告诉 MQ 进行删除消息</p> <p>MQ有两种应答机制 :</p> <ul><li>自动应答(默认)</li> <li>手动应答</li></ul> <p>可以在 ==Channel.basicConsume()== 方法的 autoAck参数 进行控制 手动/自动</p> <blockquote><p>一般情况建议选择手动应答 , 防止数据丢失问题</p></blockquote> <h5 id="自动应答"><a href="#自动应答" class="header-anchor">#</a> 自动应答</h5> <p>自动应答 是为了解决 <strong>高吞吐/安全传输</strong> 方面做出了权衡 .</p> <p>MQ不在乎消费者是否处理完成 , 都会告诉MQ删除队列 .</p> <p><strong>情况 :</strong></p> <ul><li>消费者 处理失败也没有异常 , 会 自动补偿 , MQ会重新向消费者投递消息</li> <li>消费者 异常了 , MQ会认为消费成功 , 会对消息进行删除 , 导致数据丢失</li></ul> <blockquote><p>**重新入队机制 : **</p> <p>消费者处理消息过程 , 突然宕机 , 没有ack确认 , MQ得知消息未完全处理 , 会将其消息重新排队列 , 由其他消费者处理</p></blockquote> <h5 id="手动应答"><a href="#手动应答" class="header-anchor">#</a> 手动应答</h5> <p>手动应答 , 消费者处理后 , 两种可能 :</p> <ul><li>消费者手动 <code>ack</code>(确认应答) , 告诉MQ消息完成进行删除</li> <li>消费者自动 <code>nack</code>(拒绝应答) , 告诉MQ处理失败 , 消息不会删除</li></ul> <p><strong>应答方法</strong></p> <table><thead><tr><th>返回</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>void</td> <td>==basicAck(long deliveryTag, boolean multiple)==</td> <td>确认收到</td></tr> <tr><td>void</td> <td>==basicReject(long deliveryTag, boolean requeue)==</td> <td>拒绝消息</td></tr> <tr><td>void</td> <td>==basicNack(long deliveryTag, boolean multiple, boolean requeue)==</td> <td>拒绝收到</td></tr></tbody></table> <p><strong>手动应答 和 重入队列机制 代码实例</strong></p> <p><strong>生产者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消息在手动应答是不丢失、放回队列中重新消费
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;ack_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明对队列</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Scanner</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>sc<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息 =&gt; &quot;</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <p><strong>说明 :</strong> 配置两个消费者 , 一个消费者等待1s ; 另一个消费者等待10s . 参数分别是 :</p> <ul><li>==c1 1000==</li> <li>==c2 10000==</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;ack_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param args [线程名 , 休眠执行时长]
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&quot; : 运行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">// 等待</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接受到的消息:&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/*
             * 手动应答
             * 1.消息的标记Tag
             * 2.是否批量应答 false表示不批量应答信道中的消息
             */</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>宕机模拟测试</strong></p> <p>先运行 生产者 , 后运行2个消费者 , 最后生产者输入消息 , 以时间线来分析运作过程</p> <table><thead><tr><th>时间</th> <th>生产者</th> <th>消费者1(1s)</th> <th>消费者2(10s)</th></tr></thead> <tbody><tr><td>5s</td> <td>发送 11 ; 发送22</td> <td>收到11-&gt;ack</td> <td></td></tr> <tr><td>10s</td> <td>-</td> <td></td> <td>收到22-&gt;ack</td></tr> <tr><td>15s</td> <td>发送 33 : 发送44</td> <td>收到33-&gt;ack</td> <td>收到44-&gt;...(关闭)</td></tr> <tr><td>16s</td> <td></td> <td>收到44-&gt;ack</td> <td></td></tr></tbody></table> <h4 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h4> <p>持久化是将队列数据存储到磁盘中 , 并非在内存中 . 哪怕宕机停掉 , 不至于数据丢失的情况</p> <h5 id="队列持久化"><a href="#队列持久化" class="header-anchor">#</a> 队列持久化</h5> <p>在队列声明<code>queueDeclare</code>方法 中的第二个参数设为 <code>true</code> , 启动 队列持久化</p> <p>==queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments)==</p> <p><strong>注意 :</strong></p> <ul><li>原先队列中有非持久化 , 且队列名相同 , 那么会抛出错误 , 需要删除原先队列 , 并重新声明</li> <li>队列持久化 , 并不能进行对队列中的消息进行持久化</li></ul> <h5 id="消息持久化"><a href="#消息持久化" class="header-anchor">#</a> 消息持久化</h5> <p>在消息发送的<code>basicPublish</code>方法 中的第二个参数设为 <code>MessageProperties.PERSISTENT_TEXT_PLAIN</code> , 启动 队列持久化</p> <p>==basicPublish(String exchange, String routingKey, boolean mandatory, BasicProperties props, byte[] body)==</p> <blockquote><p>代码复用上面的即可 , 无需展示!</p></blockquote> <h4 id="信道堆积"><a href="#信道堆积" class="header-anchor">#</a> 信道堆积</h4> <p>信道堆积 是指MQ发送到消费者的信道消息堆积数(缓冲区) . 缓冲区中默认情况是可以无限堆积的 , 因此需要自行控制堆积数 , 以防不必要的消息等待处理</p> <p>信道堆积主要通过 ==basicQos(prefetchCount)==方法 控制信道堆积数(默认0-&gt;无限)</p> <p><strong>情况测试</strong></p> <p>当生产者大量生产消息 , 且又有多个消费者(效率不同)时 :</p> <ul><li>未指定堆积数 : 处理慢的消费者会堆积多个消息等待处理 , 处理快的可能会处于闲置状态</li> <li>指定堆积数 : 处理慢的消费者 , 当消息堆积到达指定数值 , 轮询分发消息会跳过该消费者</li></ul> <blockquote><p>轮询分发 : 会将所有消息平均分发被每个消费者中 , 等待消费</p> <p>默认情况下每条信道能够堆积无数条</p></blockquote> <p><strong>注意 :</strong></p> <ul><li>应答需要设为 手动应答 , 否则qos , 不会生效</li></ul> <h3 id="发布确认模式-publisher-confirms"><a href="#发布确认模式-publisher-confirms" class="header-anchor">#</a> 发布确认模式 Publisher Confirms</h3> <p>发布确认 是保证了消息完好的推送到MQ队列中 , 确保数据不会丢失 , 以便消费者消费使用</p> <p><strong>大致步骤 :</strong></p> <ol><li>获取信道</li> <li>信道启动 发布确认模式 ==confirmSelect()==方法</li> <li>向MQ推送消息 ==basicPublish()==方法</li> <li>向MQ发送确认 ==waitForConfirms()==方法</li></ol> <p><strong>异步发布 走以下步骤</strong></p> <ol start="5"><li>MQ返回状态 至 监听器 进行回调 <code>ack</code>/<code>nack</code> (成功/失败)</li> <li>失败重新推送 (回至步骤3操作)</li></ol> <p><strong>主要方法</strong></p> <table><thead><tr><th>返回</th> <th>方法</th> <th>说明</th></tr></thead> <tbody><tr><td>void</td> <td>==confirmSelect()==</td> <td>启动 发布确认模式</td></tr> <tr><td>boolean</td> <td>==waitForConfirms()==</td> <td>向MQ发送 发布确认</td></tr> <tr><td>ConfirmListener</td> <td>==addConfirmListener(ConfirmCallback ackCallback, ConfirmCallback nackCallback)==</td> <td>监听器 , 监听发布状态 成功/失败 , 以lambda形式 回调它们</td></tr></tbody></table> <p><strong>确认发布 可分为以下类型 :</strong></p> <ul><li><strong>单体</strong>
同步等待确认 , 简单 , 吞吐量有限</li> <li><strong>批量</strong>
批量同步等待确认 , 简单 , 一旦出问题难以判断</li> <li><strong>异步</strong>
高性能 , 采用 监听器监听发布状态 和 <code>ConcurrentSkipListMap</code>哈希表 多线程管理 , 能够准确异常</li></ul> <p><strong>耗时 :</strong> 单体 &gt; 批量 &gt; 异步</p> <p><strong>三种模式代码示例 :</strong></p> <p><strong>秒表工具类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 秒表计时工具
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StopWatchUtils</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> totalTime<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        totalTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getTotalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> totalTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试耗时</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 1000条消息发布测试
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">MSG_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 单体发布测试 (耗时 =&gt; 1391ms</span>
        <span class="token comment">//publishMesIndividually();</span>
        <span class="token comment">// 批量发布测试 (耗时 =&gt; 85ms</span>
        <span class="token comment">//publishMesBatch();</span>
        <span class="token comment">// 异步发布测试 (耗时 =&gt; 28ms</span>
        <span class="token function">publishMesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 异步发布
     * 只管发 , 成功/失败 由监听器管
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">publishMesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列声明 (持久化</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动确认发布</span>
        chanel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          线程安全有序的哈希表 , 使用高并发情况
            - 轻松记录 序号与消息 的关联
            - 通过序号轻松批量删除条目
            - 支持多线程
         */</span>
        <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> outstandingConfirms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
          监听器 (监听消息是否成功)
          参数1: 消息确认回调
          参数2: 消息失败回调
            - deliveryTag 消息标记
            - multiple 是否批量
         */</span>
        chanel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 是否批量</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 获取已经确认的视图</span>
                        <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> confirmed <span class="token operator">=</span> outstandingConfirms<span class="token punctuation">.</span><span class="token function">headMap</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 清除视图内容</span>
                        confirmed<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 直接删除序号</span>
                        outstandingConfirms<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;确认消息 =&gt; &quot;</span> <span class="token operator">+</span> deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> msg <span class="token operator">=</span> outstandingConfirms<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;失败消息[&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;] =&gt; &quot;</span> <span class="token operator">+</span> deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token constant">MSG_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;msg =&gt; &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 存下所有 生产者发送的消息 K(消息序列号):V(消息内容)</span>
            outstandingConfirms<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>chanel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">getTotalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 批量发布
     * 发布多个确认一次
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">publishMesBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列声明 (持久化</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动确认发布</span>
        chanel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 批单位</span>
        <span class="token keyword">int</span> batchSize <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token constant">MSG_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;msg =&gt; &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> batchSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chanel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第&quot;</span> <span class="token operator">+</span> i <span class="token operator">/</span> batchSize <span class="token operator">+</span> <span class="token string">&quot;批发送成功&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">getTotalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单体发布
     * 发布一次确认一次
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">publishMesIndividually</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列声明 (持久化</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 启动确认发布</span>
        chanel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">MSG_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;msg =&gt; &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>chanel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功 &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token class-name">StopWatchUtils</span><span class="token punctuation">.</span><span class="token function">getTotalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="发布-订阅-模式-publish-subscribe"><a href="#发布-订阅-模式-publish-subscribe" class="header-anchor">#</a> 发布/订阅 模式 Publish/Subscribe</h3> <p>发布订阅模式是生产者推送的消息 , 其他消费者都均可收到该消息</p> <p><strong>大致流程 :</strong></p> <ol><li>声明交换机 , 并设置 <code>fanout</code> 类型</li> <li>生产者发送消息 到交换机</li> <li>消费者队列绑定交换机 , 并配置 <code>RoutingKey</code>路由规则 (类似订阅)</li> <li>消费者接收消息</li></ol> <h4 id="交换机-exchange"><a href="#交换机-exchange" class="header-anchor">#</a> 交换机 Exchange</h4> <p>生产者生产的消息不会直接发送到队列中的 , 而是发送到交换机 , 由交换机推入队列</p> <p><strong>交换机类型 :</strong> (点击跳转代码示例)</p> <ul><li><strong><a href="#direct">direct(点对点)</a></strong> (默认)
交换机会匹配 生产者发送的 <code>RoutingKey</code> 与 消费者队列绑定交换机的 <code>RoutingKey</code> . 相同才能实现点对点发送 . 如果没有匹配到一个 , 很有可能会丢失数据</li> <li><a href="#topic"><strong>topic(发布订阅)</strong></a>
交换机会 <strong>通配符匹配</strong> 生产者发送的 <code>RoutingKey</code> 与 消费者队列绑定交换机的 <code>RoutingKey</code> , 符合条件的队列都会收到分发的消息</li> <li><strong><a href="#fnout">fnout(广播)</a></strong>
只要消费者绑定有该类型交换机 , 不管<code>RoutingKey</code>是否匹配 , 都会接收广播消息</li> <li>...</li></ul> <p><strong>交换机 声明方法</strong></p> <p>==Channel.exchangeDeclare(String exchange, String type)==</p> <ul><li>exchange : 交换机名称</li> <li>type : 交换类型</li></ul> <h4 id="临时队列"><a href="#临时队列" class="header-anchor">#</a> 临时队列</h4> <p>临时队列 , 字面意思暂时使用的队列</p> <p><strong>队列特性 :</strong></p> <ul><li>随机名称</li> <li>断开消费者连接队列自动删除</li></ul> <p>Web管理页中 , 可以看到队列状态是 <code>AD</code> <code>Excl</code> (自动删除)</p> <p><strong>临时队列创建</strong></p> <p>==queueDeclare()==</p> <p>一般去会获取队列标识进行食用 ==chanel.queueDeclare().getQueue();==</p> <h4 id="绑定-binding"><a href="#绑定-binding" class="header-anchor">#</a> 绑定 binding</h4> <p>Exchange交换机 创建后需要绑定队列才会进行推送消息至消费者 . 可以绑定多个队列 , 消息推送是根据 <code>Routing Kye</code>(路由规则) 来确定指定队列</p> <details class="custom-block details"><summary>点击查看代码</summary> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq01.png" alt="rabbitmq-temp01"></p> <blockquote><p>交换机只负责转发消息 , 并没有存储消息的能力 , 因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列 , 那么消息会丢失</p></blockquote> <p><strong>绑定方法</strong></p> <p>==queueBind(String queue, String exchange, String routingKey)==</p> <ul><li>queue : 队列名</li> <li>exchange : 交换机</li> <li>routing Key : 路由Key</li></ul> <blockquote><p>重载方法 , 可在最后面携带参数 , 详细自行API</p></blockquote> <p><strong>Web管理页 绑定</strong></p> <p>Exchanges -&gt; 指定Exchange交换机 -&gt; Bindings</p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq02.png" alt="rabbitmq-temp02">2</p> <h4 id="direct"><a href="#direct" class="header-anchor">#</a> direct</h4> <p>交换机会匹配 生产者发送的 <code>RoutingKey</code> 与 消费者队列绑定交换机的 <code>RoutingKey</code> . 相同才能实现点对点发送 . 如果没有匹配到一个 , 很有可能会丢失数据</p> <p><strong>代码示例 :</strong> <a href="#direct%E7%82%B9%E5%AF%B9%E7%82%B9%E6%B5%8B%E8%AF%95">点击跳转</a></p> <h4 id="topic"><a href="#topic" class="header-anchor">#</a> topic</h4> <p>交换机会根据 <strong>通配符匹配</strong> 生产者发送的 <code>RoutingKey</code> 与 消费者队列绑定交换机的 <code>RoutingKey</code> , 符合条件的队列都会收到分发的消息</p> <p><strong>通配符说明 :</strong></p> <ul><li><code>*</code> 代替一个单词</li> <li><code>#</code> 代替0个/多个单词</li></ul> <blockquote><p><strong>特殊情况 :</strong></p> <ul><li>如果只有一个 <code>#</code> 那么将会接收通道的所有数据</li> <li>如果没有 <code>#</code>/<code>*</code> 出现 , 默认采用 <code>direct</code></li></ul></blockquote> <p><strong>匹配案例 :</strong></p> <table><thead><tr><th>RoutingKey</th> <th>通配值</th> <th>说明</th></tr></thead> <tbody><tr><td>com.sans.color</td> <td><code>*.sans.*</code></td> <td>匹配3个单词中的中间单词 sans</td></tr> <tr><td>com.sans.color.red</td> <td><code>#.red</code></td> <td>匹配最后为 red</td></tr> <tr><td>com.sans.color.blue</td> <td><code>con.#</code></td> <td>匹配开头为 com</td></tr></tbody></table> <p><strong>代码示例 :</strong> <a href="#topic%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85">点击跳转</a></p> <h4 id="fnout"><a href="#fnout" class="header-anchor">#</a> fnout</h4> <p>只要消费者绑定有该类型交换机 , 不管<code>RoutingKey</code>是否匹配 , 都会接收广播消息</p> <p><strong>代码示例 :</strong> [点击跳转](#广播 fnout)</p> <h4 id="代码实战"><a href="#代码实战" class="header-anchor">#</a> 代码实战</h4> <p>通用代码 , 参数自控</p> <blockquote><p>食用说明 :</p> <ol><li>采用Main传参控制 , <a href="#%E5%A4%9A%E6%9C%8D%E5%8A%A1%E8%BF%90%E8%A1%8C">跳转了解</a></li> <li>采用信道获取工具类 , <a href="#%E5%B7%A5%E5%85%B7%E7%B1%BB%E4%BC%98%E5%8C%96">跳转了解</a></li></ol></blockquote> <p><strong>生产者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 广播发送
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @param args [交换机名, 交换机类型, 路由key]
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> exchangeTypeParam <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果未赋予值 , 默认为 &quot;&quot;</span>
        <span class="token class-name">String</span> routingKey <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[交换机名, 交换机类型, 路由key]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 枚举验证</span>
        <span class="token class-name">BuiltinExchangeType</span> exchangeType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BuiltinExchangeType</span> value <span class="token operator">:</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exchangeTypeParam<span class="token punctuation">)</span><span class="token punctuation">)</span> exchangeType <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exchangeType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          声明一个exchange
          1.exchange的名称
          2.exchange的类型
         */</span>
        channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> exchangeType<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发布消息</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者发出消息:&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @param args [交换机名, 路由key]
     * @throws Exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> routingKey <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;[交换机名, 路由key]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 临时队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 绑定交换机</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 接收消息</span>
        chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到消息 =&gt; &quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>consumerTag<span class="token operator">-&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上Main中接收参数分别说明</p> <table><thead><tr><th>身份</th> <th>接收参数</th></tr></thead> <tbody><tr><td>生产者</td> <td>[交换机名, 交换机类型, 路由key]</td></tr> <tr><td>消费者</td> <td>[交换机名, 路由key]</td></tr></tbody></table> <h5 id="direct点对点测试"><a href="#direct点对点测试" class="header-anchor">#</a> direct点对点测试</h5> <table><thead><tr><th>运行顺序</th> <th>应用程序服务</th> <th>参数传递(直接复制即可)</th></tr></thead> <tbody><tr><td>1</td> <td>生产者 P1</td> <td>==color direct blue==</td></tr> <tr><td>2</td> <td>消费者 C1</td> <td>==color blue==</td></tr> <tr><td>3</td> <td>消费者 C2</td> <td>==color black==</td></tr></tbody></table> <p><strong>结果 :</strong> C1消费了 , C2无消费 . 只有 <code>RoutingKey</code> 匹配的消费者消费消息</p> <h5 id="topic发布订阅"><a href="#topic发布订阅" class="header-anchor">#</a> topic发布订阅</h5> <table><thead><tr><th>运行顺序</th> <th>应用程序服务</th> <th>传递参数(直接复制即可)</th></tr></thead> <tbody><tr><td>1</td> <td>生产者 P1</td> <td>==color topic com.sans.red==</td></tr> <tr><td>2</td> <td>消费者 C1</td> <td>==color #.red==</td></tr> <tr><td>3</td> <td>消费者 C2</td> <td>==color com.#==</td></tr> <tr><td>4</td> <td>消费者 C3</td> <td>==color com.*==</td></tr> <tr><td>5</td> <td>消费者 C4</td> <td>==color *.red==</td></tr> <tr><td>6</td> <td>消费者 C5</td> <td>==color #==</td></tr> <tr><td>7</td> <td>消费者 C6</td> <td>==color *==</td></tr></tbody></table> <p><strong>结果 :</strong> C1 , C2 , C5 消费者消费了 , 其余未消费 . 只有 <code>RoutingKey</code>通配符匹配 的消费者消费消息</p> <h5 id="广播-fnout"><a href="#广播-fnout" class="header-anchor">#</a> 广播 fnout</h5> <table><thead><tr><th>运行顺序</th> <th>应用程序服务</th> <th>传递参数(直接复制即可)</th></tr></thead> <tbody><tr><td>1</td> <td>生产者 P1</td> <td>==color fnout red==</td></tr> <tr><td>2</td> <td>消费者 C1</td> <td>==color black==</td></tr> <tr><td>3</td> <td>消费者 C2</td> <td>==color blue==</td></tr> <tr><td>4</td> <td>消费者 C3</td> <td>==color yellow==</td></tr></tbody></table> <p><strong>结果 :</strong> 所有消费者都消费了 . 消费者收到消息不会受到 <code>RoutingKey</code>的影响 , 只需绑定就可以收到通知</p> <h2 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h2> <h3 id="死信队列"><a href="#死信队列" class="header-anchor">#</a> 死信队列</h3> <p>死信 是无法被消费的消息</p> <p><strong>情况 :</strong> 生产者 发送消息 MQ , 消费者 从 队列 取出 , 由于某些原因导致 队列 中的某些消息无法被消费 , 这样的消息没有得到处理 , 称之为死信</p> <p><strong>场景 :</strong> 用户下订单时 , 点击支付 , 但又未在指定时间支付 , 死信队列机制会误认为异常消息 , 消息将会投入死信队列中</p> <p><strong>触发机制 :</strong></p> <ul><li>消息 TTL 过期</li> <li>队列到达最大长度</li> <li>消息被拒 , 使用 <code>channel.basicNack</code>/<code>channel.basicReject</code> 应答 , 并且参数<code>requeue</code>为false(不回流队列)</li></ul> <blockquote><p>交换机 和 队列 中的配置 , 一旦有修改 需要删除 重新运行</p></blockquote> <p>Web管理页中 , 可以看到队列状态是 <code>DLX</code>(死信交换机) , <code>DLK</code> (死信routingKey)</p> <p>**代码示例 : **</p> <p><strong>初始化构架声明</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 初始化架构
 * 初始化 交换机 , 队列 结构信息
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InitialArchitecture</span> <span class="token punctuation">{</span>

    <span class="token comment">// 普通交换机的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 死信交换机的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;dead_exchange&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 普通队列的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;normal_queue&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 死信队列的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;dead_queue&quot;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> normalRoutingKey <span class="token operator">=</span> <span class="token string">&quot;sans&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> deadRoutingKey <span class="token operator">=</span> <span class="token string">&quot;dead&quot;</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 重新初始化 , 删除以往相同名称的 交换机和队列</span>
        chanel<span class="token punctuation">.</span><span class="token function">exchangeDelete</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">exchangeDelete</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDelete</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDelete</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 声明 普通,死信 交换机</span>
        chanel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span><span class="token constant">DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 正常的队列设置死信交换机</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置死信routingKey</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> deadRoutingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 超出长度 测试
           设置队列最大长度
        */</span> 
        <span class="token comment">//arguments.put(&quot;x-max-length&quot;, 6);</span>

        <span class="token comment">// 声明 普通队列 , 死信队列</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 普通队列 绑定 普通交换机</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE</span><span class="token punctuation">,</span> <span class="token constant">NORMAL_EXCHANGE</span><span class="token punctuation">,</span> normalRoutingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 死信队列 绑定 死信交换机</span>
        chanel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE</span><span class="token punctuation">,</span> <span class="token constant">DEAD_EXCHANGE</span><span class="token punctuation">,</span> deadRoutingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details></details> <p><strong>生产者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 生产者
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

    <span class="token comment">// 普通交换机的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_EXCHANGE</span> <span class="token operator">=</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> routingKey <span class="token operator">=</span> <span class="token string">&quot;sans&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token string">&quot;msg &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token comment">/** TTL 超时测试
                参数3 : 构造者构建参数 ttl时间参数
            */</span>
            chanel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE</span><span class="token punctuation">,</span>
                    routingKey<span class="token punctuation">,</span>
                    <span class="token comment">//new AMQP.BasicProperties().builder().expiration(&quot;10000&quot;).build(),</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span>
                    msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送成功 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>消费者1</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者1
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer1</span> <span class="token punctuation">{</span>

    <span class="token comment">// 普通队列的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;normal_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理消息</span>
        chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收消息 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 消息拒绝 测试</span>
            <span class="token comment">//long deliveryTag = message.getEnvelope().getDeliveryTag();</span>
            <span class="token comment">//if (&quot;msg 4&quot;.equals(msg)) {</span>
            <span class="token comment">//    /* 拒绝 消息/收到</span>
            <span class="token comment">//        拒绝收到 (参数3: false防止回流队列): chanel.basicNack(deliveryTag, false, false);</span>
            <span class="token comment">//        拒绝消息 (参数2: false防止回流队列): chanel.basicReject(deliveryTag, false);</span>
            <span class="token comment">//     */</span>
            <span class="token comment">//    //chanel.basicNack(deliveryTag, false, false);</span>
            <span class="token comment">//    chanel.basicReject(deliveryTag, false);</span>
            <span class="token comment">//    System.out.println(&quot;拒绝 =&gt; &quot; + msg);</span>
            <span class="token comment">//}else{</span>
            <span class="token comment">//    chanel.basicAck(deliveryTag, false);</span>
            <span class="token comment">//    System.out.println(&quot;接收消息 =&gt; &quot; + msg);</span>
            <span class="token comment">//}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>消费者2</strong> (死信消费)</p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者2
 * @author Sans
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer2</span> <span class="token punctuation">{</span>

    <span class="token comment">// 死信队列的名称</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;dead_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> chanel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChanel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理消息</span>
        chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收消息 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h4> <p><strong>触发死信机制 :</strong> 有3种触发条件 , 分别围绕它们的条件进行测试</p> <p><strong>过期触发TTL</strong></p> <ol start="0"><li><strong>配置</strong> 生产者发送方法 ==basicPublish()== 中的第三参数 <strong>添加消息属性</strong> (采用构造者模式构造类)
==new AMQP.BasicProperties().builder().expiration(&quot;10000&quot;).build()== (TTL设置10s过期)</li> <li><strong>运行</strong> 初始化架构</li> <li><strong>运行</strong> 生产者</li> <li><strong>观察</strong> Web管理页 , 普通队列中的所有消息 过期推送至 死信队列中</li> <li><strong>运行</strong> 消费者2 , 清除死信队列中的消息</li></ol> <p><strong>队列到达最大长度</strong></p> <ol start="0"><li><strong>配置</strong> 初始化架构 , 在 声明普通队列 ==queueDeclare()==方法 中的第五个参数 <strong>编辑队列属性</strong>
Map集合新增 : ==arguments.put(&quot;x-max-length&quot;, 6);== (队列设置最大长度为6条消息)</li> <li><strong>运行</strong> 初始化架构</li> <li><strong>运行</strong> 生产者</li> <li><strong>运行</strong> 消费者1</li> <li><strong>观察</strong> Web管理页 , 普通队列中的消息 , 有部分消息会被排挤到 死信队列中</li> <li><strong>运行</strong> 消费者2 , 清除死信队列中的消息</li></ol> <blockquote><p><strong>注意 :</strong></p> <ul><li>初始化架构类中的配置 一旦修改了 , 则需要删除掉原旧的 交换机/队列 , 在运行 (配置更改了会冲突)</li> <li>为了尽可能的展现消息进入 死信队列中 , 要确保上一次所修改的配置是否还原 , 以防上次的配置影响数据混乱</li></ul></blockquote> <p><strong>消息被拒绝</strong></p> <ol start="0"><li><p><strong>配置</strong> 消费者1 , 手动应答请求 , 指定部分拒绝接收</p> <div class="language-java extra-class"><pre class="language-java"><code>chanel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;msg 4&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 拒绝 消息/收到
            拒绝收到 (参数3: false防止回流队列): chanel.basicNack(deliveryTag, false, false);
            拒绝消息 (参数2: false防止回流队列): chanel.basicReject(deliveryTag, false);
         */</span>
        <span class="token comment">//chanel.basicNack(deliveryTag, false, false);</span>
        chanel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;拒绝 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        chanel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收消息 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> consumerTag <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>运行</strong> 初始化架构</p></li> <li><p><strong>运行</strong> 生产者1</p></li> <li><p><strong>运行</strong> 消费者1</p></li> <li><p><strong>观察</strong> Web管理页 , 普通队列中的消息 , 有一条 <code>msg4</code>消息 被拒绝 至死信队列中</p></li> <li><p><strong>运行</strong> 消费者2 , 清除死信队列中的消息</p></li></ol> <h3 id="整合springboot"><a href="#整合springboot" class="header-anchor">#</a> 整合SpringBoot</h3> <p><strong>Springboot文档 :</strong> https://docs.spring.io/spring-amqp/reference/html/amqp.html</p> <h4 id="快速入门"><a href="#快速入门" class="header-anchor">#</a> 快速入门</h4> <p><strong>引入依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--RabbitMQ 依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>application配置</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8088</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> 8.130.47.114
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> bozhu
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123123</span>
</code></pre></div><blockquote><p>端口容易冲突 , 建议修改</p></blockquote> <p><strong>RabbitmqConfig配置类</strong></p> <p>交换机和队列 , 以及绑定 , 等操作是通过实例化形式进行的 , 以下由配置类形式展示</p> <p><strong>简单结构</strong></p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq03.png" alt="rabbitmq-temp03"></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitmqConfig</span> <span class="token punctuation">{</span>
   
   <span class="token comment">// 交换机</span>
   <span class="token class-name">String</span> aExchange <span class="token operator">=</span> <span class="token string">&quot;a_exchange&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> deadExchange <span class="token operator">=</span> <span class="token string">&quot;dead_exchange&quot;</span><span class="token punctuation">;</span>
   <span class="token comment">// 队列</span>
   <span class="token class-name">String</span> aQueue <span class="token operator">=</span> <span class="token string">&quot;a_queue&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> deadQueue <span class="token operator">=</span> <span class="token string">&quot;dead_queue&quot;</span><span class="token punctuation">;</span>
   
   <span class="token class-name">String</span> routingKeyA <span class="token operator">=</span> <span class="token string">&quot;RKA&quot;</span>
   <span class="token class-name">String</span> routingKeyB <span class="token operator">=</span> <span class="token string">&quot;RKB&quot;</span>
   
   <span class="token comment">/**
    * 交换机
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">aExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span>aExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span>deadExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token comment">/**
    * 队列
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">aQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 配置 死信交换机, 死信RoutingKey, 过期TTL</span>
       <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>aExchange<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span>deadExchange<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">deadLetterRoutingKey</span><span class="token punctuation">(</span>routingKeyB<span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">ttl</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>deadQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
   <span class="token comment">/**
    * 绑定
    */</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingAqueueToAexchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> aQueue <span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> aExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>aQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>aExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>routingKeyA<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueBbindX</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> deadQueue <span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> deadExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>deadQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>deadExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span>routingKeyB<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="操作对象"><a href="#操作对象" class="header-anchor">#</a> 操作对象</h4> <table><thead><tr><th>类</th> <th>说明</th></tr></thead> <tbody><tr><td><code>RabbitTemplate</code></td> <td>简化的 发送/接收 消息类</td></tr> <tr><td><code>AmqpAdmin</code></td> <td>携带式对AMQP管理操作类</td></tr></tbody></table> <p>生产者发送消息 : ==RabbitTemplate.convertAndSend()==</p> <h4 id="消费者"><a href="#消费者" class="header-anchor">#</a> 消费者</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueConsumer</span> <span class="token punctuation">{</span>
    <span class="token comment">// 队列处理消息</span>
    <span class="token comment">// 注解指定队列名</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;QA&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveDead</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;处理消息 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="延迟队列"><a href="#延迟队列" class="header-anchor">#</a> 延迟队列</h3> <p>延迟队列 是用来存放到指定时间才被释放消息的队列</p> <p>延迟队列机制 和 死信 TTL过期 相似 , 但延迟队列对时间的控制较灵活 , 应用应用场景广泛</p> <p><strong>场景 :</strong></p> <ol><li>下单十分钟未支付自动取消订单</li> <li>新建店铺 , 如果十天未上传商品 , 则自动发送消息提醒</li> <li>新用户注册后 , 三天未登录则进行短信提醒</li> <li>用户发起退款 , 如果三天未处理则通知相关运营人员</li> <li>会议预定 , 指定时间的前十分钟提醒参加会议</li></ol> <p>可以控制任意时间点发送通知</p> <h4 id="应用方式"><a href="#应用方式" class="header-anchor">#</a> 应用方式</h4> <p><strong>延迟配置</strong></p> <p>在 队列 中配置延迟属性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 变量说明
	NORMAL_QUEUE_A : 队列名称
	DEAD_EXCHANGE_Y : 死信交换机名称
	ROUTING_DEAD_QUEUE_KEY : 死信RoutingKey
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">aQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 配置 死信交换机, 死信RoutingKey, 过期TTL</span>
    <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_A</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_Y</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deadLetterRoutingKey</span><span class="token punctuation">(</span><span class="token constant">ROUTING_DEAD_QUEUE_KEY</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ttl</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 生产者 消息发送方法 中配置延迟</p> <p>指定消息TTL在队列中超时时长 : ==message.getMessageProperties().setExpiration(ttl);==</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 发送消息方法</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE_X</span><span class="token punctuation">,</span> <span class="token constant">ROUTING_KEY_QUEUE_C</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span>
        message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="代码示例"><a href="#代码示例" class="header-anchor">#</a> 代码示例</h4> <p><strong>架构 :</strong></p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq04.png" alt="rabbitmq-temp04"></p> <p><strong>初始化架构 RabbitmqConfig</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitmqConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 普通/死信 交换机</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_EXCHANGE_X</span> <span class="token operator">=</span> <span class="token string">&quot;EX&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_EXCHANGE_Y</span> <span class="token operator">=</span> <span class="token string">&quot;EY&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 死信 队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DEAD_QUEUE</span> <span class="token operator">=</span> <span class="token string">&quot;QD&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 普通 队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_A</span> <span class="token operator">=</span> <span class="token string">&quot;QA&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_B</span> <span class="token operator">=</span> <span class="token string">&quot;QB&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">NORMAL_QUEUE_C</span> <span class="token operator">=</span> <span class="token string">&quot;QC&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// RoutingKey</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_KEY_QUEUE_A</span> <span class="token operator">=</span> <span class="token string">&quot;RQA&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_KEY_QUEUE_B</span> <span class="token operator">=</span> <span class="token string">&quot;RQB&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_KEY_QUEUE_C</span> <span class="token operator">=</span> <span class="token string">&quot;RQC&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 死信 RoutingKey</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROUTING_DEAD_QUEUE_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;RQD&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">xExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE_X</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">yExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_Y</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">aQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置 死信交换机, 死信RoutingKey, 过期TTL</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_A</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_Y</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterRoutingKey</span><span class="token punctuation">(</span><span class="token constant">ROUTING_DEAD_QUEUE_KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ttl</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">bQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置 死信交换机, 死信RoutingKey, 过期TTL</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_B</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_Y</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterRoutingKey</span><span class="token punctuation">(</span><span class="token constant">ROUTING_DEAD_QUEUE_KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ttl</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">cQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置 死信交换机, 死信RoutingKey</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">NORMAL_QUEUE_C</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token constant">DEAD_EXCHANGE_Y</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">deadLetterRoutingKey</span><span class="token punctuation">(</span><span class="token constant">ROUTING_DEAD_QUEUE_KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">DEAD_QUEUE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 绑定
     * 比较示例 : 普通队列绑定 普通队列 --- 普通交换机
     * chanel.queueBind(NORMAL_QUEUE, NORMAL_EXCHANGE, normalRoutingKey);
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueAbindingX</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> aQueue <span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> xExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>aQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>xExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">ROUTING_KEY_QUEUE_A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueBbindingX</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> bQueue <span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> xExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>bQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>xExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">ROUTING_KEY_QUEUE_B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueCbindingX</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> cQueue<span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> xExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>cQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>xExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">ROUTING_KEY_QUEUE_C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">queueDbindingY</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> deadQueue <span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> yExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>deadQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>yExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">ROUTING_DEAD_QUEUE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>生产者 ProducerSendMessageController</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/producer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerSendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/send/{msg}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到请求 =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE_X</span><span class="token punctuation">,</span> <span class="token constant">ROUTING_KEY_QUEUE_B</span><span class="token punctuation">,</span> <span class="token string">&quot;B队列(40 000ms) =&gt;&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE_X</span><span class="token punctuation">,</span> <span class="token constant">ROUTING_KEY_QUEUE_A</span><span class="token punctuation">,</span> <span class="token string">&quot;A队列(10 000ms) =&gt;&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">/**
     * QC 发送消息(自定义时长)
     * @param msg 消息
     * @param ttl 过期时长 ms
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/qcSend/{msg}/{ttl}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;收到请求 =&gt; [%s, %s]%n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">NORMAL_EXCHANGE_X</span><span class="token punctuation">,</span> <span class="token constant">ROUTING_KEY_QUEUE_C</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span>
                message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> message<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>死信消费者 DeadQueueConsumer</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadQueueConsumer</span> <span class="token punctuation">{</span>
	<span class="token comment">// 死信处理</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">DEAD_QUEUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receiveDead</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;死信消费 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="代码测试"><a href="#代码测试" class="header-anchor">#</a> 代码测试</h4> <p><strong>测试 QA 和 QB 队列 TTL过期测试</strong></p> <ol><li><strong>访问</strong> http://localhost:8088/producer/send/lisi</li> <li><strong>观察</strong> 控制台 , 死信队列打印的消息(等待10s/40s)</li></ol> <blockquote><p>他们队列是分开分发一条消息 互不干扰 , 等待时间分别是 10s/40s</p></blockquote> <p><strong>测试 QC 队列多消息</strong></p> <ol><li><p><strong>连续访问</strong> http://localhost:8088/producer/qcSend/GOGO/10000</p></li> <li><p><strong>连续访问</strong> http://localhost:8088/producer/qcSend/GOGOGO/15000</p></li> <li><p><strong>连续访问</strong> http://localhost:8088/producer/qcSend/GO/5000</p></li> <li><p><strong>观察</strong> 控制台 , 消息是共同在队列中进行等待时间</p> <div class="language-java extra-class"><pre class="language-java"><code>收到请求 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token constant">GOGO</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">]</span>
收到请求 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token constant">GOGOGO</span><span class="token punctuation">,</span> <span class="token number">15000</span><span class="token punctuation">]</span>
收到请求 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token constant">GO</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">]</span>
死信消费 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Mon</span> <span class="token class-name">Mar</span> <span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59</span> <span class="token constant">CST</span> <span class="token number">2023</span> <span class="token operator">:</span> <span class="token constant">GOGO</span>
死信消费 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Mon</span> <span class="token class-name">Mar</span> <span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">05</span> <span class="token constant">CST</span> <span class="token number">2023</span> <span class="token operator">:</span> <span class="token constant">GOGOGO</span>
死信消费 <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Mon</span> <span class="token class-name">Mar</span> <span class="token number">06</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">26</span><span class="token operator">:</span><span class="token number">05</span> <span class="token constant">CST</span> <span class="token number">2023</span> <span class="token operator">:</span> <span class="token constant">GO</span>
</code></pre></div></li></ol> <blockquote><p>在 多消息同一队列中 , 消息的TTL过期时间是同时加载的 , 并且是有序的 .</p> <p>问题不难发现 , 同一时间发送两条消息 , 如果 第一个消息的TTL 大于 第二条消息的TTL , 即使 第二条消息的TTL已超时 , 也必须等待 第一条消息的TTL过期 , 最后也是按照先后顺序处理消息</p></blockquote> <h4 id="插件拓展"><a href="#插件拓展" class="header-anchor">#</a> 插件拓展</h4> <p>该插件正是解决上面的问题 , 采用交换机的插件类型 , 能够实现 消息TTL等待是在交换机中等待执行 , 避免了在队列中排队的问题</p> <p>插件官网 : https://www.rabbitmq.com/community-plugins.html</p> <p>插件GitHub : https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases</p> <p><strong>安装 :</strong></p> <ol><li><p>进入MQ插件目录 , 并将下载好的插件放进去 <code>.ez</code>格式 (选择自己的版本号)
==cd /usr/lib/rabbitmq/lib/rabbitmq_server-3.8.8/plugins==</p></li> <li><p>安装插件 (不需 填写版本和文件后缀)
==rabbitmq-plugins enable rabbitmq_delayed_message_exchange==</p></li> <li><p>重启RabbitMQ
==systemctl restart rabbitmq-server==</p></li> <li><p><strong>观察</strong> Web管理页 , 新增交换机 , 查看类型是否多出了 <code>x-delayed-message</code>类型</p></li></ol> <blockquote><p>下载注意版本兼容问题</p></blockquote> <h5 id="应用方式-2"><a href="#应用方式-2" class="header-anchor">#</a> 应用方式</h5> <p><strong>交换机声明</strong></p> <p>采用 自定义交换机 进行实例化声明</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">CustomExchange</span> <span class="token function">delayedExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-delayed-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomExchange</span><span class="token punctuation">(</span>
            <span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;x-delayed-message&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者延迟发送</strong></p> <p>往消息添加 <code>x-delay</code>头 属性 , 延迟功能 ==message.getMessageProperties().setDelay(ttl);==</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 变量说明
	DELAYED_EXCHANGE_NAME : 交换机名称
	DELAYED_ROUTING_KEY : RoutingKey
	msg : 发送消息
	ttl : 消息延迟时长
*/</span>
rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DELAYED_ROUTING_KEY</span> <span class="token punctuation">,</span>msg <span class="token punctuation">,</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为消息属性添加延迟功能</span>
    message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="代码示例-2"><a href="#代码示例-2" class="header-anchor">#</a> 代码示例</h5> <p>例图就不展示了 , 一个交换机: delayed.exchange , 一个队列: delayed.queue , 生产者 , 消费者</p> <p>主要测试 队列TTL过期循序问题</p> <p><strong>初始化架构 DelayedQueueConfig</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayedQueueConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 交换机, 队列, routingKey</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">DELAYED_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;delayed.routingkey&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/** 自定义交换机
     *  由于是自定义类型
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomExchange</span> <span class="token function">delayedExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> arguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        arguments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-delayed-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomExchange</span><span class="token punctuation">(</span>
                <span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;x-delayed-message&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">delayedQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token constant">DELAYED_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">delayedQueueBindingDelayedExchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> delayedQueue<span class="token punctuation">,</span> <span class="token class-name">CustomExchange</span> delayedExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>delayedQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>delayedExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">DELAYED_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>生产者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/producer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerSendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/delayed/{msg}/{ttl}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendDelayedMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;收到请求 =&gt; [%s, %s]%n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">DELAYED_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">DELAYED_ROUTING_KEY</span><span class="token punctuation">,</span>msg <span class="token punctuation">,</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置方式和以往不同 , 这个是设置延迟</span>
            <span class="token comment">// message.getMessageProperties().setExpiration(ttl + &quot;&quot;);</span>
            message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDelay</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 消费者
 * @author Sans
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueConsumer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">DELAYED_QUEUE_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delayedConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费消息 =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="代码测试-2"><a href="#代码测试-2" class="header-anchor">#</a> 代码测试</h5> <p><strong>队列多消息测试</strong></p> <ol><li><p><strong>连续访问</strong> http://localhost:8088/producer/delayed/GOGO/10000</p></li> <li><p><strong>连续访问</strong> http://localhost:8088/producer/delayed/GOGOGO/15000</p></li> <li><p><strong>连续访问</strong> http://localhost:8088/producer/delayed/GO/5000</p></li> <li><p><strong>观察</strong> 控制台 , 消息的延迟时间 是否按照有小到大的顺序 进行处理</p> <div class="language-text extra-class"><pre class="language-text"><code>收到请求 =&gt; [GOGO, 10000]
收到请求 =&gt; [GOGOGO, 15000]
收到请求 =&gt; [GO, 5000]
消费消息 =&gt; Mon Mar 06 11:29:26 CST 2023 : GO
消费消息 =&gt; Mon Mar 06 11:29:29 CST 2023 : GOGO
消费消息 =&gt; Mon Mar 06 11:29:35 CST 2023 : GOGOGO
</code></pre></div></li></ol> <p>在Web管理页中 , 是在交换机查看 延迟的消息 , 并非在队列中查看 , 消息直到延迟时间到期才会释放</p> <h3 id="发布确认高级"><a href="#发布确认高级" class="header-anchor">#</a> 发布确认高级</h3> <p>生产者发送消息后会进行备份到缓存中 , 如果成功则从缓存删除该备份的消息 , 否则在缓存中执行定时任务 , 重新从缓存中重新发布至 交换机 , 直到成功为止</p> <p><strong>大致流程 :</strong></p> <ol><li><p>配置 ==spring.rabbitmq.publisher-confirm-type: correlated==</p></li> <li><p>声明基本架构 (交换机/队列/绑定)</p></li> <li><p>生产者正常发送消息</p></li> <li><p>消费者正常接收消息</p></li> <li><p>编写 回调类 , 实现 <code>RabbitTemplate.ConfirmCallback</code>回调接口 (交换机)</p></li> <li><p>重写 <code>confirm()</code>回调方法 (成功/失败 都会走该方法)</p></li> <li><p>内部类接口注入 (由于是内部类不能直接拿去使用 , 不过可以通过以下形式注入其中)</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
<span class="token comment">/* @PostConstruct注解 
    在配置类 执行的构造函数 和 自动注入 后执行初始化的方法(类似servlet的init()方法) 
*/</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发布确认</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>测试</p></li></ol> <p><strong>配置</strong></p> <p>生产者的类型确认使用 <code>spring.rabbitmq.publisher-confirm-type</code></p> <table><thead><tr><th>配置值</th> <th>说明</th></tr></thead> <tbody><tr><td>none(默认)</td> <td>不做任何确认操作</td></tr> <tr><td>correlated</td> <td>消息到交换机触发 回调</td></tr> <tr><td>simple</td> <td>通过手动 <code>waitForConfirms()</code>返回结果回答(少用)</td></tr></tbody></table> <h4 id="代码示例-3"><a href="#代码示例-3" class="header-anchor">#</a> <a id="高级确认代码示例">代码示例</a></h4> <p>例图就不展示了 , 一个交换机: confirm.exchange , 一个队列: confirm.queue , 生产者 , 消费者</p> <p><strong>配置</strong></p> <p>==spring.rabbitmq.publisher-confirm-type: correlated==</p> <p><strong>基本架构</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfirmConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 交换机, 队列, routingKey</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_EXCHANGE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm.exchange&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_QUEUE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;confirm.queue&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CONFIRM_ROUTING_KEY</span> <span class="token operator">=</span> <span class="token string">&quot;confirm.routingkey&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">confirmExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">confirmQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">confirmQueueBindingConfirmExchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> confirmQueue<span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> confirmExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>confirmQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>confirmExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_ROUTING_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>生产者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/producer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerSendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/confirm/{msg}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirmSendMessage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;confirmSend =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 回调相关数据对象</span>
        <span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">CONFIRM_ROUTING_KEY</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueConsumer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">CONFIRM_QUEUE_NAME</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirmConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;confirmConsumer =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>回调类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">,</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnsCallback</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
	
    <span class="token comment">// 注入内部类接口</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发布确认</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 交换机确认回调方法
     * @param correlationData 回调的相关数据
     * @param ack ack为true，nack为false
     * @param cause 原因，对于nack，如果可用，否则为null
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> correlationData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Success =&gt; &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failure =&gt; &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">+</span> cause <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="代码测试-3"><a href="#代码测试-3" class="header-anchor">#</a> 代码测试</h4> <p>根据可控变量分析 , 可分析出可能情况 :</p> <ul><li>生产者 找不到交换机</li> <li>找到交换机 , 但找不到队列</li></ul> <p><strong>验证请求 :</strong> http://localhost:8088/producer/confirm/GO</p> <p><strong>生产者 找不到交换机</strong>
模拟故障操作 : 更改 生产者发送方法所指定的交换机名 , 试图寻找个不存在的交换机
测试结果 : 触发 <code>ConfirmCallback()</code>回调函数 , 失败 ,  找不到交换机</p> <div class="language-text extra-class"><pre class="language-text"><code>confirmSend =&gt; GO
Failure =&gt; confirm2 [channel error; protocol method: #method&amp;lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange 'no' in vhost '/', class-id=60, method-id=40)] 
</code></pre></div><p><strong>找到交换机 , 但找不到队列</strong></p> <p>模拟故障操作 : (以下两个故障结果是一致的)</p> <ul><li>更改 生产者发送方法指定的RoutingKey</li> <li>新建交换机 , 不进行绑定队列</li></ul> <p>测试结果 : 触发 <code>ConfirmCallback()</code>回调函数 , 成功 , 但消息没有得到消费 . 由于找不到队列消息而丢失</p> <div class="language-text extra-class"><pre class="language-text"><code>confirmSend =&gt; GO
Success =&gt; confirm3
</code></pre></div><blockquote><p>通过以上情况测试不难发现 , 仅靠 交换机 的确认是不行的 , 还需要在 队列 中进行确认消息 !</p> <p>可以通过退回消息 , 解决该问题</p></blockquote> <h3 id="回退消息"><a href="#回退消息" class="header-anchor">#</a> 回退消息</h3> <p>回退消息 主要功能是 确认消息发到队列中 . 也解决了上面进入队列确认的问题</p> <p><strong>实现</strong>
基于 <a href="#%E9%AB%98%E7%BA%A7%E7%A1%AE%E8%AE%A4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">发布确认代码</a> 新增 配置/代码</p> <ol><li><p>配置 ==spring.rabbitmq.publisher-returns: true==</p></li> <li><p>编写 回调类 , 实现 <code>RabbitTemplate.ReturnsCallback</code>回调接口 (队列)</p></li> <li><p>重写 <code>returnedMessage()</code>回调方法 , 找不到交换机失败回调</p></li> <li><p>内部类接口注入 (由于是内部类不能直接拿去使用 , 不过可以通过以下形式注入其中)</p></li></ol> <h4 id="代码示例-4"><a href="#代码示例-4" class="header-anchor">#</a> 代码示例</h4> <p>复用上面的 <a href="#%E9%AB%98%E7%BA%A7%E7%A1%AE%E8%AE%A4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">发布确认代码</a></p> <p><strong>配置</strong>
==spring.rabbitmq.publisher-returns: true==</p> <p><strong>生产者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/messageFallback/{msg}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageFallbackSend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;messageFallbackSend =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送成功</span>
    <span class="token class-name">CorrelationData</span> correlationData1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;messageFallback1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">CONFIRM_ROUTING_KEY</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> correlationData1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生产者 找不到交换机</span>
    <span class="token comment">//CorrelationData correlationData2 = new CorrelationData(&quot;messageFallback2&quot;);</span>
    <span class="token comment">//rabbitTemplate.convertAndSend(&quot;no&quot;, &quot;&quot;, msg, correlationData2);</span>
    <span class="token comment">// 交换机 找不到RoutingKey</span>
    <span class="token comment">//CorrelationData correlationData3 = new CorrelationData(&quot;messageFallback3&quot;);</span>
    <span class="token comment">//rabbitTemplate.convertAndSend(CONFIRM_EXCHANGE_NAME, &quot;no&quot;, msg, correlationData3);</span>
    <span class="token comment">// 交换机 找不到队列</span>
    <span class="token comment">//CorrelationData correlationData4 = new CorrelationData(&quot;messageFallback4&quot;);</span>
    <span class="token comment">//rabbitTemplate.convertAndSend(&quot;testNoNull&quot;, &quot;&quot;, msg, correlationData4);</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>回调类</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCallBack</span> <span class="token keyword">implements</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">,</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnsCallback</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发布确认</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息回退</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnsCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 交换机确认回调方法
     * @param correlationData 回调的相关数据
     * @param ack ack为true，nack为false
     * @param cause 原因，对于nack，如果可用，否则为null
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> correlationData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Success =&gt; &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Failure =&gt; &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">+</span> cause <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 回退消息
     *  当消息过程不能达到目的地 , 则将消息返回给生产者
     * @param returned 返回的消息和元数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">ReturnedMessage</span> returned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;回退消息 ==&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  消息: &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>returned<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  交换机名: &quot;</span> <span class="token operator">+</span> returned<span class="token punctuation">.</span><span class="token function">getExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  RoutingKey: &quot;</span> <span class="token operator">+</span> returned<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  退回原因: &quot;</span> <span class="token operator">+</span> returned<span class="token punctuation">.</span><span class="token function">getReplyText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="代码测试-4"><a href="#代码测试-4" class="header-anchor">#</a> 代码测试</h4> <p>根据可控变量分析 , 可分析出可能情况 :</p> <ul><li>生产者 找不到交换机</li> <li>生产者 找到交换机 , 但找不到队列</li></ul> <p><strong>验证请求 :</strong> http://localhost:8088/producer/messageFallback/GO</p> <p><strong>生产者 找不到交换机</strong>
模拟故障操作 : 更改 生产者发送方法所指定的交换机名 , 试图寻找个不存在的交换机
测试结果 : 触发 <code>ConfirmCallback()</code>回调函数 , 失败 ,  找不到交换机</p> <div class="language-text extra-class"><pre class="language-text"><code>messageFallbackSend =&gt; GO
Failure =&gt; messageFallback2 [channel error; protocol method: #method&amp;lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange 'no' in vhost '/', class-id=60, method-id=40)] 
</code></pre></div><p><strong>生产者 找到交换机 , 但找不到队列</strong></p> <p>模拟故障操作 : (以下两个故障结果是一致的)</p> <ul><li>更改 生产者发送方法指定的RoutingKey</li> <li>新建交换机 , 不进行绑定队列</li></ul> <p>测试结果 : 触发 <code>ConfirmCallback()</code>(成功)和<code>returnedMessage()</code>(失败) 回调函数 , 但消息没有得到消费 . 由于找不到队列消息而丢失</p> <div class="language-text extra-class"><pre class="language-text"><code>messageFallbackSend =&gt; GO
回退消息 ==&gt;
  消息: GO
  交换机名: confirm.exchange
  RoutingKey: no
  退回原因: NO_ROUTE
Success =&gt; messageFallback3
</code></pre></div><h3 id="备用交换机"><a href="#备用交换机" class="header-anchor">#</a> 备用交换机</h3> <p>备用交换机 , 字面意思 , 当某一交换机匹配不到<code>RoutingKey</code>指定的队列 , 那么会交给 备用交换机 处理 .</p> <p>一般情况 备用交换机 , 用来处理消费者 监控/报警 等操作</p> <p><strong>应用方式</strong></p> <p>在配置交换机Bean的时候可以通过 构造者模式中的 <code>alternate()</code>方法 指定备用交换机</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 变量说明
	BACKUP_EXCHANGE_NORMAL: 普通交换机名
	BACKUP_EXCHANGE_BACKUP: 备份交换机名
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">backupNormalExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_NORMAL</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token comment">// 备用</span>
            <span class="token punctuation">.</span><span class="token function">alternate</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_BACKUP</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="代码示例-5"><a href="#代码示例-5" class="header-anchor">#</a> 代码示例</h4> <p><strong>架构图</strong></p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq05.png" alt="rabbitmq-temp05"></p> <p><strong>基本架构</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackupConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 交换机</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_EXCHANGE_NORMAL</span> <span class="token operator">=</span> <span class="token string">&quot;backup.exchange.normal&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_EXCHANGE_BACKUP</span> <span class="token operator">=</span> <span class="token string">&quot;backup.exchange.backup&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 队列</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_QUEUE_NORMAL</span> <span class="token operator">=</span> <span class="token string">&quot;backup.queue.normal&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_QUEUE_BACKUP</span> <span class="token operator">=</span> <span class="token string">&quot;backup.queue.backup&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_QUEUE_WARNING</span> <span class="token operator">=</span> <span class="token string">&quot;backup.queue.warning&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// routingKey</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">BACKUP_ROUTING_KEY_NORMAL</span> <span class="token operator">=</span> <span class="token string">&quot;backup.routingkey.normal&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">backupNormalExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ExchangeBuilder</span><span class="token punctuation">.</span><span class="token function">directExchange</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_NORMAL</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token comment">// 备用</span>
                <span class="token punctuation">.</span><span class="token function">alternate</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_BACKUP</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">backupExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 广播</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_BACKUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">backupNormalQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BACKUP_QUEUE_NORMAL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">backupBackupQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BACKUP_QUEUE_BACKUP</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">backupWarningQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token constant">BACKUP_QUEUE_WARNING</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 绑定
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingNormalQueueToNormalExchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> backupNormalQueue<span class="token punctuation">,</span> <span class="token class-name">DirectExchange</span> backupNormalExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>backupNormalQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>backupNormalExchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token constant">BACKUP_ROUTING_KEY_NORMAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingBackupBackupQueueToBackupExchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> backupBackupQueue<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> backupExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>backupBackupQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>backupExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingBackupWarningQueueToBackupExchange</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> backupWarningQueue<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> backupExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>backupWarningQueue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>backupExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>生产者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/producer&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerSendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/backup/{msg}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">backupSend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;backupSend =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送成功</span>
        <span class="token class-name">CorrelationData</span> correlationData1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span><span class="token string">&quot;backupSend&gt;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">BACKUP_EXCHANGE_NORMAL</span><span class="token punctuation">,</span> <span class="token constant">BACKUP_ROUTING_KEY_NORMAL</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> correlationData1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生产者 找不到交换机</span>
        <span class="token comment">//CorrelationData correlationData2 = new CorrelationData(&quot;backupSend&gt;2&quot;);</span>
        <span class="token comment">//rabbitTemplate.convertAndSend(BACKUP_EXCHANGE_NORMAL+&quot;123&quot;, BACKUP_ROUTING_KEY_NORMAL, msg, correlationData2);</span>
        <span class="token comment">// 交换机 找不到RoutingKey</span>
        <span class="token comment">//CorrelationData correlationData3 = new CorrelationData(&quot;backupSend&gt;3&quot;);</span>
        <span class="token comment">//rabbitTemplate.convertAndSend(BACKUP_EXCHANGE_NORMAL, BACKUP_ROUTING_KEY_NORMAL+&quot;123&quot;, msg, correlationData3);</span>
        <span class="token comment">// 交换机 找不到队列</span>
        <span class="token comment">//CorrelationData correlationData4 = new CorrelationData(&quot;backupSend&gt;4&quot;);</span>
        <span class="token comment">//rabbitTemplate.convertAndSend(&quot;testNoNull&quot;, &quot;&quot;, msg, correlationData4);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>消费者</strong></p> <details class="custom-block details"><summary>点击查看代码</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueueConsumer</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 备份交换机
     */</span>
    <span class="token comment">// 正常消费者</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">BACKUP_QUEUE_NORMAL</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">backupNormalConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;backupNormalConsumer =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 备份消费者</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">BACKUP_QUEUE_BACKUP</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">backupConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;backupConsumer =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 警告消费者</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token constant">BACKUP_QUEUE_WARNING</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">backupWarningConsumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;backupWarningConsumer =&gt; &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; : &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="代码测试-5"><a href="#代码测试-5" class="header-anchor">#</a> 代码测试</h4> <p>根据可控变量分析 , 可分析出可能情况 :</p> <ul><li>生产者 找不到交换机</li> <li>交换机 RoutingKey匹配不到队列</li> <li>交换机 未绑定队列</li> <li>备用交换机 未绑定队列</li></ul> <p><strong>验证请求 :</strong> http://localhost:8088/producer/messageFallback/GO</p> <blockquote><p>模拟故障操作 , 在生产者类中写有 , 去掉注释测试即可</p></blockquote> <p><strong>生产者 找不到交换机</strong></p> <p>模拟故障操作 : 更改 生产者发送方法所指定的交换机名 , 试图寻找个不存在的交换机
测试结果 : <code>ConfirmCallback()</code> 回调失败</p> <div class="language-text extra-class"><pre class="language-text"><code>backupSend =&gt; GO
Failure =&gt; backupSend&gt;2 [channel error; protocol method: #method&amp;lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no exchange 'backup.exchange.normal123' in vhost '/', class-id=60, method-id=40)] 
</code></pre></div><p><strong>交换机 RoutingKey匹配不到队列</strong></p> <p>模拟故障操作 : 更改 生产者发送方法指定的RoutingKey</p> <p>测试结果 : <code>ConfirmCallback()</code> 回调成功 , 并且 备用交换机处理消息</p> <div class="language-text extra-class"><pre class="language-text"><code>backupSend =&gt; GO 
Success =&gt; backupSend&gt;3
backupWarningConsumer =&gt; Tue Mar 07 14:40:37 CST 2023 : GO
backupConsumer =&gt; Tue Mar 07 14:40:37 CST 2023 : GO
</code></pre></div><p><strong>交换机 未绑定队列</strong></p> <p>模拟故障操作 : 新建交换机 , 不进行绑定队列
测试结果 : <code>ConfirmCallback()</code> 回调成功 , 在交换机中 触发<code>returnedMessage()</code>退回消息 , 备用交换机未处理消息</p> <div class="language-text extra-class"><pre class="language-text"><code>backupSend =&gt; GO
回退消息 ==&gt;
  消息: GO
  交换机名: testNoNull
  RoutingKey: 
  退回原因: NO_ROUTE
Success =&gt; backupSend&gt;4
</code></pre></div><p><strong>备用交换机 未绑定队列</strong></p> <p>模拟故障操作 : 备用交换机 , 不进行绑定队列 (在Web管理页 解绑 重发消息即可实现)</p> <p>测试结果 : <code>ConfirmCallback()</code> 回调成功 , 在备用交换机中 触发<code>returnedMessage()</code>退回消息 , 备用交换机未处理消息</p> <div class="language-java extra-class"><pre class="language-java"><code>backupSend <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token constant">GO</span>
回退消息 <span class="token operator">==</span><span class="token operator">&gt;</span>
  消息<span class="token operator">:</span> <span class="token constant">GO</span>
  交换机名<span class="token operator">:</span> backup<span class="token punctuation">.</span>exchange<span class="token punctuation">.</span>normal
  <span class="token class-name">RoutingKey</span><span class="token operator">:</span> backup<span class="token punctuation">.</span>routingkey<span class="token punctuation">.</span>normal123
  退回原因<span class="token operator">:</span> <span class="token constant">NO_ROUTE</span>
<span class="token class-name">Success</span> <span class="token operator">=</span><span class="token operator">&gt;</span> backupSend<span class="token operator">&gt;</span><span class="token number">3</span>
</code></pre></div><blockquote><p>在上面4种情况观察分析 , 可以发现 交换机一旦未绑定队列 , 会使 消息回退 , 也不会执行备用交换机方案</p></blockquote> <h3 id="队列优先级"><a href="#队列优先级" class="header-anchor">#</a> 队列优先级</h3> <p>不难想象 , 在双十一高峰期 , 订单会非常多 . 有时 公司出于利益方面 , 划分出客户等级 , 等级越高的客户他们的单子往往在拥挤的时候优先得到解决</p> <p>在MQ当中优先级取值范围 : 0 ~ 255 (数值越大越优先)</p> <p><strong>应用方式</strong></p> <p><strong>配置</strong></p> <p>在 队列 中配置 优先级属性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/* 变量说明
    CONFIRM_QUEUE_NAME: 队列名
*/</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">priorityQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token string">&quot;priority.Queue&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 优先级 优先级最大值</span>
            <span class="token punctuation">.</span><span class="token function">maxPriority</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 生产者 消息发送方法 中配置优先级</p> <p>指定 消息 在队列中的优先级 : ==message.getMessageProperties().setPriority(n);==</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/priority/{msg}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">priorityBend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 优先级倒过来 ,</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;priorityBend =&gt; &quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CorrelationData</span> correlationData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationDat22a</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token constant">CONFIRM_EXCHANGE_NAME</span><span class="token punctuation">,</span> <span class="token constant">CONFIRM_ROUTING_KEY</span><span class="token punctuation">,</span> msg <span class="token operator">+</span> i<span class="token punctuation">,</span> message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>finalI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> correlationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="测试-2"><a href="#测试-2" class="header-anchor">#</a> 测试</h4> <p>源代码基本架构 <a href="#%E9%AB%98%E7%BA%A7%E7%A1%AE%E8%AE%A4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">点击跳转</a></p> <p><strong>测试步骤 :</strong></p> <ol><li>注释掉消费者代码</li> <li>运行项目</li> <li>访问 http://localhost:8088/producer/priority/GO (发送消息)</li> <li>观察方式 , 有两种: Web管理页 (能看到消息明细) ; 控制台(测试顺序)</li></ol> <p><strong>Web观察</strong></p> <p>进入 Queues -&gt; 选择队列 -&gt; Get Messages</p> <img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq06.png" alt="rabbitmq-temp06" style="zoom:67%;"> <p><strong>控制台观察 :</strong> 恢复消费者代码(去除先前注解) , 重新运行项目</p> <div class="language-text extra-class"><pre class="language-text"><code>confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO19
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO18
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO17
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO16
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO15
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO14
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO13
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO12
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO11
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO10
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO9
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO8
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO7
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO6
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO5
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO4
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO3
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO2
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO1
confirmConsumer =&gt; Tue Mar 07 21:55:26 CST 2023 : GO0
</code></pre></div><h3 id="惰性队列"><a href="#惰性队列" class="header-anchor">#</a> 惰性队列</h3> <p>惰性队列 主要作用的将消息尽可能的存到磁盘中 , 而消费者响应消息的时候才会被加载到内存中 , 设计初衷主要是容纳更多的消息 , 以免高峰期导致内存爆炸现象</p> <p><strong>不同情况下的队列 :</strong></p> <ul><li>普通队列(default) : 消息保存到内存中 (尽可能提高性能)</li> <li>惰性队列(lazy) : 消息保存到磁盘中 (尽可能存储更多的消息)</li></ul> <p><strong>惰性优点 :</strong></p> <ul><li>消费者失效 , 消息堆积情况</li> <li>大量消息 , 占用内存小</li></ul> <p><strong>应用 :</strong></p> <ol><li>在 队列 中配置 模式属性 : ==x-queue-mode: lazy==</li> <li>大量发送消息</li> <li>观察 Web内存占用情况</li></ol> <p><strong>SpringBoot 配置</strong></p> <p>在 队列 中配置 惰性属性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">lazyQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span><span class="token string">&quot;lazy.Queue&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// 惰性</span>
        	<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>高压测试</strong></p> <p>在 100W 条消息的内存情况下</p> <ul><li>普通 : 5.2MiB ≈ 5.078125MB ≈ 5078.1KB</li> <li>惰性 : 1.1MiB ≈ 1.07421875MB ≈ 1074.2KB</li></ul> <blockquote><p>GB 是 生厂商为了方便计算 , 以十进制 10的3次方运算  . 如 : 1000MB = 1GB</p> <p>GiB 而是 操作系统是采用 , 以二进制 2的10次方运算 . 如 : 1MiB = 1024KiB</p> <p>为了便于理解 可以将 MiB为MB (其他单位也是如此)</p></blockquote> <p>采用 <strong>异步发布消息</strong> 100W条消息</p> <p><strong>普通 :</strong></p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq07.png" alt="rabbitmq-temp07"></p> <p><strong>惰性 :</strong></p> <p><img src="https://image.bozhu12.cc/myblog/rabbitmq/Rabbitmq08.png" alt="rabbitmq-temp08"></p> <h2 id="集群"><a href="#集群" class="header-anchor">#</a> 集群</h2> <p>以往的操作都是处于一台机器操作 , 那么该机器宕机了 , 就不能服务 , 因此我们只可以使用多台服务器连接形成集群 , 提高可用率 , 哪怕其中一台宕机了也可以完好的将数据保留</p> <p>下面采用Docker模拟多台服务器应用</p> <h3 id="docker"><a href="#docker" class="header-anchor">#</a> Docker</h3> <p>在Docker中 部署安装RabbitMQ</p> <ol start="0"><li><p>安装Docker (网上教程烂大街..)</p></li> <li><p>查看版本 https://hub.docker.com/_/rabbitmq , 并拉取下载
建议下载含有Web管理页 , 镜像中带有 <code>mangement</code>版本的</p></li> <li><p>启动docker容器</p> <div class="language-docker extra-class"><pre class="language-docker"><code>docker run -d --name [容器名称]  \
-p 5672:5672  \
-p 15672:15672  \
-v `pwd`/data:/home/rabbitmq  \
--hostname [节点名称]  \
-e RABBITMQ_DEFAULT_USER=admin  \
-e RABBITMQ_DEFAULT_PASS=admin rabbitmq:[tag标签] \
</code></pre></div><p>我个人的应用方式 (端口小修一下)</p> <div class="language-docker extra-class"><pre class="language-docker"><code>docker run -d --name rabbitmq03  \
-p 5674:5672  \
-p 15674:15672  \
-v `pwd`/data:/home/rabbitmq  \
--hostname node03  \
-e RABBITMQ_DEFAULT_USER=admin  \
-e RABBITMQ_DEFAULT_PASS=admin  \
rabbitmq:3.11.10-management
</code></pre></div><p><strong>选项说明 :</strong></p> <table><thead><tr><th>选项</th> <th>说明</th></tr></thead> <tbody><tr><td>-d</td> <td>后台运行</td></tr> <tr><td>--name</td> <td>指定容器名称</td></tr> <tr><td>-p</td> <td>指定端口 [外部端口]:[容器端口] (5672:连接访问; 15672: Web管理页)</td></tr> <tr><td>-v</td> <td>映射 目录/文件</td></tr> <tr><td>--hostname</td> <td>主机名 (较为重要 集群作为 <strong>节点名称</strong> 使用)</td></tr> <tr><td>-e</td> <td>指定环境变量 (默认账号密码)</td></tr></tbody></table></li> <li><p>Web打开 http://ip:15672/ / http://ip:15673/ / http://ip:15674/</p></li> <li><p>账号密码 : <code>admin</code></p></li></ol> <p>**检查 : **</p> <ul><li>检查docker容器
==docker ps -a==</li> <li>检查端口是否调试好
==docker port {容器id}==</li> <li>查看防火墙是否开放端口</li></ul> <blockquote><p>MQ容器不同版本的端口很有可能不同 , 可通过 ==docker ps -a== 进行检查</p></blockquote></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" title="标签">#消息队列</a><a href="/tags/?tag=RabbitMQ" title="标签">#RabbitMQ</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/12, 00:43:49</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/backend/afbo81/" class="prev">Dubbo</a></span> <span class="next"><a href="/backend/6nss7s/">Netty网络通信</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/other/1hg722/"><div>
            ruoyi-plus 若依框架
            <!----></div></a> <span class="date">09-01</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/cb60aa/"><div>
            整合WebSocket实现聊天功能
            <!----></div></a> <span class="date">07-02</span></dt></dl><dl><dd>03</dd> <dt><a href="/backend/40kn91/"><div>
            SpringBoot部署
            <!----></div></a> <span class="date">06-10</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="Sanscan12" title="联系" target="_blank" class="iconfont icon-weixin"></a><a href="https://github.com/Sanscan12" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/user/home?id=448156561" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span> | <a href="https://beian.miit.gov.cn/">桂ICP备2022009417号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.fc393c60.js" defer></script><script src="/assets/js/2.b26d2d6f.js" defer></script><script src="/assets/js/51.07cd59a4.js" defer></script>
  </body>
</html>
