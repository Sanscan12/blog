<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | 柏竹</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="https://image.bozhu12.cc/myblog/Essay/favicon.ico">
    <script language="javascript" type="text/javascript" src="/js/pgmanor-self.js"></script>
    <meta name="description" content="学习足迹 , 记录生活!">
    <meta name="Sasncan12" content="柏竹博客, 个人技术博客, 前后端端 , 技术文档">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#bd93f9">
    
    <link rel="preload" href="/assets/css/0.styles.7521ea85.css" as="style"><link rel="preload" href="/assets/js/app.cd15dec3.js" as="script"><link rel="preload" href="/assets/js/2.b26d2d6f.js" as="script"><link rel="preload" href="/assets/js/57.87341998.js" as="script"><link rel="prefetch" href="/assets/js/10.9835140b.js"><link rel="prefetch" href="/assets/js/100.d45bbed2.js"><link rel="prefetch" href="/assets/js/101.c1a7bc89.js"><link rel="prefetch" href="/assets/js/102.1a2f74e5.js"><link rel="prefetch" href="/assets/js/103.ebd5682a.js"><link rel="prefetch" href="/assets/js/104.72169d48.js"><link rel="prefetch" href="/assets/js/105.6d850a73.js"><link rel="prefetch" href="/assets/js/106.94077482.js"><link rel="prefetch" href="/assets/js/107.46a6e981.js"><link rel="prefetch" href="/assets/js/108.112d1af1.js"><link rel="prefetch" href="/assets/js/109.ad83d492.js"><link rel="prefetch" href="/assets/js/11.95f8dafb.js"><link rel="prefetch" href="/assets/js/110.6aa5b4ab.js"><link rel="prefetch" href="/assets/js/111.0459e148.js"><link rel="prefetch" href="/assets/js/112.f7c27d6a.js"><link rel="prefetch" href="/assets/js/113.ebedd625.js"><link rel="prefetch" href="/assets/js/114.61a70367.js"><link rel="prefetch" href="/assets/js/115.b1e21d35.js"><link rel="prefetch" href="/assets/js/116.ecf4d998.js"><link rel="prefetch" href="/assets/js/117.70437f05.js"><link rel="prefetch" href="/assets/js/118.8b01e648.js"><link rel="prefetch" href="/assets/js/12.8d7bd029.js"><link rel="prefetch" href="/assets/js/13.94813285.js"><link rel="prefetch" href="/assets/js/14.7efd7ddb.js"><link rel="prefetch" href="/assets/js/15.8b3c0729.js"><link rel="prefetch" href="/assets/js/16.bf8a8e86.js"><link rel="prefetch" href="/assets/js/17.92a22e5a.js"><link rel="prefetch" href="/assets/js/18.870eb21a.js"><link rel="prefetch" href="/assets/js/19.c927b9a4.js"><link rel="prefetch" href="/assets/js/20.6802ce4f.js"><link rel="prefetch" href="/assets/js/21.070e0d88.js"><link rel="prefetch" href="/assets/js/22.96d2aead.js"><link rel="prefetch" href="/assets/js/23.bf12760c.js"><link rel="prefetch" href="/assets/js/24.61c5e1bf.js"><link rel="prefetch" href="/assets/js/25.65e92ad2.js"><link rel="prefetch" href="/assets/js/26.f0f9a90a.js"><link rel="prefetch" href="/assets/js/27.0c0df986.js"><link rel="prefetch" href="/assets/js/28.7a4e006f.js"><link rel="prefetch" href="/assets/js/29.1cd2ac7e.js"><link rel="prefetch" href="/assets/js/3.1914d350.js"><link rel="prefetch" href="/assets/js/30.c7518ffa.js"><link rel="prefetch" href="/assets/js/31.676301a3.js"><link rel="prefetch" href="/assets/js/32.91708d22.js"><link rel="prefetch" href="/assets/js/33.416ff1b1.js"><link rel="prefetch" href="/assets/js/34.7cee60c6.js"><link rel="prefetch" href="/assets/js/35.371d75ef.js"><link rel="prefetch" href="/assets/js/36.011a779d.js"><link rel="prefetch" href="/assets/js/37.fe7aa186.js"><link rel="prefetch" href="/assets/js/38.16b68c34.js"><link rel="prefetch" href="/assets/js/39.eca37abc.js"><link rel="prefetch" href="/assets/js/4.5017c5ca.js"><link rel="prefetch" href="/assets/js/40.dba246e4.js"><link rel="prefetch" href="/assets/js/41.11ef63c0.js"><link rel="prefetch" href="/assets/js/42.36d70f24.js"><link rel="prefetch" href="/assets/js/43.ab92360d.js"><link rel="prefetch" href="/assets/js/44.29204dcc.js"><link rel="prefetch" href="/assets/js/45.596a6e19.js"><link rel="prefetch" href="/assets/js/46.5020c7cf.js"><link rel="prefetch" href="/assets/js/47.6b6c6498.js"><link rel="prefetch" href="/assets/js/48.c73c0c3c.js"><link rel="prefetch" href="/assets/js/49.8f5e7bba.js"><link rel="prefetch" href="/assets/js/5.9c242416.js"><link rel="prefetch" href="/assets/js/50.82fea6f5.js"><link rel="prefetch" href="/assets/js/51.919c3106.js"><link rel="prefetch" href="/assets/js/52.069c7460.js"><link rel="prefetch" href="/assets/js/53.c1e450ec.js"><link rel="prefetch" href="/assets/js/54.d4bdd988.js"><link rel="prefetch" href="/assets/js/55.f036a743.js"><link rel="prefetch" href="/assets/js/56.c10ab232.js"><link rel="prefetch" href="/assets/js/58.ac8889e9.js"><link rel="prefetch" href="/assets/js/59.8e8d62b5.js"><link rel="prefetch" href="/assets/js/6.20f6982a.js"><link rel="prefetch" href="/assets/js/60.fb959a54.js"><link rel="prefetch" href="/assets/js/61.fdd8a5f0.js"><link rel="prefetch" href="/assets/js/62.36e8317e.js"><link rel="prefetch" href="/assets/js/63.0f3e49c9.js"><link rel="prefetch" href="/assets/js/64.de42aef9.js"><link rel="prefetch" href="/assets/js/65.877ee435.js"><link rel="prefetch" href="/assets/js/66.ad53b88d.js"><link rel="prefetch" href="/assets/js/67.e2d0d2d0.js"><link rel="prefetch" href="/assets/js/68.2a3673db.js"><link rel="prefetch" href="/assets/js/69.ea945878.js"><link rel="prefetch" href="/assets/js/7.c22f1339.js"><link rel="prefetch" href="/assets/js/70.8e85e240.js"><link rel="prefetch" href="/assets/js/71.dd32e1cb.js"><link rel="prefetch" href="/assets/js/72.25ed742e.js"><link rel="prefetch" href="/assets/js/73.ab1c6aee.js"><link rel="prefetch" href="/assets/js/74.73f5b981.js"><link rel="prefetch" href="/assets/js/75.3e098f8f.js"><link rel="prefetch" href="/assets/js/76.4bf1a786.js"><link rel="prefetch" href="/assets/js/77.5d2ed73d.js"><link rel="prefetch" href="/assets/js/78.d7d5e1fa.js"><link rel="prefetch" href="/assets/js/79.a2faf8f9.js"><link rel="prefetch" href="/assets/js/8.a8e2447d.js"><link rel="prefetch" href="/assets/js/80.9954ae48.js"><link rel="prefetch" href="/assets/js/81.50ae3339.js"><link rel="prefetch" href="/assets/js/82.95377a61.js"><link rel="prefetch" href="/assets/js/83.712330d3.js"><link rel="prefetch" href="/assets/js/84.5c8a6422.js"><link rel="prefetch" href="/assets/js/85.9c350789.js"><link rel="prefetch" href="/assets/js/86.43fe616d.js"><link rel="prefetch" href="/assets/js/87.a179b41b.js"><link rel="prefetch" href="/assets/js/88.23125b9e.js"><link rel="prefetch" href="/assets/js/89.3a662860.js"><link rel="prefetch" href="/assets/js/9.e5373fa3.js"><link rel="prefetch" href="/assets/js/90.70e82cd6.js"><link rel="prefetch" href="/assets/js/91.edde209f.js"><link rel="prefetch" href="/assets/js/92.25ebd729.js"><link rel="prefetch" href="/assets/js/93.9fb2c3fc.js"><link rel="prefetch" href="/assets/js/94.3159dc03.js"><link rel="prefetch" href="/assets/js/95.d282e882.js"><link rel="prefetch" href="/assets/js/96.05809140.js"><link rel="prefetch" href="/assets/js/97.335f4b6f.js"><link rel="prefetch" href="/assets/js/98.bd49a584.js"><link rel="prefetch" href="/assets/js/99.71d46c1b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7521ea85.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://image.bozhu12.cc/myblog/Essay/hendImage01.jpg" alt="柏竹" class="logo"> <span class="site-name can-hide">柏竹</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li></ul></div></div><div class="nav-item"><a href="/say/say2023/#四月" class="nav-link">说说</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://image.bozhu12.cc/myblog/Essay/favicon.ico"> <div class="blogger-info"><h3>柏竹</h3> <span>奋斗柏竹</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/backend/" class="nav-link router-link-active">后端</a></div><div class="nav-item"><a href="/web/" class="nav-link">前端</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/other/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Amway/" class="nav-link">应用推荐</a></li></ul></div></div><div class="nav-item"><a href="/say/say2023/#四月" class="nav-link">说说</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/friendLink/" class="nav-link">友链</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaWeb</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>拓展技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架技术</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/621sa1/" class="sidebar-link">MySQL</a></li><li><a href="/backend/0ygxqu/" class="sidebar-link">JDBC</a></li><li><a href="/backend/k5hxej/" class="sidebar-link">Hibernate</a></li><li><a href="/backend/zi2hq0/" class="sidebar-link">Mybatis</a></li><li><a href="/backend/ldn760/" aria-current="page" class="active sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#安装-应用" class="sidebar-link">安装&amp;应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#启动" class="sidebar-link">启动</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#终端连接" class="sidebar-link">终端连接</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#图形化工具" class="sidebar-link">图形化工具</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#redis基础" class="sidebar-link">Redis基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#常用命令" class="sidebar-link">常用命令</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#java实现" class="sidebar-link">Java实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#jedis" class="sidebar-link">Jedis</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#jedis连接池" class="sidebar-link">Jedis连接池</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群" class="sidebar-link">集群</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#springdataredis" class="sidebar-link">SpringDataRedis</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#自定义序列化器" class="sidebar-link">自定义序列化器</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#redisson" class="sidebar-link">Redisson</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#定时任务" class="sidebar-link">定时任务</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#续约锁" class="sidebar-link">续约锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#reids进阶" class="sidebar-link">Reids进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#数据结构" class="sidebar-link">数据结构</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#geo" class="sidebar-link">GEO</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#bit" class="sidebar-link">Bit</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#hyperloglog" class="sidebar-link">HyperLogLog</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#缓存淘汰" class="sidebar-link">缓存淘汰</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#发布订阅" class="sidebar-link">发布订阅</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#消息队列" class="sidebar-link">消息队列</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#消费者组" class="sidebar-link">消费者组</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#持久化" class="sidebar-link">持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#rdb持久化" class="sidebar-link">RDB持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#aof持久化" class="sidebar-link">AOF持久化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#rdb与aof区别" class="sidebar-link">RDB与AOF区别</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#主从机制" class="sidebar-link">主从机制</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#哨兵模式" class="sidebar-link">哨兵模式</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#哨兵redistemplate访问" class="sidebar-link">哨兵RedisTemplate访问</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#集群-2" class="sidebar-link">集群</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群搭建" class="sidebar-link">集群搭建</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#散列插槽slot" class="sidebar-link">散列插槽slot</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群redistemplate访问" class="sidebar-link">集群RedisTemplate访问</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#分布式锁" class="sidebar-link">分布式锁</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#多级缓存" class="sidebar-link">多级缓存</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#jvm进程缓存" class="sidebar-link">JVM进程缓存</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#多级缓存-2" class="sidebar-link">多级缓存</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#同步缓存" class="sidebar-link">同步缓存</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#redisson应用" class="sidebar-link">Redisson应用</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#可重入锁" class="sidebar-link">可重入锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#获取锁" class="sidebar-link">获取锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#释放锁" class="sidebar-link">释放锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#分布式锁流程" class="sidebar-link">分布式锁流程</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群分布式锁" class="sidebar-link">集群分布式锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#实战技巧" class="sidebar-link">实战技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#key设计" class="sidebar-link">Key设计</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#value结构设计" class="sidebar-link">Value结构设计</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#批处理" class="sidebar-link">批处理</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#批量存数据" class="sidebar-link">批量存数据</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#集群批处理" class="sidebar-link">集群批处理</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#redis-模拟百万数据" class="sidebar-link">Redis 模拟百万数据</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#服务端优化" class="sidebar-link">服务端优化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#持久化优化" class="sidebar-link">持久化优化</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#慢查询" class="sidebar-link">慢查询</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#安全配置" class="sidebar-link">安全配置</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#内存配置" class="sidebar-link">内存配置</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#缓存预存储" class="sidebar-link">缓存预存储</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#定时触发" class="sidebar-link">定时触发</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#手动触发" class="sidebar-link">手动触发</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#工具类" class="sidebar-link">工具类</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/backend/ldn760/#q-a" class="sidebar-link">Q&amp;A</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#缓存问题" class="sidebar-link">缓存问题</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存雪崩" class="sidebar-link">缓存雪崩</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存穿透" class="sidebar-link">缓存穿透</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#缓存击穿" class="sidebar-link">缓存击穿</a></li><li class="sidebar-sub-header level3"><a href="/backend/ldn760/#分布式锁问题" class="sidebar-link">分布式锁问题</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#jvm锁和分布式锁" class="sidebar-link">JVM锁和分布式锁</a></li><li class="sidebar-sub-header level4"><a href="/backend/ldn760/#续约锁-2" class="sidebar-link">续约锁</a></li></ul></li></ul></li><li><a href="/backend/redis2/" class="sidebar-link">Redis原理篇</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringClound</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/backend/#后端" data-v-06225672>后端</a></li><li data-v-06225672><a href="/backend/#数据库" data-v-06225672>数据库</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>柏竹</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-06-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Redis<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>REmote DIctionary Server(Redis) 是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库</p> <p>Redis 是一个开源的使用 ANSI C 语言编写、遵守 BSD 协议、支持网络、可基于内存、分布式、可选持久性的键值对(Key-Value)存储数据库，并提供多种语言的 API</p> <p>Redis 通常被称为数据结构服务器</p> <h2 id="安装-应用"><a href="#安装-应用" class="header-anchor">#</a> 安装&amp;应用</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p><strong>大致步骤 :</strong></p> <ol><li>安装依赖 gcc</li> <li>上传安装包 , 并解压</li> <li>进入redis根目录 , 运行编译</li> <li>检查成功</li> <li>启动</li></ol> <p><strong>官方下载 :</strong> https://redis.io/download/</p> <p><strong>安装依赖</strong></p> <p>Redis是基于C语言运行 , 因此依赖 gcc</p> <div class="language-sh extra-class"><pre class="language-sh"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc tcl
</code></pre></div><p><strong>上传并解压</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 上传位置自选</span>
/usr/local/src
<span class="token comment"># 解压 (注意自己的版本</span>
<span class="token function">tar</span> <span class="token parameter variable">-xzf</span> redis-6.2.6.tar.gz
</code></pre></div><p><strong>编译运行</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入目录</span>
<span class="token builtin class-name">cd</span> redis-6.2.6
<span class="token comment"># 编译运行</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre></div><p><strong>检查成功</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 查看环境变量 (看见reids相关配置即可)</span>
ll /usr/local/bin/
</code></pre></div><p>该目录以及默认配置到环境变量 , 配置环境后 , 可在任意路径执行命令 .</p> <table><thead><tr><th>指令集</th> <th>说明</th></tr></thead> <tbody><tr><td>redis-cli</td> <td>提供的命令行客户端</td></tr> <tr><td>redis-server</td> <td>服务端启动脚本</td></tr> <tr><td>redis-sentinel</td> <td>哨兵启动脚本</td></tr></tbody></table> <h3 id="启动"><a href="#启动" class="header-anchor">#</a> 启动</h3> <p>启动方式有多种 :</p> <ol><li>默认启动 (不建议)</li> <li>指定配置启动</li> <li>开机自启</li></ol> <p><strong>默认启动</strong></p> <p>通过命令 直接启动Redis:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-server
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>该启动方式 , 会阻塞会话窗口 , 需要手动关闭窗口</p></div> <p><strong>指定配置启动</strong></p> <p>通过指定配置文件进行启动Redids , 通过 Reids根路径的<code>reids.conf</code>配置文件进行操作</p> <details class="custom-block details"><summary>配置启动 点击展开</summary> <ol><li><p>进入Reids根路径</p></li> <li><p>拷贝备份(防止误操作)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">cp</span> redis.conf redis.conf.bck
</code></pre></div></li> <li><p>vim进入配置</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入 </span>
<span class="token function">vim</span> reids.conf
</code></pre></div><p>配置内容 , 使用 Vim查询 更改/添加内容</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
<span class="token comment"># 守护进程，修改为yes后即可后台运行</span>
daemonize <span class="token function">yes</span> 
<span class="token comment"># 密码，设置后访问Redis必须输入密码</span>
requirepass <span class="token number">123123</span>
</code></pre></div></li> <li><p>启动 , 进入文件根目录 指定文件运行  / 全限定名路径也可以</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-server redis.conf
</code></pre></div></li> <li><p>关闭Redis服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 因为之前配置了密码，因此需要通过 -user 来指定密码</span>
redis-cli <span class="token parameter variable">--user</span> <span class="token number">123123</span> <span class="token function">shutdown</span>
</code></pre></div></li></ol></details> <p><strong>开机启动</strong></p> <p>默认情况是没有<code>systemctl</code>命令 , 因此我们需要手动配置</p> <details class="custom-block details"><summary>开机启动 点击展开</summary> <ol><li><p>创建系统文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> /etc/systemd/system/redis.service
</code></pre></div></li> <li><p>配置以下内容 (注意自己的安装路径 , 启动配置文件的路径)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>redis-server
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf
<span class="token assign-left variable">PrivateTmp</span><span class="token operator">=</span>true

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target
</code></pre></div></li> <li><p>通过 <code>systemctl</code>进程 控制</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 启动</span>
systemctl start redis
<span class="token comment"># 停止</span>
systemctl stop redis
<span class="token comment"># 重启</span>
systemctl restart redis
<span class="token comment"># 查看状态</span>
systemctl status redis
</code></pre></div></li> <li><p>设置开机启动</p> <div class="language-sh extra-class"><pre class="language-sh"><code>systemctl <span class="token builtin class-name">enable</span> redis
</code></pre></div></li></ol></details> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>云服务器 , 需要开启安全组连接端口 : <code>6379</code></p> <p>虚拟机 , 需要 防火墙开端口<code>6379</code>/关闭防火墙</p></div> <h3 id="终端连接"><a href="#终端连接" class="header-anchor">#</a> 终端连接</h3> <p>Redis连接通过 redis-cli命令 :</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># reids-cli [options] [commonds]</span>
reids-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span>
</code></pre></div><table><thead><tr><th>选项</th> <th>默认值</th> <th>说明</th></tr></thead> <tbody><tr><td>-h</td> <td>127.0.0.1</td> <td>指定IP</td></tr> <tr><td>-p</td> <td>6379</td> <td>Reids端口</td></tr></tbody></table> <p>进入Redis命令控制台后 , 需要登录</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># AUTH [username] password </span>
<span class="token comment"># 无账号密码登录</span>
AUTH <span class="token number">123123</span>
</code></pre></div><h3 id="图形化工具"><a href="#图形化工具" class="header-anchor">#</a> 图形化工具</h3> <p>QuickReids : <a href="https://quick123.net/" target="_blank" rel="noopener noreferrer">https://quick123.net/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>开箱即用</p> <h2 id="redis基础"><a href="#redis基础" class="header-anchor">#</a> Redis基础</h2> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <p>Redis支持五种数据类型：</p> <ul><li>string(字符串)</li> <li>hash(哈希)</li> <li>list(列表)</li> <li>set(集合)</li> <li>zset/sortedSet(有序集合)</li></ul> <table><thead><tr><th>数据类型</th> <th>数据类型存储的值</th> <th>说明</th></tr></thead> <tbody><tr><td>String(字符串)</td> <td>字符串、整数、浮点数</td> <td>字符串增加 ; 求字符串整数、浮点数 计算 自增/自减.. (最大空间512m)</td></tr> <tr><td>List(列表)</td> <td>链表、每个节点都含有一个字符串</td> <td>支持 链表头尾 插入弹出<br>偏移剪切<br>查询、删除 指定节点</td></tr> <tr><td>Set(集合)</td> <td>集合中的每个元素都是一个字符串，且他们都是唯一的</td> <td>可 <code>增删查</code> 元素，<br>检测元素是否存在集合<br>计算集合 交、并、差集 等<br>随机读取元素</td></tr> <tr><td>SortedSet(集合)</td> <td>可排序Set集合 每个元素都携带 <code>score</code>属性</td> <td></td></tr> <tr><td>Hash(哈希散列表)</td> <td>Java中的 <code>Map类</code>  ，&lt;K , V&gt;</td> <td>可 <code>增删改查</code>  键值对<br>可获取所有键值对</td></tr> <tr><td>Zset(有序集合)</td> <td>有序集合，每个元素都携带<code>score</code>属性 , 元素基于该属性排序</td> <td>可 <code>增删改查</code> 元素 <br>根据分值范围或成员 获取对应元素</td></tr> <tr><td>HyperLogLog(基数)</td> <td>计算重复的值，确定存储数量</td> <td>只提供基数运算，不提供返回功能</td></tr></tbody></table> <h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <p>Redis 命令用于在 redis 服务上执行操作</p> <p><strong>命令参考 :</strong></p> <ul><li><a href="https://redis.io/commands" target="_blank" rel="noopener noreferrer">https://redis.io/commands<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://doc.redisfans.com/index.html" target="_blank" rel="noopener noreferrer">http://doc.redisfans.com/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><strong>基本类型操作</strong></p> <table><thead><tr><th>说明</th> <th>命令</th></tr></thead> <tbody><tr><td>赋值 (key存在覆盖)</td> <td>SET key value</td></tr> <tr><td>取值</td> <td>GET key</td></tr> <tr><td>批量赋值</td> <td>MSET key value [key value]</td></tr> <tr><td>批量取值</td> <td>MGET key [key]</td></tr> <tr><td>NX 赋值 (key存在跳过 , 不会覆盖)</td> <td>SETNX key value</td></tr> <tr><td>NX 赋值 并且设置 生存时间</td> <td>SETEX key seconds value</td></tr> <tr><td><strong>字符串数值操作</strong></td> <td></td></tr> <tr><td>自增+1</td> <td>INCR key</td></tr> <tr><td>自减-1</td> <td>DECR key</td></tr> <tr><td>指定增加 increment</td> <td>INCRBY key increment</td></tr> <tr><td>指定减少 decrem</td> <td>DECRBY key decrem</td></tr> <tr><td>浮点型自增 increment</td> <td>INCRBYFLOAT key increment</td></tr> <tr><td><strong>Hash散列</strong></td> <td></td></tr> <tr><td>Hash赋值 (field存在覆盖)</td> <td>HSET key field value</td></tr> <tr><td>Hash取值</td> <td>HGET key field</td></tr> <tr><td>Hash多赋值</td> <td>HMSET key field value [field value]</td></tr> <tr><td>Hash批取值</td> <td>HMGET key field [field]</td></tr> <tr><td>获取指定Hash所有信息</td> <td>HGETALL key</td></tr> <tr><td>获取指定Hash中所有field</td> <td>HKEYS key</td></tr> <tr><td>获取指定Hash中所有value</td> <td>HVALS key</td></tr> <tr><td>自增指定Hash中field的值自增increment</td> <td>HINCRBY key field increment</td></tr> <tr><td>Hash复制 (field存在跳过 , 不会覆盖)</td> <td>HSETNX key field value</td></tr> <tr><td><strong>List队列</strong></td> <td></td></tr> <tr><td>列表左增</td> <td>LPUSH key value [value]</td></tr> <tr><td>列表左弹</td> <td>LPOP key</td></tr> <tr><td>列表右增</td> <td>RPUSH key value [value]</td></tr> <tr><td>列表右弹</td> <td>RPOP key</td></tr> <tr><td>列表总数</td> <td>LLEN key</td></tr> <tr><td>查列表从start 到 stop</td> <td>LRANGE key start stop</td></tr> <tr><td><strong>Set集合（无序不可重复）</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>SADD key member [menber]</td></tr> <tr><td>删除元素</td> <td>SREM key member [member]</td></tr> <tr><td>获取Set所有个数</td> <td>SCARD key</td></tr> <tr><td>获取Set所有元素</td> <td>SMEMBERS key</td></tr> <tr><td>查 多个集合的交集</td> <td>SINTER key [key]</td></tr> <tr><td>查 元素 是否存在集合</td> <td>SISMEMBER key member</td></tr> <tr><td><strong>Zset有序集合（可排序，唯一性）</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>ZADD key score member [score member]</td></tr> <tr><td>获取元素score值</td> <td>ZSCORE key member</td></tr> <tr><td>获取元素在zSet排名</td> <td>ZRANK key member</td></tr> <tr><td>获取zSet所有个数</td> <td>ZCARD key</td></tr> <tr><td>获取zSet指定范围元素个数</td> <td>ZCOUNT key min max</td></tr> <tr><td>获取指定 个数 范围并排序</td> <td>ZRANGE key min max</td></tr> <tr><td>获取指定 score 范围并排序</td> <td>ZRANGEBYSCORE key min max</td></tr> <tr><td></td> <td>ZREVRANGEBYSCORE</td></tr> <tr><td>自增指定member中score的值自增 increment</td> <td>ZINCRBY key increment member</td></tr> <tr><td>删除元素</td> <td>ZREM key member [menber]</td></tr> <tr><td><strong>HyoperLogLog命令</strong></td> <td></td></tr> <tr><td>添加元素</td> <td>PFADD key element [element]</td></tr> <tr><td>获取指定 HyperLogLog 基数估算值</td> <td>PFCOUNT key [key]</td></tr> <tr><td>将多个 HyperLogLog 合并为一个 HyperLogLog</td> <td>PFMERGE destkey sourcekey [sourcekey]</td></tr> <tr><td><strong>生命周期</strong></td> <td></td></tr> <tr><td>设置key生存周期(秒)</td> <td>EXPIRE key seconds</td></tr> <tr><td>查看剩下生存时间TTL</td> <td>TTL key</td></tr> <tr><td>清除生存时间</td> <td>PERSIST key</td></tr> <tr><td><strong>其他命令</strong></td> <td></td></tr> <tr><td>查所有key</td> <td>KEYS *</td></tr> <tr><td>查所有以user开头的key</td> <td>KEYS user *</td></tr> <tr><td>查看指定key有多大</td> <td>MEMORY USAGE key</td></tr> <tr><td>确认key是否存在(ruturn 0/1 =&gt; falet/ture)</td> <td>EXISTS key</td></tr> <tr><td>删除key</td> <td>DEL key</td></tr> <tr><td>重命名key</td> <td>RENAME oldkey newkey</td></tr> <tr><td>获取key值类型</td> <td>TYPE key</td></tr> <tr><td>获取服务器信息</td> <td>INFO</td></tr> <tr><td>key移动至指定数据库</td> <td>MOVE key db</td></tr> <tr><td>切换数据库</td> <td>SELECT index</td></tr> <tr><td>停止服务器</td> <td>SHUTDOWN</td></tr> <tr><td>关闭服务连接</td> <td>QUIT</td></tr> <tr><td>删除当前数据库中的所有key</td> <td>FLUSHDB</td></tr> <tr><td>删除所有数据库中的所有</td> <td>FLUSHALL</td></tr> <tr><td>获取配置</td> <td>CONFIG GET &lt;配置名&gt;</td></tr> <tr><td>更改配置 (动态配置 , 重启消失)</td> <td>CONFIG SET &lt;配置名&gt;</td></tr></tbody></table> <p><strong>HyoperLogLog命令</strong></p> <p>随机化的算法，以少量内存提供集合唯一的元素数量的近似值</p> <p>可接受多个元素作为输入，并给出输入元素的基数估算值</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>基数：集合中不同元素的数量。
例如{'Sanscan','Bobo','Sanscan','Tomy','Sanscan'}的基数为3</p> <p>估算值：算法给出的基数并非精确，有些许偏差，但 会控制在范围内</p></div> <h2 id="java实现"><a href="#java实现" class="header-anchor">#</a> Java实现</h2> <h3 id="jedis"><a href="#jedis" class="header-anchor">#</a> Jedis</h3> <p>Jedis 是用于Reids命令的Java客户端库 , 命令通常以方法名使用 . 使用简单快速 , 含有线程安全问题</p> <p><strong>GitHub :</strong> <a href="https://github.com/redis/jedis" target="_blank" rel="noopener noreferrer">https://github.com/redis/jedis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>大致步骤 :</strong></p> <ol><li>引入依赖</li> <li>实例jedis对象(连接)</li> <li>使用jedis(操作)</li> <li>释放资源</li></ol> <p><strong>依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>连接服务器</strong>
连接可直接通过 实例<code>Jedis</code>类即可食用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.197.129&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果 Redis 服务设置了密码，需要下面这行，没有就不需要</span>
<span class="token comment">// jedis.auth(&quot;123456&quot;); </span>
jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;java001&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;java工程师&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> java001 <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;java001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>java001<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>指令和方法名称类似 , 可以根据命令传参即可使用</p></div> <h4 id="jedis连接池"><a href="#jedis连接池" class="header-anchor">#</a> Jedis连接池</h4> <p>jedis 本身线程不安全 , 频繁 创建/销毁 会产生性能损耗 , 使用Jedis连接池替代Jedis直连方式!</p> <p><strong>大致步骤 :</strong></p> <ol><li>实例连接池 , 并设置基本参数</li> <li>实例 JedisPool连接池对象</li> <li>通过 <code>getResource()</code>方法 提取食用 jedis</li> <li>释放资源</li></ol> <blockquote><p>JedisPool构造方法重载多种 , 自行API</p></blockquote> <p><strong>代码示例 :</strong></p> <details class="custom-block details"><summary>代码示例 点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JedisPoolConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大连接数</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//最大空闲数</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取连接池</span>
        <span class="token class-name">JedisPool</span> jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name : &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jedisPool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                jedisPool<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="集群"><a href="#集群" class="header-anchor">#</a> 集群</h4> <p>PS：如果redis重启，需要将redis中生成的dump.rdb和nodes.conf文件删除，然后再重启</p> <details class="custom-block details"><summary>代码展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// 创建连接</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7003</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7004</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7005</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.74.131&quot;</span><span class="token punctuation">,</span><span class="token number">7006</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 集群搭建</span>
        <span class="token class-name">JedisCluster</span> cluster <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        cluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// 执行JedisCluster对象中的方法，方法和redis指令一一对应</span>
        cluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;柏竹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name : &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">//存储List数据到列表中</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cluster<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stringList <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">&quot;site-list&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;=============&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> stringList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">//关闭集群 JedisCluster对象</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;集群测试完成！！！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="springdataredis"><a href="#springdataredis" class="header-anchor">#</a> SpringDataRedis</h3> <p>SpringData是Spring中数据操作的模块 , 该模块集成了很多数据库操作 , 其中也包括 Reids</p> <p>官方 : <a href="https://spring.io/projects/spring-data-redis/" target="_blank" rel="noopener noreferrer">https://spring.io/projects/spring-data-redis/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>优点 :</strong></p> <ul><li>整合了 Lettuce 和 jedis</li> <li>提供 ReidsTemplate统一API操作</li> <li>支持 同步/异步/响应式编程</li> <li>线程安全</li> <li>支持 哨兵模式/集群/管道 模式</li> <li>支持 发布订阅模型</li> <li>支持基于 JDK/JSON/字符串/Spring 对象的 序列化/反序列化</li></ul> <p>SpringDataRedis提供RedisTemplate工具类 , 里面封装了各种Reids操作功能 , 分别介绍 :</p> <table><thead><tr><th>返回</th> <th>API</th> <th>说明</th></tr></thead> <tbody><tr><td>ValueOperations</td> <td>redisTemplate.opsForValue()</td> <td>操作String类型</td></tr> <tr><td>HashOperations</td> <td>redisTemplate.opsForHash()</td> <td>操作Hash类型</td></tr> <tr><td>ListOperations</td> <td>redisTemplate.opsForList()</td> <td>操作List类型</td></tr> <tr><td>SetOperations</td> <td>redisTemplate.opsForSet()</td> <td>操作Set类型</td></tr> <tr><td>ZSetOperations</td> <td>redisTemplate.opsForZSet()</td> <td>操作SortedSet类型</td></tr></tbody></table> <p><strong>大致步骤 :</strong></p> <ol><li>引入依赖</li> <li>配置参数</li> <li>配置类配置</li> <li>CRUD测试</li></ol> <details class="custom-block details"><summary>代码示例 点击展开</summary> <p><strong>引入依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>配置Reids基本参数</strong></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># redis 配置 (端口/地址/密码/连接池配置)</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">data</span><span class="token punctuation">:</span>
        <span class="token key atrule">redis</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
            <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123123</span>
            <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
              <span class="token key atrule">pool</span><span class="token punctuation">:</span>
                  <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>
                  <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
                  <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
                  <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> 100ms
</code></pre></div><blockquote><p>我使用的是SprinBoot3.0.4版本 , 旧版本没有data节点</p></blockquote> <p><strong>配置类 配置</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RidesConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 自定义配置 RedisTemplate
     * @param connectionFactory 连接工厂
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 key序列化器 RedisSerializer</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 连接工厂</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试 CRUD</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValueOperations</span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Sans&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> stat <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;zs1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;zs2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">,</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">,</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span><span class="token number">6.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;Sans111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ValueOperations</span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;String =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;List =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Int =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;double =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user =&gt;&quot;</span> <span class="token operator">+</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;List&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;Int&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;double&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>SpringBoot3.02版本以下 , 采用 <code>@Resource</code>注解 自动注入 , 需要添加name参数进行指定名称Bean的方法名称 , 例如 :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
</code></pre></div></div> <h4 id="自定义序列化器"><a href="#自定义序列化器" class="header-anchor">#</a> 自定义序列化器</h4> <p>默认采用的jdk序列化对key和value造成乱码 , 无难以阅读 , 而且乱码在外部获取也不方便 , 因此 需要执行配置序列化</p> <p><strong>文章参考 :</strong></p> <ul><li><a href="https://developer.aliyun.com/article/907866" target="_blank" rel="noopener noreferrer">https://developer.aliyun.com/article/907866<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.aliyun.com/article/907868" target="_blank" rel="noopener noreferrer">https://developer.aliyun.com/article/907868<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.aliyun.com/article/907869" target="_blank" rel="noopener noreferrer">https://developer.aliyun.com/article/907869<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><strong>RedisConfig配置类</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RidesConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 自定义配置 RedisTemplate
     * @param connectionFactory 连接工厂
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 key序列化器 RedisSerializer</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 设置 连接工厂</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h3> <p>Redisson是基于 Reids实现的分布式 , 可伸缩Java数据结构集合等类型对象</p> <p><strong>介绍 :</strong> <a href="https://github.com/redisson/redisson" target="_blank" rel="noopener noreferrer">https://github.com/redisson/redisson<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>版本 :</strong> <a href="https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter" target="_blank" rel="noopener noreferrer">https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>高级Sedisson应用 :</strong> <a href="#Redisson%E5%BA%94%E7%94%A8">传送门跳转</a></p> <p><strong>快速入门</strong></p> <details class="custom-block details"><summary>快速应用 点击展开</summary> <ol><li><p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>版本迭代快 , 非SprinBoot谨慎选择Redisson版本</p></blockquote></li> <li><p>写入配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建配置</span>
    <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> redisAddress <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;redis:127.0.0.1:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>redisAddress<span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建实例</span>
    <span class="token class-name">RedissonClient</span> redissonClient <span class="token operator">=</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redissonClient<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>测试应用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// JVM 本地操作</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sasn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;list.get(0) = &quot;</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// reids 操作</span>
    <span class="token comment">// RLIST 继承了 List特性</span>
    <span class="token class-name">RList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> rList <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token string">&quot;test-list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;rList.get(0) = &quot;</span> <span class="token operator">+</span> rList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Redisson 其他集合...</span>
    <span class="token comment">//redissonClient.getMap(&quot;test-map&quot;);</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></details> <h4 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h4> <p><strong>意图 :</strong> 每天提前更新的缓存数据 , 防止数据在高峰期抢占资源</p> <p><strong>注意 :</strong></p> <ul><li>线程等待时间为0 , 多个线程只能抢一次</li> <li>释放锁前提需要判断是否是本线程的锁否则跳过</li> <li>释放锁是在 try-catch 中的 finally中进行检查释放 (防止中途代码异常)</li></ul> <p><strong>示例 :</strong></p> <p>定时任务采用 Springboot内置 <code>@EnableScheduling</code> 和 采用Redisson分布式锁 实现</p> <p>多台服务的情况下 , 每天凌晨12点 加载定时任务 , 多个服务只能一个服务进行执行任务 (避免不必要的资源浪费)</p> <details class="custom-block details"><summary>代码示例 点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0 0 0 * * *&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doCacheRecommendUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;sans:precachejob:docache:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
      参数
      1. 等待获取(0无需等待)
      2. 过期时长
      3. 时间单位
     */</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只有一个线程获取到锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lockName op :&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> userId <span class="token operator">:</span> mainUserList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;sans:user:recommend:%s&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> qw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userPage <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userPage<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;redis set key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;doCacheRecommendUser error &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lockName ed :&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="续约锁"><a href="#续约锁" class="header-anchor">#</a> 续约锁</h4> <p>监听线程 , 如方法未执行完 , 会帮你重置 reids锁的过期时间</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span> 
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redisson<span class="token punctuation">;</span> <span class="token comment">//自动装配RedissonClient</span>
<span class="token class-name">RLock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;onelock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取锁</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//加锁</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放锁</span>
</code></pre></div><p>主要通过方法 ==lock.tryLock(0, -1, TimeUnit.MILLISECONDS)==</p> <blockquote><p>方法参数说明 : 1参数 等待获取锁时长 , 2参数 锁过期时长 , 3参数 时间单位</p> <p>续约锁需要指定 2参数为 -1 , Redisson自动设为 续约模式 , 直到线程执行完成并释放锁</p></blockquote> <p><strong>注意 :</strong></p> <ul><li>过期时间必须定义为 -1</li> <li>监听当前线程 , 默认过期时间为30s  , 每 10s 续期一次</li> <li>如果线程挂掉(debug模式也会误认宕机) , 则不会续期</li> <li><code>tryLock()</code>方法必须要用try-catch包括并且在finally中进行释放锁(防止异常后能够进行释放锁)</li></ul> <p><strong>代码示例 :</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 看门狗机制测试
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redissonLookDoorDog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;sans:precachejob:docache:lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只能释放本身线程的锁(以防释放其他线程的锁)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reids进阶"><a href="#reids进阶" class="header-anchor">#</a> Reids进阶</h2> <h3 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h3> <h4 id="geo"><a href="#geo" class="header-anchor">#</a> GEO</h4> <p>GEO 是存储 地理坐标 的数据结构 , 基于zSet数据结构实现 , 在Redis3.2版本中支持</p> <p><strong>常用命令 :</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>GEOADD</td> <td>添加地理位置 , 经度(longitude) ; 维度(latitude) ; 值(member)</td></tr> <tr><td>GEODLST</td> <td>获取 两个点之间的距离(单位: m)</td></tr> <tr><td>GEOHASH</td> <td>获取 指定member坐标 转为hash字符串形式</td></tr> <tr><td>GEOPOS</td> <td>获取 member坐标</td></tr> <tr><td>GEORADIUS</td> <td>获取 范围内的member , 指定 圆心 ; 半径 , 找到圆内的所有member , 按距离返回</td></tr> <tr><td>GEOSEARCH</td> <td>获取 指定范围的member , 按照指定范围返回</td></tr> <tr><td>GEOSEARCHSTORE</td> <td>找出位于指定范围内的元素，中心点是由给定的位置元素决定</td></tr></tbody></table> <h4 id="bit"><a href="#bit" class="header-anchor">#</a> Bit</h4> <p>BitMap 是基于 字符串 的数据结构 , 能够实现位操作</p> <p><strong>常用命令 :</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>SETBIT</td> <td>向指定位置(offset)存入一个0或1</td></tr> <tr><td>GETBIT</td> <td>获取指定位置（offset)的bit值</td></tr> <tr><td>BITCOUNT</td> <td>统计BitMap中值为1的bit位的数量</td></tr> <tr><td>BITFIELD</td> <td>操作（查询、修改、自增）BitMap中bit数组中的指定位置(offset)的值</td></tr> <tr><td>BITFIELD RO</td> <td>获取BitMap中bit数组，并以十进制形式返回</td></tr> <tr><td>BTOP</td> <td>将多个BitMap的结果做位运算（与、或、异或)</td></tr> <tr><td>BITPOS</td> <td>查找bit数组中指定范围内第一个0或1出现的位置</td></tr></tbody></table> <h4 id="hyperloglog"><a href="#hyperloglog" class="header-anchor">#</a> HyperLogLog</h4> <p>HyperLogLog(HHL)是一种基数统计算法 , 用于解决海量数据的基数统计问题</p> <p><strong>优点 :</strong></p> <ul><li>占用内存小(不超过16kb)</li> <li>对添加的元素唯一统计</li> <li>PFCOUNT统计误差为 0.81%</li></ul> <p><strong>常用命令 :</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>PFADD</td> <td>将任意数量的元素添加到指定的 HyperLogLog (不能重复)</td></tr> <tr><td>PFCOUNT</td> <td>统计HyperLogLog数量</td></tr> <tr><td>PFMERGE</td> <td>将多个 HyperLogLog 合并为一个 HyperLogLog (保证唯一)</td></tr></tbody></table> <h3 id="缓存淘汰"><a href="#缓存淘汰" class="header-anchor">#</a> 缓存淘汰</h3> <p>Redis的缓存数据是基于内存存储的 , 内存终究会有不够用的时候 , 为了保证内存不会爆满 , 导致宕机 , 因此 Reids的缓存淘汰机制就起到关键作用</p> <p><strong>淘汰分类 :</strong></p> <table><thead><tr><th></th> <th style="text-align:center;">内存淘汰</th> <th style="text-align:center;">超时淘汰</th> <th style="text-align:center;">主动更新</th></tr></thead> <tbody><tr><td><strong>说明</strong></td> <td style="text-align:center;">Redis内置机制 , 当内存不足时会自动淘汰部分数据</td> <td style="text-align:center;">数据会根据TTL超时而淘汰</td> <td style="text-align:center;">自行编写业务逻辑 , 修改数据库更新缓存</td></tr> <tr><td><strong>一致性</strong></td> <td style="text-align:center;">差</td> <td style="text-align:center;">一般</td> <td style="text-align:center;">好</td></tr> <tr><td><strong>维护成本</strong></td> <td style="text-align:center;">无</td> <td style="text-align:center;">低</td> <td style="text-align:center;">高</td></tr></tbody></table> <p>对 缓存与数据库 一致性要求高 , 可采取以下方案 :</p> <p><strong>读数据 :</strong></p> <ul><li>缓存查到直接返回</li> <li>缓存查不到 , 写入缓存 , 并设超时时间</li></ul> <p><strong>写数据 :</strong></p> <ul><li>先写数据库 , 后删除缓存</li> <li>确保数据库和缓存操作是过程无异常(事务)</li></ul> <h3 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h3> <p>Redis 事务可以一次执行多个命令， 并且带有以下两个重要的保证：</p> <ul><li>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客 户端发送来的命令请求所打断</li> <li>事务中的命令要么全部被执行，要么全部都不执行</li></ul> <p><strong>事务阶段：</strong></p> <ol><li>开始事务</li> <li>命令入队</li> <li>执行事务</li></ol> <p><strong>事务命令</strong></p> <table><thead><tr><th>命令</th> <th>描述</th></tr></thead> <tbody><tr><td>MULTI</td> <td>开始事务</td></tr> <tr><td>DISCARD</td> <td>取消事务</td></tr> <tr><td>EXEC</td> <td>结束事务</td></tr></tbody></table> <h3 id="发布订阅"><a href="#发布订阅" class="header-anchor">#</a> 发布订阅</h3> <p>Redis 发布订阅(pub/sub) 是一种消息通信模式：发布者(pub)发送消息，订阅者(sub)接收消息</p> <p>但发布者发布消息发送到信道 , 当有消费者订阅信道(频道)channel , 将会接收到发布的相关消息</p> <p><strong>特点 :</strong></p> <ul><li>可实现广播形式发布消息</li> <li>不能对消息不支持持久化</li> <li>消息堆积有上限 , 超出会丢失</li></ul> <p><strong>命令 :</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>SUBSCRIBE channel [channel]</td> <td>订阅 一个/多个 频道</td></tr> <tr><td>PUBLISH channel message</td> <td>发布消息到 信道</td></tr> <tr><td>PSUBSCRIBE pattern [pattern]</td> <td>订阅与pattern格式匹配所有频道</td></tr></tbody></table> <div class="custom-block note"><p class="custom-block-title">pattern参数</p> <p>字符串 通配符应用 , 支持有以下通配符 :</p> <ul><li><code>?</code> : 统配 一个 字符</li> <li><code>*</code> : 通配 一个/多个 字符</li> <li><code>[]</code> : 通配 多个常量 . 例如 : h[ae]llo -&gt; hello / hallo 识别两种!</li></ul></div> <p><strong>测试：</strong></p> <ol><li>打开3个客户端 , 分别 1个发布者 , 2个订阅者</li> <li>订阅者1 : 订阅 SUBSCRIBE order.q1</li> <li>订阅者2 : 订阅 PSUBSCRIBE order.q?</li> <li>发布者发布 :
<ul><li>SUBSCRIBE order.q1 msg1</li> <li>SUBSCRIBE order.q2 msg2</li></ul></li> <li>分别查看他们接收情况</li></ol> <h3 id="消息队列"><a href="#消息队列" class="header-anchor">#</a> 消息队列</h3> <p>Redis5.0 引入了新数据类型 Stream , 用于实现消息队列</p> <p>了解即可 , 消息队列还得要学RabbitMQ ~</p> <p><strong>特点 :</strong></p> <ul><li>消息可回溯 (不会出现读完删除)</li> <li>一个消息可多消费者读取</li> <li>可阻塞读取</li> <li>消息可能会漏读</li></ul> <p><strong>命令 :</strong></p> <table><thead><tr><th>命令</th> <th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>XADD key *|ID field value [field value]</td> <td>ID : 消息唯一id , 如果为 * 代表自动生成(格式 &quot;时间戳-递增数字&quot;)<br>field value : 消息对 (类似Hash哈希键值对)</td> <td>添加 消息队列</td></tr> <tr><td>XREAD [COUNT count] [BLOCK milliseconds] STREAMS key ID</td> <td>COUNT count : 读取最大数<br>BLOCK milliseconds : 等待时长ms(0永久阻塞)<br>key : 指定队列名称<br>ID : 起始id开始读取 (0第一个开始 ; $最新消息开始)</td> <td>读 消息队列</td></tr></tbody></table> <p><strong>读取方式 :</strong></p> <ul><li>阻塞等待读取最新一条消息 : XREAD BLOCK 0 STREAMS key $</li> <li>读取所有消息(数值越大读越多) : XREAD COUNT 99 STREAMS key 0</li></ul> <h4 id="消费者组"><a href="#消费者组" class="header-anchor">#</a> 消费者组</h4> <p>顾名思义 , 就是将多个消费者进行分别组队 , 监听一个队列即可</p> <p>消息都会有一个状态 <code>pending</code>(表示未读) , 并且存储到 <code>pending-list</code>列表 中等待消费 , 直到 XACK命令 确认该消息完成 , 才会清除 <code>pending-list</code>列表中的指定消息 !</p> <p><strong>特点 :</strong></p> <ul><li>分流消息(消息分布到组内 , 而不是重复消息)</li> <li>标识消息(标识消息是否已读 , 保证消息读取)</li> <li>确认消息(确认消息清除消息的标识)</li></ul> <p><strong>命令</strong></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 创建 , 创建消费者组 . ID : 起始id开始读取 (0第一个开始 ; $最新消息开始)</span>
XGROUP CREATE key groupName ID <span class="token punctuation">[</span>MKSTREAM<span class="token punctuation">]</span>
<span class="token comment"># 删除 , 指定 消费者组</span>
XGROUP DESTORY key groupName
<span class="token comment"># 添加 , 指定 消费者组 添加 消费者</span>
XGROUP CREATECONSUMER key groupname consumername
<span class="token comment"># 删除 , 指定 消费者组 删除指定 消费者</span>
XGROUP DELCONSUMER key groupname consumername
<span class="token comment"># 读取 , 指定 消费者组中的消费者 的数据(ID可以为 '&gt;' 下一个未消费的消息开始) </span>
XREADGROUP GROUP group consumer <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span> <span class="token punctuation">[</span>BLOCK milliseconds<span class="token punctuation">]</span> STREAMS key ID 
</code></pre></div><h3 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h3> <p>Redis值放在内存中 , 为防止突然断电等特殊情况的发生 , 需要对数据进行持久化备份 . 即将内存数据保存到硬盘</p> <p>Reids有两种持久化 :</p> <ul><li><a href="#RDB%E6%8C%81%E4%B9%85%E5%8C%96">RDB持久化</a></li> <li><a href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96">AOF持久化</a></li></ul> <h4 id="rdb持久化"><a href="#rdb持久化" class="header-anchor">#</a> RDB持久化</h4> <p>RDB 是采用二进制进行备份文件(数据快照) . 将内存的所有数据保存起来 , 故障修复后读取备份文件</p> <p>一般情况在特定时间 , 执行备份 , 持久化结束后 , 替换上一次持久化的文件 , 达到更新效果</p> <p>主动备份文件 在Redis主进程里执行命令 : (数据量大可能会较慢)</p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td><code>save</code></td> <td>主线程备份 , 会阻塞其他命令</td></tr> <tr><td><code>bgsave</code></td> <td>异步线程备份</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>如果是主动停机 , Redis会自动执行一次 RDB持久化</p></div> <p><strong>bgsave运作过程</strong></p> <ol><li>调用 fork() 函数 , 创建 子进程  , 进行备份数据 (此时 子进程和主进程 内存是共享的)</li> <li>备份完后 , 覆盖旧 备份文件</li></ol> <p>::: nate 读写共存情况</p> <p>fork采用的是 copy-on-write技术 :</p> <ul><li>当主进程执行 读操作 时 , 访问共享内存</li> <li>当主进程执行 写操作 时 , 则会拷贝一份数据 , 执行写操作</li></ul> <p>极端情况 : 备份过程 , 如果大量些数据 , 消耗的较高 , 需要提前预留内存!!!</p> <p>:::</p> <p><strong>RDB配置</strong></p> <p>Redis根目录下的 <code>redis.conf</code>文件</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># dbfilename：RDB持久化的文件名称</span>
dbfilename dump.rdb
<span class="token comment"># dir：文件保存的路径(reids根目录)</span>
dir ./ 
<span class="token comment"># 快照触发 save 机制</span>
<span class="token comment"># 900s 内 更变操作1 : 触发save</span>
<span class="token comment"># 300s 内 更变操作10 : 触发save</span>
<span class="token comment"># 60s 内 更变操作10000 : 触发save</span>
save 900 1
save 300 10
save 60 10000
<span class="token comment"># 当 save中途出现异常时 , 是否阻塞客户端 更变操作 (可能因为磁盘 满了/故障 导致异常)</span>
stop-writes-on-bgsave-error yes
<span class="token comment"># rdbcompression : 是否压缩备份文件(会损耗CPU,不建议启动)</span>
rdbcompression no
</code></pre></div><h4 id="aof持久化"><a href="#aof持久化" class="header-anchor">#</a> AOF持久化</h4> <p>AOF 是通过 Reids处理写命令后会追加记录在AOF文件 , 可查看的命令日志文件</p> <p>当需要恢复数据时直接读取AOF文件 , 还原所有的操作过程 , AOF文件内容是字符串 , 便于阅读</p> <p><strong>AOF配置</strong></p> <p>Redis根目录下的 <code>redis.conf</code>文件</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># appendonly : 启动AOF功能 (默认no)</span>
appendonly yes
<span class="token comment"># appendfilename : 指定aof文件名称</span>
appendfilename appendonly.aof
<span class="token comment"># appendfsync :  指定aof操作中文件同步策略</span>
<span class="token comment"># 三个参数：always/everysec/no (默认everysec)</span>
appendfsync everysec
<span class="token comment"># todo 在aof-rewrite期间，appendfsync是否暂缓文件同步，&quot;no&quot;表示“不暂缓”，“yes”表示“暂缓”，默认为“no”</span>
no-appendfsync-on-rewrite no
<span class="token comment"># AOF触发重写 : 超过指定容量 单位mg,gb(默认64mb;建议512mb)</span>
auto-aof-rewrite-min-size 64mb
<span class="token comment"># AOF触发重写 : 比上次重写超过指定百分比 </span>
<span class="token comment"># 每次触发AOF记录 , 都会检测大小 , 从而进行判断下次重写时机</span>
auto-aof-rewrite-percentage 100
</code></pre></div><p><strong>重写机制</strong></p> <p>手动重写 (Reids执行命令) : <code>bgrewriteaof</code></p> <div class="custom-block note"><p class="custom-block-title">假如没有重写机制</p> <p>当AOF文件读取执行命令时 , 可能会出现对同一个key进行多次写操作 , 但只有最后一次写操作的记录 , 那么前面的写操作则没有意义 . 为此AOF提供了重写机制 , 仅保留最后写key的数据
执行重写后AOF文件是无法阅读的</p></div> <p><strong>appendfsync 文件同步策略</strong></p> <table><thead><tr><th style="text-align:center;">配置项</th> <th style="text-align:center;">记录时机</th> <th style="text-align:center;">优点</th> <th style="text-align:center;">缺点</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>Always</code></td> <td style="text-align:center;">同步写操作记录</td> <td style="text-align:center;">可靠</td> <td style="text-align:center;">性能影响大 ; 频繁IO操作</td> <td style="text-align:center;">每次执行写命令后立即记录</td></tr> <tr><td style="text-align:center;"><code>everysec</code></td> <td style="text-align:center;">每秒记录</td> <td style="text-align:center;">适中</td> <td style="text-align:center;">时效性问题 , 最多失去1s数据</td> <td style="text-align:center;">1秒前写命令的会存储到AOF缓冲区中 , 1秒后将缓冲区数据进行记录</td></tr> <tr><td style="text-align:center;"><code>no</code></td> <td style="text-align:center;">操作系统控制</td> <td style="text-align:center;">最好</td> <td style="text-align:center;">可靠性差 , 逻辑不好可能丢失数据</td> <td style="text-align:center;">写命令的会存储到AOF缓冲区中 , 由操作系统决定将缓冲区数据进行记录</td></tr></tbody></table> <h4 id="rdb与aof区别"><a href="#rdb与aof区别" class="header-anchor">#</a> RDB与AOF区别</h4> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;"><strong>RDB</strong></th> <th style="text-align:center;"><strong>AOF</strong></th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>宕机恢复</strong></td> <td style="text-align:center;">快</td> <td style="text-align:center;">慢</td></tr> <tr><td style="text-align:center;"><strong>容量大小</strong></td> <td style="text-align:center;">体积小 , 含有压缩</td> <td style="text-align:center;">体积大 , 时刻记录写命令</td></tr> <tr><td style="text-align:center;"><strong>内容可读</strong></td> <td style="text-align:center;">否</td> <td style="text-align:center;">是 (重写不可读)</td></tr> <tr><td style="text-align:center;"><strong>数据结构</strong></td> <td style="text-align:center;">二进制</td> <td style="text-align:center;">字符串</td></tr> <tr><td style="text-align:center;"><strong>持久化方式</strong></td> <td style="text-align:center;">快照存储</td> <td style="text-align:center;">记录存储</td></tr> <tr><td style="text-align:center;"><strong>数据完整性</strong></td> <td style="text-align:center;">不完整 , 两次备份数据会丢失</td> <td style="text-align:center;">相对完整 , 取决记录方式</td></tr> <tr><td style="text-align:center;"><strong>恢复优先级</strong></td> <td style="text-align:center;">低 , 完整性不如AOF</td> <td style="text-align:center;">高 , 数据完整度相对较高</td></tr> <tr><td style="text-align:center;"><strong>资源占用</strong></td> <td style="text-align:center;">高 , 消耗大量CPU和内存</td> <td style="text-align:center;">低 , 消耗磁盘IO读写 (重写会消耗CPU和内存)</td></tr> <tr><td style="text-align:center;"><strong>使用场景</strong></td> <td style="text-align:center;">灾难性恢复</td> <td style="text-align:center;">对数据安全性要求较高</td></tr></tbody></table> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>RDB与AOF 各有自己的优缺点 , 如果对数据的安全性要求高的情况 , 一般会采用两者结合使用</p> <p>相信以后会将这两种方案进行统合~</p></div> <h3 id="主从机制"><a href="#主从机制" class="header-anchor">#</a> 主从机制</h3> <p>Redis是指Reids主服务器 , 将数据拷贝到其他Reids从服务器上 , 从而搭建成主从集群 , 实现读写分离</p> <div class="custom-block note"><p class="custom-block-title">为了更好理解</p> <ul><li><p>主服务器 <code>master</code></p></li> <li><p>从服务器 <code>slave</code>/<code>replication</code></p></li></ul></div> <p><strong>主从复制作用 :</strong></p> <ul><li>故障恢复 : master 发生故障，由 slave 提供服务，直至 master 修复</li> <li>数据冗余 : 实现数据同步备份，持久化之外的数据备份方式</li></ul> <p><strong>主从复制原理 :</strong></p> <ol><li>slave 向 master 发送同步请求 , 携带replid和offset , master 也响应 replid和offset , slave 更新版本信息 (此时会响应OK)</li> <li>master 每次触发执行 <code>bgsave</code> 后 , 都会建 RDB文件 发送给 slave , slave 接收后会清空内存并加载RDB文件</li> <li>发送记录 master 期间的命令 , 通过 <code>repl_baklog</code> 发送到 slave 进行同步指令信息</li></ol> <div class="custom-block note"><p class="custom-block-title">步骤1 关键字说明</p> <p><strong>replid :</strong> 数据集标记 , 一般用于判断数据集是否一致/第一次同步</p> <p><strong>offset :</strong> 偏移量 , 随着记录 <code>repl_baklog</code> 越来越大 . 需要通过偏移量控制更新范围</p></div> <p><strong>实现 :</strong></p> <ol><li>启动Reids两个以上</li> <li>连接 , slave 执行连接命令 以下两个其中一个连接命令
<ul><li><code>SLAVEOF host port</code> (5.0前版本)</li> <li><code>SRPLICAOF host port</code> (5.0后版本)</li></ul></li> <li>验证 , master 查看状态命令 <code>INFO replication</code></li></ol> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>搭建主从思路可以根据不同 ip/端口 进行搭建多个连接应用</p></div> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>一旦连接成功 , 自动同步</li> <li>slave 只能读不能写 ; master 能读写</li> <li>slave 宕机时间不能够久 , 过久可能会导致数据同步不到位</li></ul></div> <h3 id="哨兵模式"><a href="#哨兵模式" class="header-anchor">#</a> 哨兵模式</h3> <p>哨兵模式(Sentinel) 是 监视多个Redis服务器的状态 . Sentinel可以有多个 组成Sentinel系统</p> <p><strong>作用 :</strong></p> <ul><li>系统监控 : 按指定频率PING命令检查 master 和 slave 状态 (默认1s一次)</li> <li>故障修复 : 如果 master 故障 , Sentinel会自选举一个 slave 升为 master , 当故障实例恢复后以新 master 为主(按照权重选举)</li> <li>状态通知 : Sentinel充当Reids实例 , 当集群故障转移 , 会进行一次通知</li></ul> <p><strong>心跳监控机制</strong></p> <p>Sentinel每秒会PING检查实例运作状态 , 下线状态有两种可能 : (Sentinel集群状态下)</p> <ul><li>主观下线 : 某个 Sentinel 检测实例未响应 , 视为 客观下线</li> <li>客观下线 : 多个 Sentinel 检测实例未响应 , 且超过指定 quorun值 , 则视为 客观下线</li></ul> <blockquote><p>建议 : <code>quorun</code>值 最好是 Sentinel集群 数量的一般以上</p></blockquote> <p><strong>选举机制</strong></p> <p>Sentinel一旦发现 master 故障 , Sentinel选举一个 slave 升为 master , 选举依据 :</p> <ol><li>排除选举 , 会判断原先的 slave和master 断开时长记录 , 如果超过指定值 (down - after - milliseconds * 10) , 则视为 老旧实例节点(不靠谱) , 进行排除</li> <li>判断 slave 的 slave-priority值(权重) , 越小优先级越高 , 0则不选举 (默认100)</li> <li>如果 slave-priority值 一致的实例 , 那么判断 offset值 , 越大数据越新 , 优先级也就越高</li> <li>判断 slave 运行id的大小 , 越小优先级越高</li></ol> <p><strong>转移机制</strong></p> <p>Sentinel选举一个实例作为新的 master 时 , 运作步骤如下 :</p> <ol><li>选举master , 对选中的 slave 发送执行命令 <code>SLAVEOF no noe</code> , 称为 新的 master</li> <li>广播其他 slave 发送执行命令 <code>SLAVEOF host port</code>/<code>SLAVEOF host port</code> (指定 新master 的IP和端口)</li> <li>旧实例的 master , 会被标记为 slave , 但实例故障恢复后也会执行 步骤2的命令</li></ol> <div class="custom-block tip"><p class="custom-block-title">Redis版本指令更变</p> <ul><li><code>SLAVEOF host port</code> (5.0前版本)</li> <li><code>SRPLICAOF host port</code> (5.0后版本)</li></ul></div> <p><strong>实现 :</strong></p> <details class="custom-block details"><summary>哨兵代码示例 点击展开</summary> <p>假设节点实例</p> <table><thead><tr><th>节点实例</th> <th>IP</th> <th>PORT</th></tr></thead> <tbody><tr><td>s1</td> <td>192.168.150.101</td> <td>20001</td></tr> <tr><td>s2</td> <td>192.168.150.101</td> <td>20002</td></tr> <tr><td>r1(master)</td> <td>192.168.150.101</td> <td>6379</td></tr> <tr><td>r2(slave)</td> <td>192.168.150.101</td> <td>6380</td></tr> <tr><td>r3(slave)</td> <td>192.168.150.101</td> <td>6381</td></tr></tbody></table> <ol><li><p>创建目录</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 创建目录</span>
<span class="token function">mkdir</span> s1 s2
</code></pre></div></li> <li><p>在 s1 , s2 目录中 , 配置<code>sentinel.conf</code>文件 (要配置s1和s2)</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># 当前s1端口</span>
port 20001
<span class="token comment"># 当前s1 IP地址</span>
sentinel announce-ip 192.168.150.101
<span class="token comment"># 定义主节点master名为 mymaster(任意) ; IP ; 端口 ; quorun(掉线判断)</span>
sentinel monitor mymaster 192.168.150.101 7001 2
<span class="token comment"># slave与master 断开的 超时时间</span>
sentinel down-after-milliseconds mymaster 5000
<span class="token comment"># 实例故障恢复的 超时时间</span>
sentinel failover-timeout mymaster 60000
<span class="token comment"># 工作目录</span>
dir &quot;/tmp/s1&quot;
</code></pre></div></li> <li><p>启动 Sentinel哨兵模式</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-sentinel /tmp/s1/sentinel.conf
redis-sentinel /tmp/s2/sentinel.conf
<span class="token comment"># 也可 Reids中的Sentinel配置运行(不用服务器情况下)</span>
redis-server redis.conf <span class="token parameter variable">--sentinel</span>
</code></pre></div></li> <li><p>测试 , 保证 s1 , s2 , r1 , r2 , r3 正常运作</p> <ol><li>进程查看 <code>ps -aux|grep redis</code></li> <li>进程消灭 r1(master) <code>KILL 9 pid</code> (模拟master宕机)</li> <li>状态检查 <code>INFO replication</code> , 查看是否转化为 master</li> <li>日志检查 Reids根据的 <code>reids.log</code> 文件可以查阅(可得知变化的状态)</li></ol></li></ol></details> <h4 id="哨兵redistemplate访问"><a href="#哨兵redistemplate访问" class="header-anchor">#</a> 哨兵RedisTemplate访问</h4> <p>StringBoot中的RedisTemplate底层通过 lettuce实现 对节点的监控和自动切换</p> <details class="custom-block details"><summary>代码示例 点击展开</summary> <ol><li><p>依赖配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">redis</span><span class="token punctuation">:</span>
		<span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
			<span class="token comment"># 指定naster名称</span>
			<span class="token key atrule">master</span><span class="token punctuation">:</span> mymaster
			<span class="token comment"># 指定redis-sentinel集群信息</span>
			<span class="token key atrule">nodes</span><span class="token punctuation">:</span> 
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">20001</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">20002</span>
</code></pre></div></li> <li><p>配置类 , 写在Redis配置类即可</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LettuceclientConfigurationBuilderCustomizer</span> <span class="token function">configurationBuilderCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> configBuilder <span class="token operator">-&gt;</span> configBuilder<span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span><span class="token class-name">ReadFrom</span><span class="token punctuation">.</span><span class="token constant">REPLICA_PREFERRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>运行测试即可 , 可以在控制台看见日志情况</p> <blockquote><p>需要配置日志依赖 , 用于查阅日志变动情况</p></blockquote></li></ol> <p>在配置类中 , 我们可以看见有 ReadFrom枚举选择 , 读取策略</p> <table><thead><tr><th>ReadFrom枚举</th> <th>说明</th></tr></thead> <tbody><tr><td>MASTER</td> <td>从 master 读取</td></tr> <tr><td>MASTER_PREFERRED</td> <td>优先从 master 读取 , 不可用才读取 slave</td></tr> <tr><td>REPLICA</td> <td>从 slave 读取</td></tr> <tr><td>REPLICA_PREFERRED</td> <td>优先从 slave 读取 , 不可用才读取 master (建议)</td></tr></tbody></table></details> <h3 id="集群-2"><a href="#集群-2" class="header-anchor">#</a> 集群</h3> <p>Redis集群是由一个以上的多个实例节点组成的分布式服务器 , 解决了 高并发/高可用/稳定高 问题</p> <p><strong>优点 :</strong></p> <ul><li>将数据 自动切分(slot) 到多个节点的能力</li> <li>部分实例节点宕机 , 仍然保持通信应用 , 无需哨兵 , 自带主从切换</li></ul> <p><strong>redis-cluste集群方案</strong></p> <p>Redis-Cluster采用无中心结构 , 每个节点保存数据和整个集群状态 , 每个节点都和其他所有节点连接</p> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-01.png" alt=""></p> <p><strong>结构/特点 说明</strong></p> <ol><li>所有redis节点都是彼此互联 , 且每个Reids都是 master . 内部使用二进制协议优化传输速率</li> <li>所有reids之间通过 PING命令 检测彼此健康状态</li> <li>client 与 redis节点是直连的 , 无需中间层 , client 只需连接任意一个redis节点即可应用</li> <li>当 Redis集群 任意 master 宕机 , 且当前 master 没有 slave , 则 Redis-Cluster 为 fail 状态 (但 slot映射 不完全进入 fail状态)</li> <li>当 Redis-Cluster 中 master 挂掉一半以上 , 则 Redis-Cluster 为 fail 状态</li></ol> <h4 id="集群搭建"><a href="#集群搭建" class="header-anchor">#</a> 集群搭建</h4> <p><strong>节点实例 :</strong></p> <table><thead><tr><th style="text-align:center;">IP</th> <th style="text-align:center;">PORT</th> <th style="text-align:center;">角色</th></tr></thead> <tbody><tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7001</td> <td style="text-align:center;">master</td></tr> <tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7002</td> <td style="text-align:center;">master</td></tr> <tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7003</td> <td style="text-align:center;">master</td></tr> <tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7004</td> <td style="text-align:center;">slave</td></tr> <tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7005</td> <td style="text-align:center;">slave</td></tr> <tr><td style="text-align:center;">192.168.150.101</td> <td style="text-align:center;">7006</td> <td style="text-align:center;">slave</td></tr></tbody></table> <p><strong>结构图 :</strong></p> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-03.png" alt=""></p> <p><strong>步骤 :</strong></p> <details class="custom-block details"><summary>代码示例 点击展开</summary> <ol><li><p>新建集群目录</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 创建目录</span>
<span class="token function">mkdir</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span> <span class="token number">7006</span>
</code></pre></div></li> <li><p>在 /tmp 创建一个新的 <code>redis.conf</code></p> <div class="language-ini extra-class"><pre class="language-ini"><code>port 6379
<span class="token comment"># 开启集群功能</span>
cluster-enabled yes
<span class="token comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span>
cluster-config-file /tmp/6379/nodes.conf
<span class="token comment"># 节点心跳失败的超时时间</span>
cluster-node-timeout 5000
<span class="token comment"># 持久化文件存放目录</span>
dir /tmp/6379
<span class="token comment"># 绑定地址</span>
bind 0.0.0.0
<span class="token comment"># 让redis后台运行</span>
daemonize yes
<span class="token comment"># 注册的实例ip</span>
replica-announce-ip 192.168.150.101
<span class="token comment"># 保护模式</span>
protected-mode no
<span class="token comment"># 数据库数量</span>
databases 1
<span class="token comment"># 日志</span>
logfile /tmp/6379/run.log
</code></pre></div></li> <li><p>拷贝 到节点目录并批更改 (配置自行检查进入下一步)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 执行拷贝</span>
<span class="token builtin class-name">echo</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span> <span class="token number">7006</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token function">cp</span> redis.conf
<span class="token comment"># 更改配置</span>
<span class="token builtin class-name">printf</span> <span class="token string">'%s\n'</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span> <span class="token number">7006</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/6379/{}/g'</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
</code></pre></div></li> <li><p>一键启动所有服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">printf</span> <span class="token string">'%s\n'</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span> <span class="token number">7006</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-server <span class="token punctuation">{</span><span class="token punctuation">}</span>/redis.conf
</code></pre></div></li> <li><p>集群检查 , <code>ps -ef | grep redis</code> 观察端口运行状态信息</p></li> <li><p>集群连接 , 通过 <code>redis-cli --cluster</code>命令搭建集群 (5.0以上版本)</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-cli <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7001 <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7002 <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7003 <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7004 <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7005 <span class="token punctuation">\</span>
<span class="token number">192.168</span>.150.101:7006 <span class="token punctuation">\</span>
</code></pre></div></li> <li><p>集群查看</p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
</code></pre></div></li> <li><p>测试... . 集群进入操作时命令需要加上 <code>-c</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code>redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">7001</span>
</code></pre></div></li> <li><p>一键关闭</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token builtin class-name">printf</span> <span class="token string">'%s\n'</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span> <span class="token number">7006</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token parameter variable">-t</span> redis-cli <span class="token parameter variable">-p</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token function">shutdown</span>
</code></pre></div></li></ol> <p>步骤6的参数说明 :</p> <table><thead><tr><th>参数/指令</th> <th>说明</th></tr></thead> <tbody><tr><td>redis-cli --cluster</td> <td>集群指令</td></tr> <tr><td>create</td> <td>创建集群</td></tr> <tr><td>--cluster-replicas n</td> <td>根据 <code>节点总数 ÷ (n+1)</code> 得到master的数量 , 节点列表中的前 n 个就为 master , 其余的为 slave</td></tr></tbody></table></details> <p><strong>新增实例节点</strong></p> <details class="custom-block details"><summary>点击展开</summary> <p>添加新的 master : <code>redis-cli --cluster add-node new_host:new_port existing_host:existing_port</code></p> <ol><li><p>加入集群 , 添加新实例节点 master 7007 . 后面的旧实例作为通知引用</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 在以上集群基础上添加实例节点</span>
redis-cli <span class="token parameter variable">--cluster</span> add-node <span class="token number">192.168</span>.150.101:7007 <span class="token number">192.168</span>.150.101:7001
</code></pre></div></li> <li><p>分配slot , 将7001 插槽分配给 7007 , 7007加入集群是没有插槽分配的(没有插槽等同于没有集群效果)</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 先查看节点 id/插槽量 , 记录他们的 集群节点的id</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
<span class="token comment"># 指定实例分配插槽</span>
redis-cli <span class="token parameter variable">--cluster</span> reshard <span class="token number">192.168</span>.150.101:7001
<span class="token comment"># 1询问 : 你需要分配多少插槽 : 3000</span>
<span class="token comment"># 2询问 : 谁进行接受插槽分配 : 7004的节点id</span>
<span class="token comment"># 3询问 : 从哪数据源进行拷贝 : 7001的节点id =&gt; done完成</span>
</code></pre></div></li> <li><p>测试即可</p></li></ol> <p>添加新的 slave : <code>redis-cli --cluster --cluster-slave --cluster-master-id &lt;arg&gt; new_host:new_port existing_host:existing_port</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 先查看节点 id/插槽量 , 记录他们的 集群节点的id</span>
redis-cli <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster nodes
<span class="token comment"># 将 7007 作为 7001 的 slave </span>
redis-cli <span class="token parameter variable">--cluster</span> --cluster-slave --cluster-master-id <span class="token punctuation">{</span><span class="token number">7001</span>节点Id<span class="token punctuation">}</span> <span class="token number">192.168</span>.150.101:7007 <span class="token number">192.168</span>.150.101:7001
</code></pre></div></details> <h4 id="散列插槽slot"><a href="#散列插槽slot" class="header-anchor">#</a> 散列插槽slot</h4> <p>Redis集群 采用虚拟哈希插槽分区(hash slot) , 将写入的 Key 计算得到需要映射的slot , slot映射一共有 [0-16383] 个 , 这些slot会分配到每个 master节点上 , 从而实现分工合作</p> <p>映射求余计算公式 : <code>slot = CRC16(key) &amp; 16383</code></p> <p>观察slot节点分配 : <code>redis-cli -p 7001 cluster nodes</code></p> <div class="custom-block note"><p class="custom-block-title">控制key存到指定slot</p> <p>可以通过写命令的 key前缀加上 <code>{typeId}</code> 即可实现 , 例如 : <code>set {a}num 123</code></p></div> <p><strong>slot映射 结构图 :</strong></p> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-02.png" alt=""></p> <h4 id="集群redistemplate访问"><a href="#集群redistemplate访问" class="header-anchor">#</a> 集群RedisTemplate访问</h4> <p>StringBoot中的RedisTemplate底层通过 lettuce实现 对集群监控等支持</p> <details class="custom-block details"><summary>代码示例 点击展开</summary> <ol><li><p>引入依赖</p></li> <li><p>配置文件 , 配置地址</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">redis</span><span class="token punctuation">:</span>
		<span class="token key atrule">cluster</span><span class="token punctuation">:</span>
			<span class="token comment"># 指定集群</span>
			<span class="token key atrule">nodes</span><span class="token punctuation">:</span> 
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7001</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7002</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7003</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7004</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7005</span>
				<span class="token punctuation">-</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">7006</span>
</code></pre></div></li> <li><p>Redis配置类 , 配置读写分离</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LettuceclientConfigurationBuilderCustomizer</span> <span class="token function">configurationBuilderCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> configBuilder <span class="token operator">-&gt;</span> configBuilder<span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span><span class="token class-name">ReadFrom</span><span class="token punctuation">.</span><span class="token constant">REPLICA_PREFERRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>运行测试即可 , 可以在控制台看见日志情况</p> <blockquote><p>需要配置日志依赖 , 用于查阅日志变动情况</p></blockquote></li></ol></details> <h3 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h3> <p>分布式锁是多个服务器在同一系统中可服务器多个进程对资源的访问</p> <p>Redis为单进程 单线程模式 , 采用队列模式将并发访问变成串行访问 , 且多客户端对Redis的连接并不存在竞争 关系。redis也可实现分布式锁</p> <p><a href="https://blog.csdn.net/weixin_45963193/article/details/114016342#C7" target="_blank" rel="noopener noreferrer">点击了解线程同步<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>意图 :</strong> 节省资源空间</p> <p><strong>应用满足条件</strong></p> <ol><li>系统是一个分布式的系统</li> <li>资源共享 (各个系统访问同一数据库)</li> <li>同步访问 (多个进程同时访问同一个资源)</li></ol> <p><strong>redis分布式锁命令</strong></p> <p><strong>SETNX</strong> ==SETNX key value==
key存在 , 不做操作 ; key不存在则设值</p> <p><strong>GETSET</strong> ==GETSET key value==
先获取key对应的旧值 , 且新值覆盖替换旧值</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>用完锁一定要释放</li> <li>锁一定要加过期时间</li></ul></div> <h3 id="多级缓存"><a href="#多级缓存" class="header-anchor">#</a> 多级缓存</h3> <p>多级缓存架构图 :</p> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-08.png" alt=""></p> <p>多层缓存 , 分别说明缓存层级 : (可以根据情况优化)</p> <ol><li>OpenResty Nginx 字典 本地缓存</li> <li>Redis缓存</li> <li>JVM缓存 (集群需要依赖 负载均衡的 Hash分配策略)</li></ol> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>以上实现目的是为了突破 Tomcat 接收压力瓶颈问题 , 从而选举优化方案!</p></div> <h4 id="jvm进程缓存"><a href="#jvm进程缓存" class="header-anchor">#</a> JVM进程缓存</h4> <p>JVM缓存通过Caffeine实现 , 基于Java8 , 使用方式和HashMap一样 , 提供缓存访问 , 可防止库击穿</p> <p><strong>GitHub地址 :</strong> <a href="https://github.com/ben-manes/caffeine" target="_blank" rel="noopener noreferrer">https://github.com/ben-manes/caffeine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block note"><p class="custom-block-title">JVM缓存的存在意义</p> <p>可防止同一时间内 , 以最小缓存 , 实现最高性能 , 一定要设置驱逐策略(删除)</p></div> <p><strong>对象构造选项</strong></p> <table><thead><tr><th>链式方法</th> <th>说明</th></tr></thead> <tbody><tr><td><code>maximumSize()</code></td> <td>最大缓存量(key数量)</td></tr> <tr><td><code>expireAfterWrite()</code></td> <td>缓存超时过期时长</td></tr> <tr><td><code>initialCapacity()</code></td> <td>初始化缓存量(key数量)</td></tr></tbody></table> <div class="custom-block tip"><p class="custom-block-title">缓存清除策略</p> <p>一般在构建缓存对象时候 , 指定 <strong>过期时间</strong> / <strong>容量上限</strong> 删除策略 , 一般采用过期时间 , GC垃圾回收就不用指望了~</p></div> <p><strong>思路 :</strong> 先实现集群中的JVM缓存 , 通过OpenResty对URI进行哈希运算 , 采用哈希值抉择集群中的主机 , 从而实现同一请求同一主机 , 快速响应 , 从而提高性能 !</p> <p><strong>应用 :</strong></p> <details class="custom-block details"><summary>JVM缓存代码示例 点击展开</summary> <p><strong>依赖</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.ben-manes.caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBasicOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建缓存对象</span>
    <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存数据</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sans&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取数据，不存在则返回null</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name = &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取数据，不存在则去数据库查询</span>
    <span class="token class-name">String</span> defaultGF <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里可以去数据库根据 key查询value</span>
        <span class="token keyword">return</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;defaultGF = &quot;</span> <span class="token operator">+</span> defaultGF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="多级缓存-2"><a href="#多级缓存-2" class="header-anchor">#</a> 多级缓存</h4> <p>OpenResty 共享字典缓存 : <a href="/other/exa9a2/Nginx%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98">传送门跳转</a></p> <h4 id="同步缓存"><a href="#同步缓存" class="header-anchor">#</a> 同步缓存</h4> <p>通过 Canal 同步缓存 : <a href="/other/ceats1">传送门跳转</a></p> <p><strong>缓存同步策略</strong></p> <p>缓存数据同步的常见方式有三种：</p> <ul><li><p><strong>设置有效期</strong></p> <p>给缓存设置有效期 , 到期后自动删除 , 直到再次查询时更新</p></li> <li><p><strong>同步双写</strong></p> <p>在修改数据库的同时，直接修改缓存</p></li> <li><p><strong>异步通知</strong></p> <p>修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p></li></ul> <p><strong>区别 :</strong></p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">有效期</th> <th style="text-align:center;">同步双写</th> <th style="text-align:center;">异步通知</th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>优点</strong></td> <td style="text-align:center;">简单 , 直接</td> <td style="text-align:center;">数据时效性强</td> <td style="text-align:center;">低耦合 , 通知多个缓存</td></tr> <tr><td style="text-align:center;"><strong>缺点</strong></td> <td style="text-align:center;">数据时效性差(过期前)</td> <td style="text-align:center;">耦合性高</td> <td style="text-align:center;">时效性一般 , 服务状态不一致</td></tr> <tr><td style="text-align:center;"><strong>场景</strong></td> <td style="text-align:center;">更新频率低 , 时效性要求低</td> <td style="text-align:center;">对一致性 , 时效性敏感</td> <td style="text-align:center;">一般 , 有多个服务需要同步</td></tr></tbody></table> <h3 id="redisson应用"><a href="#redisson应用" class="header-anchor">#</a> Redisson应用</h3> <p>回顾 以往实现的SETNX存在诸多问题</p> <div class="custom-block note"><p class="custom-block-title">SETNX问题</p> <p><strong>重写问题 :</strong> 同一线程 , 无法多次获取同一把锁</p> <p><strong>不可重试 :</strong> 线程获取锁只能一次尝试 , 没有重试机制</p> <p><strong>超时释放 :</strong> 锁的过期 过短 , 存在线程安全问题 ; 太长 , 存在阻塞情况(左右为难)</p> <p><strong>主从不一致 :</strong> 主从集群情况下 , 同步有延迟 , 当写数据加锁 , 主未同步完从数据 , 主宕机了且业务又没完成 , 那么很有可能出现死锁 , 只能无奈等锁过期~</p></div> <p>因此需要一个成熟的框架Redisson去实现逻辑</p> <p>Redisson是 Redis基础上实现分布式工具框架 , 底层的通过Lua脚本实现 , 分布式场景各种各样的工具均可实现</p> <p>Redisson提供了一下分布式工具服务 :</p> <ul><li>可重入锁</li> <li>公平锁</li> <li>联锁</li> <li>红锁</li> <li>读写锁</li> <li>闭锁</li> <li>...</li></ul> <p><strong>官方 :</strong> <a href="https://redisson.org" target="_blank" rel="noopener noreferrer">https://redisson.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>GitHub :</strong> <a href="https://github.com/redisson/redisson" target="_blank" rel="noopener noreferrer">https://github.com/redisson/redisson<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>个人笔记应用 :</strong> <a href="/backend/40kn39/#Redisson应用">传送门</a></p> <h4 id="可重入锁"><a href="#可重入锁" class="header-anchor">#</a> 可重入锁</h4> <p>可重入锁 是 在一个业务方法中调用了其他业务 , 且该业务也存在锁 , 可以理解为锁中锁 .</p> <p>在Session中 可重入锁 value采用Hash结构存储 , field(Hash中的key)和value 它们分别是 当前线程标识 和 锁的层级(嵌套有多少层) . 每获取一次锁都会自增1(锁层级)</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>获取锁和释放锁 , 不管在那个业务它们都是成对出现的 !</p></div> <details class="custom-block details"><summary>可重入锁代码示例 点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;确保是自己的锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;1. 获取锁 成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">business2</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;1. 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business2</span><span class="token punctuation">(</span><span class="token class-name">RLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;确保是自己的锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;2. 获取锁 成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;2. 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>PS :</strong> 断点观察锁中的Hash变化情况~</p></details> <h4 id="获取锁"><a href="#获取锁" class="header-anchor">#</a> 获取锁</h4> <p>视频学习 : <a href="https://www.bilibili.com/video/BV1cr4y1671t/?p=67&amp;share_source=copy_web&amp;vd_source=64dacad77d0b983613675f662d5967b2" target="_blank" rel="noopener noreferrer">详细学习<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token string">&quot;if (redis.call('exists', KEYS[1]) == 0) then &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;redis.call('hset', KEYS[1], ARGV[2], 1); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;redis.call('pexpire', KEYS[1], ARGV[1]); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;return nil; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;end; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;redis.call('hincrby', KEYS[1], ARGV[2], 1); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;redis.call('pexpire', KEYS[1], ARGV[1]); &quot;</span> <span class="token operator">+</span>
    <span class="token string">&quot;return nil; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;end; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;return redis.call('pttl', KEYS[1]);&quot;</span>
</code></pre></div><table><thead><tr><th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>KEYS[1]</td> <td>锁名称</td></tr> <tr><td>ARGV[1]</td> <td>锁失效时间</td></tr> <tr><td>ARGV[2]</td> <td>线程标识<code>threadId:id</code></td></tr></tbody></table> <div class="custom-block note"><p class="custom-block-title">lua脚本</p> <p>传参就说明到此 , Redis命令 细品</p></div> <h4 id="释放锁"><a href="#释放锁" class="header-anchor">#</a> 释放锁</h4> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token string">&quot;if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;return nil;&quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;end; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;if (counter &gt; 0) then &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;redis.call('pexpire', KEYS[1], ARGV[2]); &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;return 0; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;else &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;redis.call('del', KEYS[1]); &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;redis.call('publish', KEYS[2], ARGV[1]); &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;return 1; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;end; &quot;</span> <span class="token operator">+</span>
<span class="token string">&quot;return nil;&quot;</span>
</code></pre></div><table><thead><tr><th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>KEYS[1]</td> <td>锁名称</td></tr> <tr><td>KEYS[2]</td> <td>频道名称(用于订阅通知)</td></tr> <tr><td>ARGV[1]</td> <td>频道消息</td></tr> <tr><td>ARGV[2]</td> <td>锁失效时间</td></tr> <tr><td>ARGV[3]</td> <td>线程标识<code>threadId:id</code></td></tr></tbody></table> <h4 id="分布式锁流程"><a href="#分布式锁流程" class="header-anchor">#</a> 分布式锁流程</h4> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-09.png" alt=""></p> <h4 id="集群分布式锁"><a href="#集群分布式锁" class="header-anchor">#</a> 集群分布式锁</h4> <p>在企业中为了提高效率 , 一般是已集群Reids主从形式搭建为例子</p> <p><strong>问题 :</strong> 我们有5台Reids服务器 , 一台主(写) 四台从(读取) , 当更改数据主会同步从服务器 , 那么这个同步的过程必有可能会存在延迟 , 如果获取锁时主服务器在同步中途突然宕机了 , 因此我们这个锁可能就失效 , 因此可能还存在隐患 !</p> <p><strong>解决思路 :</strong> 将2台设为主服务器 , 3台设为从服务器 , 以防其中一台主服务器宕机导致锁失效的情况</p> <details class="custom-block details"><summary>Java实现</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReidssonConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 RedissonClient</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:6380&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 RedissonClient</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 剩下3台代码一样</span>

<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient1<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient2<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient3<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient4<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient5<span class="token punctuation">;</span>

    <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//lock = redissonClient.getLock(&quot;lock:&quot;+66);</span>

        <span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonClient3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock4 <span class="token operator">=</span> redissonClient4<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock5 <span class="token operator">=</span> redissonClient5<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:&quot;</span><span class="token operator">+</span><span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 连锁</span>
        lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">,</span> lock4<span class="token punctuation">,</span> lock5<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;确保是自己的锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;1. 获取锁 成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">business2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;1. 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;确保是自己的锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;2. 获取锁 成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;2. 释放锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <div class="custom-block note"><p class="custom-block-title">加锁原理</p> <p>Redisson通过 MutiLock锁 为多个主服务器发送加锁 , 并且这些服务器有原子性的操作</p></div> <h2 id="实战技巧"><a href="#实战技巧" class="header-anchor">#</a> 实战技巧</h2> <h3 id="key设计"><a href="#key设计" class="header-anchor">#</a> Key设计</h3> <p>Redis的Key是自定义设计的 , 最好遵循以下约定 :</p> <ul><li>格式 : <code>&lt;项目名&gt;:&lt;业务名&gt;:&lt;数据&gt;:&lt;id&gt;</code></li> <li>长度不超 44字节</li> <li>不能包含特殊字符</li></ul> <p><strong>例子 :</strong></p> <p>login:user:10 , 用户登录业务 , 用户信息</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>格式并非固定 , 可根据业务需求情况而变</li> <li>key一定要有个过期时间</li></ul></div> <h3 id="value结构设计"><a href="#value结构设计" class="header-anchor">#</a> Value结构设计</h3> <p>Redis的Value是根据业务需求场景设计 , 最好遵循以下约定 :</p> <ul><li>合理拆分数据 , 避免 BigKey (集合大数据)</li> <li>选择合适的数据结构</li> <li>Hash 数量 建议少于 1k</li> <li>合理设置超时过期时间</li></ul> <div class="custom-block warning"><p class="custom-block-title">BigKey 较大可能导致情况</p> <ul><li>数据倾斜</li> <li>CPU压力</li> <li>网络阻塞</li> <li>Redis阻塞</li></ul></div> <p><strong>发现较大的key :</strong></p> <ul><li>通过命令 <code>redis-cli --bigkeys</code></li> <li>scan扫描</li> <li>第三方工具 RDB分析</li> <li>网络监控</li></ul> <div class="custom-block note"><p class="custom-block-title">假如 有hash类型的key , 当中有 100万 对 键值对 , 如何进行拆分优化?</p> <p><strong>方案 1 :</strong> 拆分 String类型 , 通过JSON转化实现</p> <p><strong>方案 2 :</strong> 拆分 小hash , 根据 id/100 作为 key , 根据 id%100 作为 field , 这样能保证每个小Hash都包含有100个元素</p></div> <h3 id="批处理"><a href="#批处理" class="header-anchor">#</a> 批处理</h3> <h4 id="批量存数据"><a href="#批量存数据" class="header-anchor">#</a> 批量存数据</h4> <p>批量存数据有多种方案 :</p> <ol><li><code>MSET</code>/<code>HMSET</code> 命令批量存储</li> <li>Pipeline 管道存储</li></ol> <p><strong>MSET命令存储</strong></p> <p>减少连接次数 , 发送一条命令多个键值对 , 从而实现快速存数据</p> <p><strong>特点 :</strong></p> <ul><li>只能存String数据</li> <li>占用带宽大 , 容易阻塞</li></ul> <details class="custom-block details"><summary>代码示例 点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token comment">// 连接基本配置 (认证;选择库)</span>
    jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">msetTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">2000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    <span class="token keyword">long</span> op <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 左位移一位 , 保证对低位为0 , 结果永远是偶数位</span>
        <span class="token comment">// 原理 : 2(1*2) , 4(2*2) , 6(3*2) , 8(4*2) , ... , 0(0*2) (i取余为0)</span>
        j <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// key和value 是为一对</span>
        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 耗时: 5947ms (云服务器)</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> op<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <p><strong>Pipeline</strong></p> <p>通过管道形式发送 , 多条命令发送</p> <p><strong>特点 :</strong></p> <ul><li>任意命令组合</li> <li>不具备原子性</li></ul> <details class="custom-block details"><summary>代码示例 点击展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// jedis连接 上面有 就不多写了</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pipelineTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建管道</span>
    <span class="token class-name">Pipeline</span> pipelined <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> op <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将命令放入管道中</span>
        pipelined<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;test:key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 每1000条 , 发送管道发送一次</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pipelined<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 耗时: 5829ms</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> op<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="集群批处理"><a href="#集群批处理" class="header-anchor">#</a> 集群批处理</h4> <p><strong>问题 :</strong> Redis集群 key会根据 hash值 取余 寻找插槽 , 如果多条命令跑去不同的主机上 , 从而导致执行失败</p> <p>了解集群插槽机制 : <a href="#%E6%95%A3%E5%88%97%E6%8F%92%E6%A7%BDslot">传送门跳转</a></p> <p><strong>解决方案 :</strong></p> <ul><li>批处理必须落在一个slot上</li> <li>分组且每组落在一个slot上</li> <li>采用SpringBoot封装的RedisTemp类(解决了插槽问题)</li></ul> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">思路</th> <th style="text-align:center;">优点</th> <th style="text-align:center;">缺点</th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>串行命令</strong></td> <td style="text-align:center;">for循环 , 每次发送执行一条命令</td> <td style="text-align:center;">简单</td> <td style="text-align:center;">耗时大</td></tr> <tr><td style="text-align:center;"><strong>串行slot</strong></td> <td style="text-align:center;">计算每个key , 将 hash取余值归类分组 , 根据归类分组存slot , Pipeline进行批处理 , 串行执行各组命令(每组区分不同主机)</td> <td style="text-align:center;">耗时较短</td> <td style="text-align:center;">实现复杂度高 , slot越多越久</td></tr> <tr><td style="text-align:center;"><strong>并行slot</strong></td> <td style="text-align:center;">计算每个key , 将 hash取余值归类分组 , 根据归类分组存slot , Pipeline进行批处理 , 并行执行各组命令</td> <td style="text-align:center;">非常短</td> <td style="text-align:center;">实现复杂度高</td></tr> <tr><td style="text-align:center;"><strong>hash_tag</strong></td> <td style="text-align:center;">将所有key设置相同 {hash_tag} , 规定所有key到指定slot上 , Pipeline进行批处理</td> <td style="text-align:center;">非常短</td> <td style="text-align:center;">实现复杂度高</td></tr> <tr><td style="text-align:center;"><strong>分组hash_tag</strong></td> <td style="text-align:center;">将所有key设置相同 {hash_tag} , 管道分组设定 hash_tag值 , Pipeline进行批处理</td> <td style="text-align:center;">非常短</td> <td style="text-align:center;">实现复杂度高</td></tr></tbody></table> <p>计算Key所对应的slot</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClusterSlotHashUtil</span><span class="token punctuation">.</span><span class="token function">calculateSlot</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
</code></pre></div><h3 id="redis-模拟百万数据"><a href="#redis-模拟百万数据" class="header-anchor">#</a> Redis 模拟百万数据</h3> <ol><li>库插入百万条数据</li> <li>redis存储定时10s过期</li> <li>循环刷新测试用时</li></ol> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-05.png" alt=""></p> <blockquote><p>见的速度</p></blockquote> <h3 id="服务端优化"><a href="#服务端优化" class="header-anchor">#</a> 服务端优化</h3> <h4 id="持久化优化"><a href="#持久化优化" class="header-anchor">#</a> 持久化优化</h4> <p>Redis的持久化虽然可以保证数据安全 , 但也会带来很多额外的开销 , 因此持久化请遵循下列建议 :</p> <ol><li>用缓存的Redis实例尽可能关闭持久化功能</li> <li>关闭 RDB , 启用 AOF (RDB有数据安全隐患)</li> <li>合理设置 rewrite阈值 , 避免频繁 bgrewrite (控制重写频率)</li> <li>配置 <code>no-appendfsync-on-rewrite = yes</code> , 禁止在重写期间做AOF (可能阻塞)</li> <li>利用定期脚本在 slave 做RDB备份 (最后稻草)</li></ol> <h4 id="慢查询"><a href="#慢查询" class="header-anchor">#</a> 慢查询</h4> <p>Redis执行耗时到达某个阈值的命令 , 称为 慢查询</p> <p><strong>问题 :</strong> Reids收到客户端命令 , 如果执行到慢查询命令 , 后面的其他命令将会在队列等待 慢查询完毕 , 从而导致阻塞情况</p> <p><strong>解决思路 :</strong> 根据日志得知命令的执行时长 , 按业务情况自行优化</p> <p>Redis根目录下的 <code>redis.conf</code>文件</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token comment"># 慢查询阈值 , 单位微秒 (默认是10000 ; 建议1000)</span>
slowlog-log-slower-than 1000
<span class="token comment"># 慢查询日志的上限长度 (默认是128 ; 建议1000)</span>
slowlog-max-len 1000
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>1秒 = 1000毫秒 = 1 000 000微秒</p></div> <p><strong>查看慢查询命令 :</strong></p> <table><thead><tr><th>命令</th> <th>说明</th></tr></thead> <tbody><tr><td>slowlog len</td> <td>查看慢查询日志长度</td></tr> <tr><td>slowlog get num</td> <td>查询第num条慢查询日志</td></tr> <tr><td>slowlog resset</td> <td>清空慢查询列表</td></tr></tbody></table> <p><strong>测试慢查询 :</strong></p> <ol><li>进入 Redis命令终端</li> <li>执行 <code>keys *</code> (一般情况会较慢)</li> <li>查看 慢查询日志列表 <code>slowlog len</code> (第一个肯定是)</li> <li>查看 指定慢查询列表的命令 <code>slowlog get 1</code></li></ol> <div class="language-ini extra-class"><pre class="language-ini"><code>127.0.0.1:6379&gt; slowlog get 1
<span class="token comment"># 日志编号</span>
1) 1) (integer) 1 
	<span class="token comment"># 日志时间戳</span>
   2) (integer) 1680750734
    <span class="token comment"># 慢查询耗时</span>
   3) (integer) 67408
    <span class="token comment"># 慢查询命令</span>
   4) 1) &quot;keys&quot;
   	  2) &quot;*&quot;
   	<span class="token comment"># 执行 IP:Port</span>
   5) &quot;127.0.0.1:39334&quot;
    <span class="token comment"># 客户端名称</span>
   6) &quot;&quot;
</code></pre></div><h4 id="安全配置"><a href="#安全配置" class="header-anchor">#</a> 安全配置</h4> <p><strong>问题 :</strong> Redis绑定在 <code>0.0.0.0:6379</code> , 这样的服务器暴露在公网 , 很有容易出现漏洞!</p> <p>漏洞重现方式 : <a href="https://cloud.tencent.com/developer/article/1039000" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1039000<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block note"><p class="custom-block-title">引起漏洞的主要原因</p> <ul><li>Redis未设置密码</li> <li>利用 Redis的 <code>config set</code>命令 动态修改配置</li> <li>利用 Redis账号权限登录Redis</li></ul></div> <p><strong>安全设施 :</strong></p> <ul><li>Redis设置密码</li> <li>配置 <code>rename-command</code> : 禁止指令 : <code>keys</code>/<code>flushall</code>/<code>flushdb</code>/<code>config set</code>等 命令</li> <li>配置 <code>bind</code> : 限制网卡 , 禁止外网网卡访问</li> <li>服务器 启动防火墙</li> <li>尽可能避免Root启用Redis</li> <li>尽可能不使用默认端口</li></ul> <h4 id="内存配置"><a href="#内存配置" class="header-anchor">#</a> 内存配置</h4> <p><strong>问题 :</strong> 内存利用不当 , 很容易导致内存不足现象 , 可能导致 key误删/响应变长/QPS不稳定 等问题 .</p> <p><strong>快速定位原因 :</strong></p> <ul><li><p><strong>数据内存</strong>
存储了BigKey , 内存碎片</p></li> <li><p><strong>进程内存</strong></p> <p>Redis主进程本身内存 , 一般是忽略不计</p></li> <li><p><strong>缓冲区内存</strong></p> <p>缓冲区/AOF缓冲区/复制缓冲区 等 . 主要源于 客户端连接操作影响的内存波动</p></li></ul> <h3 id="缓存预存储"><a href="#缓存预存储" class="header-anchor">#</a> 缓存预存储</h3> <p>按照不同场景进行提前缓存数据</p> <p><strong>意义 :</strong> 降低服务器压力</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <ul><li>缓存空间不能太大 , 预留其他缓存</li> <li>缓存数据周期 控制失效时间</li></ul></div> <h4 id="定时触发"><a href="#定时触发" class="header-anchor">#</a> 定时触发</h4> <p><strong>场景 :</strong> 定时每天为用户推送列表/</p> <p><strong>方案 :</strong></p> <ol><li>Spring Scheduler (Spring boot 内置)</li> <li>Quartz (独立框架)</li> <li>XXL-Job 分布式任务调度平台 (UI+SDK)</li></ol> <p>推荐学习 : <a href="https://xuxueli.com" target="_blank" rel="noopener noreferrer">XXL-Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="手动触发"><a href="#手动触发" class="header-anchor">#</a> 手动触发</h4> <h3 id="工具类"><a href="#工具类" class="header-anchor">#</a> 工具类</h3> <p>此工具类解决了 : 缓存 击穿/雪崩/穿透 问题 (<a href="#%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98">详细跳转</a></p> <details class="custom-block details"><summary>工具类 展开</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheOperation</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CacheOperation</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * ttl缓存
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> valJson <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> valJson<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 逻辑过期 缓存
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span>
                value<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 防 击穿缓存
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">findWithPassThrough</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> lockKey<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttl<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span> r<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 分布式锁</span>
            <span class="token comment">// 未获取锁重新获取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">findWithPassThrough</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> lockKey<span class="token punctuation">,</span> id<span class="token punctuation">,</span> type<span class="token punctuation">,</span> dbFallback<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 查看锁是否存在</span>
            <span class="token class-name">String</span> lockStr <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lockStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">findWithPassThrough</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> lockKey<span class="token punctuation">,</span> id<span class="token punctuation">,</span> type<span class="token punctuation">,</span> dbFallback<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 查询库</span>
            r <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  逻辑过期缓存
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">findByIdWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> lockKey<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">R</span> r<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 提取数据</span>
        r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expiredTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpiredTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 缓存未过期</span>
        <span class="token comment">// 逻辑过期时间 &gt; 现在时间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expiredTime <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expiredTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token comment">// 获取锁 失败 返回旧数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token comment">// 开启 独立线程 , 实现获取库信息</span>
        <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 库操作前 , 确保信息过期/null</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expiredTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> expiredTime<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">R</span> bean <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 控制逻辑过期时长 . 可选时间单位 (为了方便测试将时间单位设为s)</span>
                    <span class="token class-name">RedisData</span> redisDataTemp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 写入</span>
                    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisDataTemp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 建立锁</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token constant">LOCK_SHOP_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 删除锁</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></details> <h2 id="q-a"><a href="#q-a" class="header-anchor">#</a> Q&amp;A</h2> <h3 id="缓存问题"><a href="#缓存问题" class="header-anchor">#</a> 缓存问题</h3> <p>缓存是在第一次加载的数据进行复用，将数据存放指定地点以便下次加载使用。可防止多访问同一 数据库 而产生的堵塞，也能减轻 数据库 的压力！</p> <p><strong>Java缓存</strong></p> <ul><li>虚拟机缓存（ehcache、JBoss Cache）</li> <li>分布式缓存（redis、memcache）</li> <li>数据库缓存</li></ul> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-04.png" alt=""></p> <h4 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h4> <p>当 Reids宕机/同一时间key失效 , 所导致的大量请求数据库 , 会对数据库造成巨大压力从而宕机</p> <p><strong>解决方案 :</strong></p> <ul><li>为不同key , 设置随机TTL值(控制范围)</li> <li>集群搭建Redis</li> <li>熔断/降级/限流 控制流量</li></ul> <h4 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h4> <p>当用户查询指定数据 , 发现 缓存没有数据 , 且数据库也没有数据 , 如果像这样高频反复去查询 , 数据库必然会绷不住 而宕机 . 这就是透过缓存 , 直接访问数据库 , 该问题如何解决?</p> <p><strong>解决方案 :</strong></p> <p>缓存空对象 , 把在数据库查询的null进行缓存并设置TTL , 那么频繁的访问就不会直接到达数据库的目的
缺点 : 占用一定内存 ; 造成短期数据不一致问题</p> <div class="custom-block note"><p class="custom-block-title">优化</p> <ul><li>对id增强复杂度 , 避免规律id猜测问题</li> <li>对数据进行校验 , 防止不规数据乱入</li> <li>布隆过滤</li></ul></div> <h4 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h4> <p>在某一时间点 突然以超高并发进行访问 即将过期key数据 (热点信息) , 导致 缓存被击穿 . 如同数据库裸奔没有缓存</p> <p><strong>解决方案 :</strong></p> <ul><li><strong>互斥锁</strong> (又称分布式锁)</li> <li><strong>逻辑过期</strong></li></ul> <p><strong>互斥锁</strong> (分布式锁)</p> <p>设置个分布式锁 , 当多个请求同时访问 , 只允许第一个访问的请求 , 那么其他请求将会等待</p> <p>优点 : 节省内存 ; 保证数据一致 ; 实现简单</p> <p>缺点 : 线程等待 , 信息时效性差 ; 死锁风险</p> <details class="custom-block details"><summary>互斥锁代码示例 展开</summary> <p><strong>思路 :</strong> 通过Redis中的 SETNX命令特性实现分布式锁 ! 实现同一时间多个请求只允许一个访问</p> <p><strong>创建分布式锁控制方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 建立锁</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 删除锁</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>逻辑方法 , 加锁约束</strong></p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Bean</span> <span class="token function">findByIdWithLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;sans:test:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
     <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token string">&quot;sans:lock:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
	
     <span class="token class-name">Bean</span> bean<span class="token punctuation">;</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span> beanJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>beanJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>beanJson<span class="token punctuation">,</span> <span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 分布式锁</span>
         <span class="token comment">// 未获取锁重新获取</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token function">findByIdWithLock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// 查看锁是否存在</span>
         <span class="token class-name">String</span> lockStr <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>lockStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">findByIdWithLock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// 查库</span>
         bean <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 缓存</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// 释放锁</span>
         <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><strong>测试 :</strong> 同一时间发多个请求 , 分别测试 开启/关闭 分布式锁 两种情况</p> <ul><li>开启 : 数据库只会查一次</li> <li>关闭 :  数据库可能会插一次以上</li></ul></details> <p><strong>逻辑过期</strong></p> <p>key数据不设置TTL过期时间 , 而是在value中设置过期时间 , 通过检测value进行判断过期时间</p> <p>优点 : 线程无需等待 , 性能好</p> <p>缺点 : 数据不一致(旧数据返回) ; 消耗内存 ; 实现复杂</p> <details class="custom-block details"><summary>流程步骤图 点击展开</summary> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-06.png" alt=""></p></details> <details class="custom-block details"><summary>逻辑过期 代码示例 展开</summary> <p><strong>思路 :</strong> 通过value存过期时间 , 通过过期时间判断是否更新 , 未过期则返回旧数据</p> <p><strong>库查询 缓存存储部分</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveToRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expired<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Bean</span> bean <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 为了更能体现出数据库正在查询数据 , 而营造的延迟</span>
    	<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expired<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写入</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;sans:cache:bean:&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>RedisData对象结构</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expiredTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> expiredTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expiredTime <span class="token operator">=</span> expiredTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>分布式锁</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 建立锁</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 删除锁</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>主业务部分</strong></p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-java"><code><span class="token comment">// 独立线程池</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Bean 实体对象</span>
<span class="token keyword">private</span> <span class="token class-name">Bean</span> <span class="token function">findByIdWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;sans:cache:bean:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token string">&quot;sans:lock:bean:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Bean</span> bean<span class="token punctuation">;</span>

    <span class="token class-name">String</span> beanJson <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;不存在了!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>beanJson<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 提取数据 </span>
    bean <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LocalDateTime</span> expiredTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpiredTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 缓存未过期</span>
    <span class="token comment">// 逻辑过期时间 &gt; 现在时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expiredTime <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expiredTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token comment">// 获取锁 失败 返回旧数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token comment">// 开启 独立线程 , 实现获取库信息</span>
    <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 库操作前 , 确保信息过期/null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expiredTime <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> expiredTime<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveToRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>测试 :</strong></p> <p>以下我设定了逻辑过期时间为10s , 等待到第9s时 , 多次发数据可观察数据变化情况 (主要是步骤的思路 , 不多BB)</p> <p><img src="https://image.bozhu12.cc/myblog/Redis/redis-07.png" alt=""></p></details> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>虽然有些许复杂 , 但是思路非常棒!</p></div> <h3 id="分布式锁问题"><a href="#分布式锁问题" class="header-anchor">#</a> 分布式锁问题</h3> <h4 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h4> <p><strong>Q :</strong> setnx命令 , 未释放资源</p> <p><strong>A :</strong></p> <ul><li>设值过期</li> <li>关闭锁</li></ul> <h4 id="jvm锁和分布式锁"><a href="#jvm锁和分布式锁" class="header-anchor">#</a> JVM锁和分布式锁</h4> <table><thead><tr><th></th> <th>JVM锁</th> <th>分布式锁</th></tr></thead> <tbody><tr><td><strong>锁范围</strong></td> <td>JVM中的多线程</td> <td>多个JVM</td></tr> <tr><td><strong>实现于</strong></td> <td>Java</td> <td>Redis/MySQL/Zookeeper/等</td></tr></tbody></table> <p>JVM应用的范围过于局限 , 因此需要分布式扩大锁的范围</p> <h4 id="续约锁-2"><a href="#续约锁-2" class="header-anchor">#</a> 续约锁</h4> <p><strong>Q :</strong> 如果锁所执行的方法时间过长 , 锁提前过期 , 导致他人占用?</p> <p><strong>A :</strong>  续约锁的时长进行加时</p> <blockquote><p>续约锁的目的主要是防止锁长时间占用问题 , 达到节省资源</p></blockquote> <p><strong>Q2 :</strong> 释放锁的时候 , 先前判断出是自己的锁 , 由于执行时间过长导致期间锁过期了 , 此时被其他节点所占用 , 因此方法很有可能会将别的节点锁进行释放! (以下伪代码示例)</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 此时判断为A锁含有过期</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>get lock <span class="token operator">==</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 执行过程....(漫长</span>
    del lock<span class="token punctuation">;</span> <span class="token comment">// 释放锁(此时锁可能不为A)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>A2 :</strong> Redis + lua脚本 实现</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93" title="标签">#数据库</a><a href="/tags/?tag=Redis" title="标签">#Redis</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/12, 00:43:49</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/backend/zi2hq0/" class="prev">Mybatis</a></span> <span class="next"><a href="/backend/redis2/">Redis原理篇</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/web/sass1992/"><div>
            Sass
            <!----></div></a> <span class="date">04-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/backend/redis2/"><div>
            Redis原理篇
            <!----></div></a> <span class="date">04-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/other/ceats1/"><div>
            Canal
            <!----></div></a> <span class="date">04-05</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="Sanscan12" title="联系" target="_blank" class="iconfont icon-weixin"></a><a href="https://github.com/Sanscan12" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/user/home?id=448156561" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2023
    <span> | <a href="https://beian.miit.gov.cn/">桂ICP备2022009417号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.cd15dec3.js" defer></script><script src="/assets/js/2.b26d2d6f.js" defer></script><script src="/assets/js/57.87341998.js" defer></script>
  </body>
</html>
